<!doctype html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom Yossarun - Complete Edition</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Kanit', sans-serif; background: #f1f5f9; color: #1e293b; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .glass { background: white; border-radius: 1.25rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        #reader { width: 100% !important; max-width: 380px; margin: 0 auto; border-radius: 1rem; overflow: hidden; border: 4px solid white; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .status-present { background: #dcfce7; color: #166534; }
        .status-late { background: #ffedd5; color: #9a3412; }
        .status-absent { background: #f1f5f9; color: #64748b; }
        @media print { .no-print { display: none; } .print-area { display: block !important; } }
        th, td { border: 1px solid #e2e8f0; padding: 12px; }
    </style>
</head>
<body>

    <nav class="bg-white/80 backdrop-blur-md sticky top-0 z-[100] border-b p-4 flex justify-between items-center no-print">
        <h1 class="text-xl font-bold tracking-tight text-slate-800">CLASSROOM <span class="text-indigo-600">Yossarun</span></h1>
        <div class="flex gap-2">
            <button onclick="location.reload()" class="p-2 bg-slate-100 rounded-lg">üîÑ</button>
            <button onclick="authAdmin()" class="bg-slate-900 text-white px-5 py-2 rounded-xl text-xs font-semibold uppercase hover:bg-indigo-600 transition-all">Teacher Mode</button>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto p-4 md:p-6 no-print">

        <section id="page-home" class="page active">
            <div class="max-w-md mx-auto mt-16 glass p-10 text-center border-t-8 border-indigo-600">
                <div class="text-6xl mb-6">üéí</div>
                <h2 class="text-3xl font-bold mb-2 text-slate-800">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                <p class="text-slate-400 mb-8">‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                <input type="text" id="std-login-id" class="w-full p-5 bg-slate-50 border-2 rounded-2xl mb-4 text-center text-4xl font-bold focus:ring-4 focus:ring-indigo-100 outline-none border-slate-200 transition-all" placeholder="00000">
                <button onclick="handleStudentLogin()" class="w-full py-5 bg-indigo-600 text-white rounded-2xl text-xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-all">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </section>

        <section id="page-admin-menu" class="page">
            <h2 class="text-2xl font-bold mb-8 flex items-center gap-3"><span class="w-2 h-8 bg-indigo-600 rounded-full"></span> ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <button onclick="showPage('admin-teach')" class="glass p-8 bg-indigo-600 text-white text-lg font-bold hover:scale-105 transition-transform shadow-indigo-200 shadow-lg">üìç ‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</button>
                <button onclick="showPage('admin-monitor')" class="glass p-8 bg-emerald-600 text-white text-lg font-bold hover:scale-105 transition-transform shadow-emerald-200 shadow-lg">üñ•Ô∏è ‡∏à‡∏≠‡∏°‡∏≠‡∏ô‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå</button>
                <button onclick="showPage('admin-stats')" class="glass p-8 bg-sky-500 text-white text-lg font-bold hover:scale-105 transition-transform shadow-sky-200 shadow-lg">üìà ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                <button onclick="showPage('admin-tracking')" class="glass p-8 bg-rose-500 text-white text-lg font-bold hover:scale-105 transition-transform shadow-rose-200 shadow-lg">üìã ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô</button>
                <button onclick="showPage('admin-score')" class="glass p-8 bg-violet-600 text-white text-lg font-bold">üìä ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
                <button onclick="showPage('admin-qr-print-tool')" class="glass p-8 bg-white text-slate-700 text-lg font-bold border-2">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå QR Code</button>
                <button onclick="showPage('admin-donow')" class="glass p-8 bg-amber-400 text-white text-lg font-bold">‚ö° ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° Do Now</button>
                <button onclick="showPage('admin-master')" class="glass p-8 bg-slate-800 text-white text-lg font-bold italic">üíæ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
            </div>
        </section>

        <section id="page-admin-teach" class="page">
            <button onclick="showPage('admin-menu')" class="mb-4 font-bold text-slate-400">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π</button>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="glass p-6">
                    <h3 class="text-lg font-bold mb-4 text-indigo-600 underline">1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                    <div class="space-y-3">
                        <select id="t-grade" onchange="updateSubFilter(this.value, 't-sub')" class="w-full p-4 border rounded-xl"></select>
                        <select id="t-sub" class="w-full p-4 border rounded-xl"></select>
                        <input type="date" id="t-date" class="w-full p-4 border rounded-xl">
                        <div class="grid grid-cols-2 gap-2">
                            <input type="time" id="t-start" class="p-4 border rounded-xl" placeholder="‡πÄ‡∏£‡∏¥‡πà‡∏°">
                            <input type="time" id="t-end" class="p-4 border rounded-xl" placeholder="‡∏à‡∏ö">
                        </div>
                        <button onclick="createSession()" class="w-full py-4 bg-indigo-600 text-white rounded-xl font-bold text-lg">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö Global Sync</button>
                    </div>
                </div>
                <div class="lg:col-span-2 glass p-10 text-center">
                    <div id="ses-label" class="mb-6 text-xl font-bold text-slate-400 italic">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏•‡∏∞‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô...</div>
                    <div id="reader"></div>
                    <div class="flex gap-4 mt-8 max-w-sm mx-auto">
                        <button id="btn-on" onclick="toggleScanner(true)" class="flex-1 py-4 bg-slate-900 text-white rounded-2xl font-bold shadow-lg">‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
                        <button id="btn-off" onclick="toggleScanner(false)" class="flex-1 py-4 bg-slate-200 text-slate-500 rounded-2xl font-bold" disabled>‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="page-admin-monitor" class="page">
            <button onclick="showPage('admin-menu')" class="mb-4 font-bold text-slate-400">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π</button>
            <div class="glass p-6 mb-6 flex flex-wrap justify-between items-center border-l-[12px] border-emerald-500">
                <div>
                    <h2 id="mon-sub-title" class="text-3xl font-bold text-indigo-600">‡∏ß‡∏¥‡∏ä‡∏≤: -</h2>
                    <p id="mon-ses-info" class="text-slate-400 font-medium"></p>
                </div>
                <div class="flex gap-4">
                    <div class="bg-emerald-50 p-4 rounded-2xl text-center min-w-[100px]">
                        <div class="text-xs font-bold text-emerald-600 uppercase">‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
                        <div id="mon-count-present" class="text-3xl font-bold text-emerald-700">0</div>
                    </div>
                    <div class="bg-orange-50 p-4 rounded-2xl text-center min-w-[100px]">
                        <div class="text-xs font-bold text-orange-600 uppercase">‡∏°‡∏≤‡∏™‡∏≤‡∏¢</div>
                        <div id="mon-count-late" class="text-3xl font-bold text-orange-700">0</div>
                    </div>
                    <div class="bg-slate-100 p-4 rounded-2xl text-center min-w-[100px]">
                        <div class="text-xs font-bold text-slate-500 uppercase">‡∏Ç‡∏≤‡∏î</div>
                        <div id="mon-count-absent" class="text-3xl font-bold text-slate-600">0</div>
                    </div>
                </div>
            </div>
            <div id="monitor-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-4"></div>
        </section>

        <section id="page-admin-score" class="page">
            <button onclick="showPage('admin-menu')" class="mb-4 font-bold text-slate-400">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
            <div class="glass p-8">
                <h2 class="text-2xl font-bold mb-6">üìä ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (Excel Upload)</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <select id="sc-grade" onchange="updateSubFilter(this.value, 'sc-sub')" class="p-4 border rounded-2xl font-medium"></select>
                    <select id="sc-sub" class="p-4 border rounded-2xl font-medium"></select>
                    <input type="text" id="sc-tasks" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏≠‡∏ö‡∏¢‡πà‡∏≠‡∏¢1, ‡∏™‡∏≠‡∏ö‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ)" class="p-4 border rounded-2xl">
                </div>
                <div class="flex gap-4">
                    <button onclick="downloadScoreTpl()" class="flex-1 py-5 bg-slate-100 text-slate-600 rounded-2xl font-bold hover:bg-slate-200">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Template</button>
                    <button onclick="document.getElementById('sc-upload-in').click()" class="flex-1 py-5 bg-violet-600 text-white rounded-2xl font-bold hover:bg-violet-700 shadow-lg shadow-violet-200">üì§ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏≤‡∏Å Excel</button>
                    <input type="file" id="sc-upload-in" class="hidden" onchange="uploadScoreData(event)">
                </div>
            </div>
        </section>

        <section id="page-admin-stats" class="page">
            <button onclick="showPage('admin-menu')" class="mb-4 font-bold text-slate-400">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
            <div class="glass p-8 mb-6">
                <h2 class="text-2xl font-bold mb-6">üìà ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•/‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞)</h2>
                <div class="flex flex-wrap gap-4">
                    <select id="st-grade" onchange="updateSubFilter(this.value, 'st-sub')" class="p-4 border rounded-2xl flex-1"></select>
                    <select id="st-sub" class="p-4 border rounded-2xl flex-1"></select>
                    <button onclick="generateStatsReport()" class="px-10 py-4 bg-indigo-600 text-white rounded-2xl font-bold">‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•</button>
                    <button onclick="showSessionEditor()" class="px-6 py-4 bg-indigo-600 text-white rounded-2xl font-bold hover:bg-indigo-700 transition-all ml-2">üîç ‡∏î‡∏π/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏£‡∏≤‡∏¢‡∏Ñ‡∏≤‡∏ö</button>
                    <button onclick="resetAttendance()" class="px-10 py-4 bg-rose-600 text-white rounded-2xl font-bold hover:bg-rose-700 transition-all"> ‚ö†Ô∏è ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    <button onclick="exportStatsCSV()" class="px-10 py-4 bg-emerald-600 text-white rounded-2xl font-bold">Export CSV</button>
                </div>
            </div>
            <div id="stats-area" class="hidden">
                <div id="stats-summary-cards" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"></div>
                <div class="glass overflow-hidden">
                    <table class="w-full text-sm">
                        <thead class="bg-slate-800 text-white">
                            <tr><th>‡∏ó‡∏µ‡πà</th><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th class="bg-emerald-600">‡∏°‡∏≤</th><th class="bg-orange-500">‡∏™‡∏≤‡∏¢</th><th class="bg-rose-600">‡∏Ç‡∏≤‡∏î</th><th>‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞</th></tr>
                        </thead>
                        <tbody id="stats-table-body" class="bg-white"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="page-admin-tracking" class="page">
            <button onclick="showPage('admin-menu')" class="mb-4 font-bold text-slate-400">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
            <div class="glass p-8">
                <h2 class="text-2xl font-bold mb-6 italic text-rose-600 underline">üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á (Real-time)</h2>
                <div class="flex gap-4 mb-6">
                    <select id="tr-grade" onchange="updateSubFilter(this.value, 'tr-sub')" class="p-4 border rounded-2xl flex-1"></select>
                    <select id="tr-sub" class="p-4 border rounded-2xl flex-1"></select>
                    <button onclick="loadTrackingReport()" class="px-12 bg-indigo-600 text-white rounded-2xl font-bold">‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </div>
                <div class="overflow-x-auto glass">
                    <table class="w-full text-xs">
                        <thead id="tr-head" class="bg-slate-900 text-white"></thead>
                        <tbody id="tr-body"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="page-admin-master" class="page">
            <button onclick="showPage('admin-menu')" class="mb-4 font-bold text-slate-400">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="glass p-8 border-t-8 border-slate-800">
                    <h3 class="text-xl font-bold mb-4">üíæ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                    <input type="file" onchange="loadExcel(event)" class="w-full p-6 border-2 border-dashed rounded-2xl mb-4 bg-slate-50">
                    <div id="map-ui" class="hidden bg-white p-6 border rounded-2xl space-y-4">
    <p class="text-xs font-bold text-slate-400 uppercase">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (5 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏´‡∏•‡∏±‡∏Å)</p>
    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
        <div>‡∏£‡∏´‡∏±‡∏™: <select id="m-id" class="w-full p-2 border rounded"></select></div>
        <div>‡∏ä‡∏∑‡πà‡∏≠: <select id="m-name" class="w-full p-2 border rounded"></select></div>
        <div>‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•: <select id="m-surname" class="w-full p-2 border rounded"></select></div>
        <div>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô: <select id="m-nickname" class="w-full p-2 border rounded"></select></div>
        <div>‡∏´‡πâ‡∏≠‡∏á: <select id="m-grade" class="w-full p-2 border rounded"></select></div>
    </div>
    <p class="text-[10px] text-indigo-500">* ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏à‡∏≤‡∏Å‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
    <button onclick="saveMasterData()" class="w-full py-4 bg-indigo-600 text-white rounded-xl font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
</div>
                </div>
                <div class="glass p-8 bg-slate-900 text-white text-center">
                    <h3 class="text-xl font-bold mb-4 text-indigo-400">üì∏ Sync ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                    <input type="file" id="photo-input" multiple accept="image/*" class="hidden" onchange="handlePhotoUpload(event)">
                    <div onclick="document.getElementById('photo-input').click()" class="cursor-pointer py-16 border-2 border-dashed border-slate-700 rounded-3xl hover:border-indigo-500 transition-all opacity-60 hover:opacity-100">
                        <div class="text-5xl mb-4">üñºÔ∏è</div>
                        <p class="font-bold text-lg">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</p>
                        <p class="text-xs text-slate-500 mt-2">‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô.jpg (‡πÄ‡∏ä‡πà‡∏ô 1001.jpg)</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="page-admin-qr-print-tool" class="page">
            <button onclick="showPage('admin-menu')" class="mb-4 font-bold text-slate-400">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
            <div class="glass p-10 text-center">
                <h2 class="text-3xl font-bold mb-8">üñ®Ô∏è ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå QR Code</h2>
                <div class="flex gap-4 justify-center mb-10">
                    <select id="qr-grade-sel" class="p-4 border rounded-2xl min-w-[250px] font-bold"></select>
                    <button onclick="previewQR()" class="px-10 bg-indigo-600 text-white rounded-2xl font-bold shadow-lg shadow-indigo-100">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡πÅ‡∏Å‡∏ô</button>
                </div>
                <div id="qr-preview-box" class="hidden">
                    <button onclick="window.print()" class="w-full py-6 bg-emerald-500 text-white rounded-3xl font-bold text-2xl mb-10 hover:bg-emerald-600 transition-all">üñ®Ô∏è ‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå (A4)</button>
                    <div id="preview-grid" class="grid grid-cols-4 md:grid-cols-6 gap-4 p-6 bg-white border-2 border-slate-100 rounded-3xl"></div>
                </div>
            </div>
        </section>

        <section id="page-admin-donow" class="page">
            <button onclick="showPage('admin-menu')" class="mb-4 font-bold text-slate-400">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
            <div class="max-w-xl mx-auto glass p-10 border-t-[12px] border-amber-400">
                <h2 class="text-3xl font-bold mb-2">‚ö° ‡∏£‡∏∞‡∏ö‡∏ö Do Now</h2>
                <p class="text-slate-400 mb-8 font-medium">‡∏™‡πà‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏î‡πà‡∏ß‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
                <div class="space-y-4">
                    <select id="dn-grade" onchange="updateSubFilter(this.value, 'dn-sub')" class="w-full p-4 border rounded-2xl"></select>
                    <select id="dn-sub" class="w-full p-4 border rounded-2xl"></select>
                    <textarea id="dn-msg" class="w-full p-6 border-2 rounded-3xl text-lg font-medium h-40" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÇ‡∏à‡∏ó‡∏¢‡πå ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
                    <div class="flex gap-4">
                        <button onclick="saveDoNow(true)" class="flex-1 py-5 bg-emerald-500 text-white rounded-2xl font-bold text-xl hover:bg-emerald-600 transition-all">‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</button>
                        <button onclick="saveDoNow(false)" class="flex-1 py-5 bg-rose-500 text-white rounded-2xl font-bold text-xl hover:bg-rose-600 transition-all">‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö</button>
                        <button onclick="viewDoNowAnswers()" 
                        class="p-4 bg-amber-500 text-white rounded-2xl font-bold shadow-lg hover:bg-amber-600 transition-all flex flex-col items-center gap-2">
                        <span class="text-2xl">‚ö°</<span>‡∏î‡∏π‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö Do Now</span>
                    </button>
                    </div>
                    <div class="mt-10 glass p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold">‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                        <button onclick="db.ref('donow_answers').remove()" class="text-xs text-rose-500 underline">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                    </div>
                    <div id="dn-admin-monitor" class="space-y-2 max-h-60 overflow-y-auto"></div>
                </div>
                </div>
            </div>
        </section>

        <section id="page-std-dashboard" class="page">
            <button onclick="showPage('home')" class="mb-4 font-bold text-slate-400">‚Üê ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            <div class="glass p-8 flex items-center gap-8 mb-8 border-l-[15px] border-indigo-600">
                <img id="std-img" class="w-24 h-24 rounded-3xl object-cover border-4 border-white shadow-xl">
                <div><h2 id="std-name-txt" class="text-4xl font-bold text-slate-800"></h2><p id="std-grade-txt" class="text-indigo-600 text-xl font-bold"></p></div>
            </div>
            <div id="std-subject-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </section>

        <section id="page-std-subject-menu" class="page">
            <button onclick="showPage('std-dashboard')" class="mb-4 font-bold text-slate-400">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
            <h2 id="std-menu-sub-title" class="text-4xl font-bold mb-10 italic text-indigo-700"></h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <button onclick="showStdDoNow()" class="glass p-12 bg-amber-400 text-white text-2xl font-bold hover:scale-105 transition-transform shadow-xl shadow-amber-100">‚ö° DO NOW</button>
                <button onclick="showStdScores()" class="glass p-12 bg-indigo-600 text-white text-2xl font-bold hover:scale-105 transition-transform shadow-xl shadow-indigo-100">üèÜ SCORES</button>
                <button onclick="showStdPending()" class="glass p-12 bg-rose-500 text-white text-2xl font-bold hover:scale-105 transition-transform shadow-xl shadow-rose-100">üìã PENDING</button>
            </div>
        </section>

        <section id="page-std-content-view" class="page">
    <button onclick="showPage('std-subject-menu')" class="mb-4 font-bold text-slate-400">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
    <div class="glass p-12 border-t-[20px] border-amber-400">
        <h2 id="content-title" class="text-4xl font-bold mb-10 italic text-amber-600"></h2>
        <div id="content-area" class="text-2xl mb-6"></div>

        <div id="dn-wrapper" style="display: none;"> 
            <div id="dn-timer" class="text-center text-5xl font-black text-rose-600 mb-4">180</div>
            <textarea id="std-dn-answer" 
                class="w-full p-4 border-2 border-amber-200 rounded-2xl text-xl bg-white shadow-inner" 
                rows="4" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
            <button id="btn-dn-submit" onclick="submitDoNowAnswer()" disabled 
                class="w-full py-4 bg-slate-400 text-white rounded-2xl font-bold text-xl transition-all shadow-lg mt-4">
                ‡∏£‡∏≠‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö (180)
            </button>
        </div>
    </div>
</section>
        

    </main>

    <div id="print-layout" class="hidden print-area">
        <div id="qr-print-grid" class="grid grid-cols-4 gap-4 p-8"></div>
    </div>

    <script>
        // --- 1. FIREBASE & STATE ---
        const config = { apiKey: "AIzaSyAJhpfPS7TCe3N1n6oWpFsWVQ7ipocv4kg", authDomain: "classroom-9813f.firebaseapp.com", databaseURL: "https://classroom-9813f-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "classroom-9813f" };
        firebase.initializeApp(config);
        const db = firebase.database();
        let students = [], currentSid = null, currentSub = null, currentSes = null, html5Qr = null, rawXL = null;

        db.ref('students').on('value', snap => { students = snap.val() ? Object.values(snap.val()) : []; updateSelectMenus(); });

        function showPage(p) {
            document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
            document.getElementById(`page-${p}`).classList.add('active');
            if(p === 'admin-monitor') startGlobalMonitor();
        }

        async function authAdmin() {
            const { value: pw } = await Swal.fire({ title: 'Teacher Security', input: 'password', confirmButtonColor: '#4f46e5' });
            if (pw === "1234") showPage('admin-menu');
        }

        // --- 2. MASTER DATA & PHOTOS ---
        function loadExcel(e) {
    const r = new FileReader(); 
    r.readAsBinaryString(e.target.files[0]);
    r.onload = (evt) => {
        const wb = XLSX.read(evt.target.result, { type: 'binary' });
        rawXL = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        const heads = Object.keys(rawXL[0]);
        document.getElementById('map-ui').classList.remove('hidden');
        
        // ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ ID ‡∏Ç‡∏≠‡∏á select ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á Excel ‡∏•‡∏á‡πÑ‡∏õ
        const selectors = ['m-id','m-name','m-surname','m-nickname','m-grade'];
        selectors.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.innerHTML = heads.map(h => `<option value="${h}">${h}</option>`).join('');
        });
    };
}

        async function saveMasterData() {
    // 1. ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Dropdown
    const cI = document.getElementById('m-id').value;
    const cN = document.getElementById('m-name').value;
    const cS = document.getElementById('m-surname').value;
    const cNk = document.getElementById('m-nickname').value;
    const cG = document.getElementById('m-grade').value;

    const data = rawXL.map(row => {
        const id = row[cI]?.toString().trim(); 
        if(!id) return null;

        // 2. ‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡∏ä‡∏≤ (‡πÄ‡∏≠‡∏≤‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà 5 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏´‡∏•‡∏±‡∏Å ‡πÅ‡∏•‡∏∞ ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà/‡∏•‡∏≥‡∏î‡∏±‡∏ö)
        const subs = {}; 
        const mainKeys = [cI, cN, cS, cNk, cG, "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà", "‡∏•‡∏≥‡∏î‡∏±‡∏ö"];
        
        Object.keys(row).forEach(k => {
            if (!mainKeys.includes(k)) {
                subs[k] = row[k] || ""; // ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤
            }
        });

        return { 
            id: id, 
            name: `${row[cN]} ${row[cS]}`, // ‡∏£‡∏ß‡∏°‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢‡πÜ
            firstName: row[cN],
            lastName: row[cS],
            nickname: row[cNk],
            grade: row[cG]?.toString(), 
            subjects: subs, 
            photo: ""
        };
    }).filter(d => d);

    // 3. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firebase
    try {
        await db.ref('students').set(data); 
        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 5 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
    } catch (error) {
        Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
    }
}

        async function handlePhotoUpload(e) {
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û...', didOpen: () => Swal.showLoading() });
            for(let f of Array.from(e.target.files)) {
                const sid = f.name.split('.')[0].trim();
                const idx = students.findIndex(s => s.id === sid);
                if(idx !== -1) students[idx].photo = await resizeImg(f);
            }
            await db.ref('students').set(students); Swal.close(); Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }

        function resizeImg(f) {
            return new Promise(r => {
                const rd = new FileReader(); rd.readAsDataURL(f);
                rd.onload = (e) => {
                    const i = new Image(); i.src = e.target.result;
                    i.onload = () => {
                        const c = document.createElement('canvas'); c.width = 300; c.height = (i.height*300)/i.width;
                        c.getContext('2d').drawImage(i,0,0,300,c.height); r(c.toDataURL('image/jpeg', 0.8));
                    }
                }
            });
        }

        // --- 3. TEACH & SCANNER ---
        function createSession() {
            const gr = document.getElementById('t-grade').value, sub = document.getElementById('t-sub').value, dt = document.getElementById('t-date').value;
            if(!gr || !sub || !dt) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö');
            const id = Date.now();
            const data = { id, grade: gr, subject: sub, date: dt, start: document.getElementById('t-start').value, end: document.getElementById('t-end').value, fullDate: new Date(dt).toLocaleDateString('th-TH', { dateStyle: 'long' }) };
            db.ref(`sessions/${id}`).set(data); db.ref(`global/activeSessionID`).set(id);
            currentSes = data; document.getElementById('ses-label').innerHTML = `üî¥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô: <span class="text-indigo-600 font-black underline">${sub} [‡∏´‡πâ‡∏≠‡∏á ${gr}]</span>`;
        }

        async function toggleScanner(on) {
    if(!currentSes) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° [‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö Global Sync] ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πÅ‡∏Å‡∏ô', 'warning');
    
    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Path ‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤
    const cleanGr = currentSes.grade.replace(/[.#$[\]]/g, "_");
    const cleanSub = currentSes.subject.replace(/[.#$[\]]/g, "_");
    const aid = currentSes.id;

    if(on) {
        // ‡∏•‡πâ‡∏≤‡∏á Instance ‡πÄ‡∏Å‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà
        if(html5Qr) { try { await html5Qr.clear(); } catch(e) {} }
        
        html5Qr = new Html5Qrcode("reader");
        document.getElementById('btn-on').disabled = true; 
        document.getElementById('btn-off').disabled = false;
        
        // config ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏Å‡∏±‡∏ö Samsung (‡πÄ‡∏û‡∏¥‡πà‡∏° focusMode)
        const config = { 
            fps: 20, 
            qrbox: { width: 250, height: 250 }, 
            aspectRatio: 1.0,
            videoConstraints: { focusMode: "continuous" } 
        };

        html5Qr.start({ facingMode: "environment" }, config, async (code) => {
            // --- [1] ‡∏´‡∏¢‡∏∏‡∏î‡∏™‡πÅ‡∏Å‡∏ô‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≠ QR ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏†‡∏≤‡∏£‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ---
            html5Qr.pause(true); 

            const sid = code.trim(); 
            const std = students.find(s => String(s.id) === sid);
            
            // --- [2] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
            if(!std) {
                if(window.soundError) soundError.play();
                await Swal.fire({ title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™!', icon: 'error', timer: 1500, showConfirmButton: false });
                html5Qr.resume(); // ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏™‡πÅ‡∏Å‡∏ô‡∏ï‡πà‡∏≠
                return;
            }

            if(std.grade !== currentSes.grade) {
                if(window.soundError) soundError.play();
                await Swal.fire({ 
                    title: '‡∏ú‡∏¥‡∏î‡∏´‡πâ‡∏≠‡∏á!', 
                    text: `${std.name} ‡∏≠‡∏¢‡∏π‡πà‡∏´‡πâ‡∏≠‡∏á ${std.grade}`, 
                    icon: 'warning', 
                    timer: 1500, 
                    showConfirmButton: false 
                });
                html5Qr.resume();
                return;
            }

            // --- [3] ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firebase ---
            const now = new Date(); 
            const timeStr = now.toLocaleTimeString('th-TH', { hour:'2-digit', minute:'2-digit' });
            const [sH, sM] = currentSes.start.split(':'); 
            const startTime = new Date(currentSes.date); 
            startTime.setHours(parseInt(sH), parseInt(sM), 0);
            const status = ((now - startTime) / 60000) > 15 ? "‡∏™‡∏≤‡∏¢" : "‡∏°‡∏≤";
            
            try {
                await db.ref(`attendance/${cleanGr}/${cleanSub}/${aid}/${std.id}`).set({ 
                    name: std.name, 
                    time: timeStr, 
                    status: status 
                });

                // --- [4] ‡πÅ‡∏™‡∏î‡∏á Pop-up ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô) ---
                if(window.soundSuccess) soundSuccess.play();
                
                await Swal.fire({
                    title: `<span class="${status === '‡∏°‡∏≤' ? 'text-emerald-600' : 'text-amber-500'} font-black text-3xl">${status === "‡∏°‡∏≤" ? "‚úÖ ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" : "‚è≥ ‡∏°‡∏≤‡∏™‡∏≤‡∏¢"}</span>`,
                    html: `
                        <div class="flex flex-col items-center mt-2">
                            <img src="${std.photo || `https://api.dicebear.com/7.x/initials/svg?seed=${std.id}`}" 
                                 class="w-56 h-56 rounded-[2.5rem] object-cover border-8 border-white shadow-2xl mb-4">
                            <div class="text-4xl font-black text-slate-800">${std.name}</div>
                            <div class="text-xl font-bold text-slate-400 mt-1">‡πÄ‡∏ß‡∏•‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ${timeStr}</div>
                        </div>`,
                    timer: 2000,
                    timerProgressBar: true,
                    showConfirmButton: false,
                    backdrop: `rgba(0,0,0,0.4)`
                });

            } catch (err) {
                console.error("Save Error:", err);
            }

            // --- [5] ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Pop-up ‡∏´‡∏≤‡∏¢‡πÑ‡∏õ ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡∏Ñ‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ ---
            html5Qr.resume();

        }).catch(err => {
            console.error("Camera Error:", err);
            Swal.fire('‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á', '‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏ä‡πâ Chrome/Samsung Internet ‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏•‡πâ‡∏≠‡∏á (HTTPS)', 'error');
            document.getElementById('btn-on').disabled = false;
        });
    } else { 
        if(html5Qr) {
            html5Qr.stop().then(() => { 
                document.getElementById('btn-on').disabled = false; 
                document.getElementById('btn-off').disabled = true; 
            }).catch(e => console.error("Stop Error:", e));
        }
    }
}

// --- 2. ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏à‡∏≠‡∏°‡∏≠‡∏ô‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå (Monitor Pop-up) ---
function startGlobalMonitor() {
    db.ref(`global/activeSessionID`).on('value', snap => {
        const aid = snap.val(); if(!aid) return;
        
        db.ref(`sessions/${aid}`).once('value', sSnap => {
            const ses = sSnap.val(); if(!ses) return;

            const cleanGr = ses.grade.replace(/[.#$[\]]/g, "_");
            const cleanSub = ses.subject.replace(/[.#$[\]]/g, "_");

            // ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡∏ö Real-time
            db.ref(`attendance/${cleanGr}/${cleanSub}/${aid}`).on('value', aSnap => {
                const att = aSnap.val() || {};
                const room = students.filter(s => s.grade === ses.grade).sort((a,b) => a.id - b.id);
                
                let p=0, l=0, a=0, html="";
                room.forEach(s => {
                    const d = att[s.id];
                    let cls = "bg-rose-50 text-rose-600 border-rose-100", stTxt = "‡∏Ç‡∏≤‡∏î", tTxt = "-";
                    if(d) {
                        if(d.status === "‡∏™‡∏≤‡∏¢") { cls="bg-amber-50 text-amber-800"; stTxt="‡∏™‡∏≤‡∏¢"; l++; }
                        else { cls="bg-emerald-50 text-emerald-800"; stTxt="‡∏°‡∏≤"; p++; }
                        tTxt = d.time;
                    } else a++;

                    html += `
                        <div class="flex items-center p-3 rounded-2xl border ${cls}">
                            <img src="${s.photo || `https://api.dicebear.com/7.x/initials/svg?seed=${s.id}`}" class="w-16 h-16 rounded-xl mr-4 object-cover">
                            <div><div class="font-black text-lg">${s.name}</div><div class="text-xs">${stTxt} ${tTxt}</div></div>
                        </div>`;
                });
                document.getElementById('monitor-grid').innerHTML = html;
            });

            // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ Pop-up ‡πÄ‡∏î‡πâ‡∏á‡∏ö‡∏ô‡∏à‡∏≠‡∏°‡∏≠‡∏ô‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏ç‡πà ---
            db.ref(`attendance/${cleanGr}/${cleanSub}/${aid}`).limitToLast(1).on('child_added', (snapshot) => {
                const studentId = snapshot.key;
                const data = snapshot.val();
                const std = students.find(x => x.id === studentId);
                
                if (std && data) {
                    Swal.fire({
                        title: `<div class="text-4xl font-black text-emerald-600">‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>`,
                        html: `
                            <div class="p-4">
                                <img src="${std.photo || `https://api.dicebear.com/7.x/initials/svg?seed=${std.id}`}" class="w-64 h-64 mx-auto rounded-[3rem] object-cover border-8 border-white shadow-2xl mb-6">
                                <div class="text-5xl font-black mb-2">${std.name}</div>
                                <div class="text-2xl text-slate-500 font-bold">‡πÄ‡∏ß‡∏•‡∏≤: ${data.time}</div>
                            </div>`,
                        timer: 2500,
                        showConfirmButton: false,
                        backdrop: `rgba(0,123,255,0.2)`
                    });
                }
            });
        });
    });
}

        // --- 4. LIVE MONITOR ---
        function startGlobalMonitor() {
        db.ref(`global/activeSessionID`).on('value', snap => {
        const aid = snap.val(); 
        if(!aid) {
            document.getElementById('mon-sub-title').innerText = "‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...";
            return;
        }
        
        db.ref(`sessions/${aid}`).once('value', sSnap => {
            const ses = sSnap.val();
            if(!ses) return;

            document.getElementById('mon-sub-title').innerText = "‡∏ß‡∏¥‡∏ä‡∏≤: " + ses.subject;
            document.getElementById('mon-ses-info').innerText = `‡∏´‡πâ‡∏≠‡∏á ${ses.grade} | ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${ses.fullDate || ses.date}`;

            const cleanGr = ses.grade.replace(/[.#$[\]]/g, "_");
            const cleanSub = ses.subject.replace(/[.#$[\]]/g, "_");

            db.ref(`attendance/${cleanGr}/${cleanSub}/${aid}`).on('value', aSnap => {
                const att = aSnap.val() || {};
                const room = students.filter(s => s.grade === ses.grade).sort((a,b) => (a.id || 0) - (b.id || 0));
                
                let p=0, l=0, a=0, html="";

                room.forEach(s => {
                    const d = att[s.id];
                    let cls = "bg-rose-50 border-rose-200 text-rose-700"; // ‡∏Ç‡∏≤‡∏î
                    let statusTxt = "‚ùå ‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô";
                    let timeTxt = "--:--";
                    
                    if(d) {
                        if(d.status === "‡∏™‡∏≤‡∏¢") {
                            cls = "bg-amber-50 border-amber-300 text-amber-800";
                            statusTxt = "‚è≥ ‡∏°‡∏≤‡∏™‡∏≤‡∏¢";
                            l++;
                        } else {
                            cls = "bg-emerald-50 border-emerald-300 text-emerald-800";
                            statusTxt = "‚úÖ ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô";
                            p++;
                        }
                        timeTxt = d.time || "";
                    } else { a++; }

                    // --- ‡∏õ‡∏£‡∏±‡∏ö UI ‡πÄ‡∏õ‡πá‡∏ô 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (‡∏£‡∏π‡∏õ‡∏ã‡πâ‡∏≤‡∏¢ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏ß‡∏≤) ---
                    html += `
                        <div class="flex items-center p-4 rounded-3xl border-2 shadow-sm transition-all ${cls}">
                            <div class="flex-shrink-0 mr-6">
                                <img src="${s.photo || `https://api.dicebear.com/7.x/initials/svg?seed=${s.id}`}" 
                                     class="w-32 h-32 rounded-2xl object-cover border-4 border-white shadow-md">
                            </div>
                            
                            <div class="flex-grow overflow-hidden">
                                <div class="text-3xl font-black truncate">${s.name}</div>
                                <div class="text-xl font-bold opacity-70 mb-2">ID: ${s.id}</div>
                                <div class="inline-flex items-center px-4 py-1 rounded-full bg-white bg-opacity-60">
                                    <span class="text-2xl font-black uppercase">${statusTxt}</span>
                                    <span class="ml-3 text-lg font-bold opacity-80">${timeTxt}</span>
                                </div>
                            </div>
                        </div>`;
                });

                // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Grid ‡πÄ‡∏õ‡πá‡∏ô 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (‡∏ö‡∏ô‡∏Ñ‡∏≠‡∏°)
                const grid = document.getElementById('monitor-grid');
                grid.className = "grid grid-cols-1 xl:grid-cols-2 gap-6 p-6"; 
                grid.innerHTML = html;
                
                document.getElementById('mon-count-present').innerText = p;
                document.getElementById('mon-count-late').innerText = l;
                document.getElementById('mon-count-absent').innerText = a;
            });
        });
    });
}

        // --- 5. SCORE & TRACKING ---
        function downloadScoreTpl() {
            const gr = document.getElementById('sc-grade').value, sub = document.getElementById('sc-sub').value, tks = document.getElementById('sc-tasks').value.split(',').map(t=>t.trim()).filter(t=>t);
            if(!gr || !sub) return Swal.fire('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡πà‡∏≠‡∏ô');
            const data = students.filter(s=>s.grade===gr).map(s => { let o = {"‡∏£‡∏´‡∏±‡∏™": s.id, "‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•": s.name}; tks.forEach(t=>o[t]=""); return o; });
            const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Scores");
            XLSX.writeFile(wb, `Score_${gr}_${sub}.xlsx`);
        }

        async function uploadScoreData(e) {
            const sub = document.getElementById('sc-sub').value; if(!sub) return Swal.fire('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡πà‡∏≠‡∏ô');
            const r = new FileReader(); r.readAsBinaryString(e.target.files[0]);
            r.onload = async (evt) => {
                const wb = XLSX.read(evt.target.result, { type: 'binary' });
                const data = XLSX.utils.sheet_to_json(wb.Sheets["Scores"]);
                for(let row of data) {
                    const sid = row["‡∏£‡∏´‡∏±‡∏™"]?.toString().trim(); if(!sid) continue;
                    const scMap = {}; Object.keys(row).filter(k => !["‡∏£‡∏´‡∏±‡∏™","‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•"].includes(k)).forEach(k => scMap[k] = { score: row[k]||0 });
                    await db.ref(`scores/${sid}/${sub}`).set(scMap);
                }
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡πâ‡∏ß', 'success');
            };
        }

        async function loadTrackingReport() {
            const sub = document.getElementById('tr-sub').value, gr = document.getElementById('tr-grade').value;
            const sSnap = await db.ref('scores').once('value'); const allS = sSnap.val() || {};
            const room = students.filter(s => s.grade === gr); let tsks = new Set();
            room.forEach(s => { if(allS[s.id]?.[sub]) Object.keys(allS[s.id][sub]).forEach(t => tsks.add(t)); });
            const tArr = Array.from(tsks);
            document.getElementById('tr-head').innerHTML = `<tr><th class="p-3">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th><th class="p-3 text-left">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>${tArr.map(t=>`<th>${t}</th>`).join('')}</tr>`;
            document.getElementById('tr-body').innerHTML = room.map((s, i) => `<tr><td class="text-center font-bold">${i+1}</td><td class="text-left font-medium">${s.name}</td>${tArr.map(t => `<td class="text-center font-bold text-lg">${allS[s.id]?.[sub]?.[t]?'<span class="text-emerald-500">‚úì</span>':'<span class="text-rose-400">‡∏Ñ‡πâ‡∏≤‡∏á</span>'}</td>`).join('')}</tr>`).join('');
        }

        // --- 6. ADVANCED STATS ---
        async function generateStatsReport() {
    const gr = document.getElementById('st-grade').value;
    const sub = document.getElementById('st-sub').value;
    
    // --- ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πâ‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ---
    const cleanGr = gr.replace(/[.#$[\]]/g, "_");
    const cleanSub = sub.replace(/[.#$[\]]/g, "_");

    Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });

    // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase (‡∏î‡∏∂‡∏á‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏õ)
    const sSnap = await db.ref('sessions').once('value'); 
    const aSnap = await db.ref(`attendance/${cleanGr}/${cleanSub}`).once('value');
    
    const sess = Object.values(sSnap.val() || {}).filter(s => s.grade === gr && s.subject === sub);
    const att = aSnap.val() || {}; 
    const room = students.filter(s => s.grade === gr).sort((a,b)=>a.id-b.id);
    
    let html = "", tP=0, tL=0, tA=0;

    room.forEach((s, idx) => {
        let p=0, l=0, a=0;
        sess.forEach(ses => { 
            // ‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ att ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏î‡∏∂‡∏á‡∏°‡∏≤
            const r = att[ses.id]?.[s.id]; 
            if(!r || r.status === "‡∏Ç‡∏≤‡∏î") a++; 
            else if(r.status === "‡∏™‡∏≤‡∏¢") l++; 
            else p++; 
        });
        
        const per = sess.length > 0 ? (((p+l)/sess.length)*100).toFixed(0) : 0;
        tP+=p; tL+=l; tA+=a;
        html += `<tr><td>${idx+1}</td><td>${s.id}</td><td class="text-left font-medium">${s.name}</td><td class="status-present font-bold">${p}</td><td class="status-late font-bold">${l}</td><td class="status-absent font-bold">${a}</td><td class="font-bold ${per<80?'text-rose-600':'text-emerald-600'}">${per}%</td></tr>`;
    });

    document.getElementById('stats-table-body').innerHTML = html;
    document.getElementById('stats-area').classList.remove('hidden');
    document.getElementById('stats-summary-cards').innerHTML = `
        <div class="glass p-4 text-center border-l-8 border-emerald-500"><div>‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏∞‡∏™‡∏°</div><div class="text-3xl font-bold">${tP}</div></div>
        <div class="glass p-4 text-center border-l-8 border-orange-500"><div>‡∏°‡∏≤‡∏™‡∏≤‡∏¢‡∏™‡∏∞‡∏™‡∏°</div><div class="text-3xl font-bold">${tL}</div></div>
        <div class="glass p-4 text-center border-l-8 border-rose-500"><div>‡∏Ç‡∏≤‡∏î‡∏™‡∏∞‡∏™‡∏°</div><div class="text-3xl font-bold">${tA}</div></div>`;
    
    Swal.close();
}

        function exportStatsCSV() {
            let csv = []; const rows = document.querySelectorAll("#page-admin-stats table tr");
            rows.forEach(r => { let row = []; r.querySelectorAll("th, td").forEach(c => row.push(`"${c.innerText}"`)); csv.push(row.join(",")); });
            const blob = new Blob(["\ufeff" + csv.join("\n")], { type: "text/csv;charset=utf-8;" });
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = "Stats.csv"; link.click();
        }

        // 1. ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÑ‡∏ß‡πâ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß (‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô)
let temporaryChanges = {};

// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡πà‡∏á‡∏°‡∏≤ ‡∏ú‡∏°‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢)
async function showSessionEditor() {
    try {
        const gradeEl = document.getElementById('st-grade');
        const subEl = document.getElementById('st-sub');
        if (!gradeEl || !subEl) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á/‡∏ß‡∏¥‡∏ä‡∏≤', 'error');

        const gr = gradeEl.value, sub = subEl.value;
        if (!gr || !sub) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" ‡πÅ‡∏•‡∏∞ "‡∏ß‡∏¥‡∏ä‡∏≤" ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö', 'warning');

        Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });

        const sSnap = await db.ref('sessions').once('value');
        const allSessions = sSnap.val();
        if (!allSessions) return Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏î‡πÜ', 'info');

        const sessions = Object.entries(allSessions)
            .map(([id, data]) => ({ id, ...data }))
            .filter(s => s.grade === gr && s.subject === sub);

        if (sessions.length === 0) return Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', `‡∏ß‡∏¥‡∏ä‡∏≤ ${sub} ‡∏´‡πâ‡∏≠‡∏á ${gr} ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô`, 'info');

        sessions.reverse();
        let sessionButtons = sessions.map(s => {
            const sidStr = String(s.id); 
            const displayId = sidStr.length > 5 ? sidStr.slice(-5) : sidStr;
            return `
                <button onclick="editSessionAttendance('${s.id}')" 
                    class="m-1 px-4 py-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 shadow-sm transition-all text-sm font-bold min-w-[120px]">
                    üìÖ ${s.date || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'}<br>
                    <span class="text-xs font-normal opacity-80">ID: ${displayId}</span>
                </button>`;
        }).join('');

        Swal.fire({
            title: '<span class="text-lg">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</span>',
            html: `<div class="flex flex-wrap justify-center p-2">${sessionButtons}</div>`,
            showConfirmButton: false,
            showCloseButton: true,
            width: '500px'
        });
    } catch (error) {
        Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', error.message, 'error');
    }
}

// 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡πÅ‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)
async function editSessionAttendance(sessionId) {
    const gr = document.getElementById('st-grade').value;
    const sub = document.getElementById('st-sub').value;
    const cleanGr = gr.replace(/[.#$[\]]/g, "_");
    const cleanSub = sub.replace(/[.#$[\]]/g, "_");

    // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
    temporaryChanges = {};

    Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });

    try {
        const aSnap = await db.ref(`attendance/${cleanGr}/${cleanSub}/${sessionId}`).once('value');
        const currentAtt = aSnap.val() || {};
        const roomData = typeof students !== 'undefined' ? students.filter(s => s.grade === gr) : [];

        if (roomData.length === 0) return Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠', '‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô Master Data', 'warning');

        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ---
        let html = `
            <div class="flex justify-center gap-2 mb-4 bg-slate-50 p-2 rounded-xl">
                <button onclick="markAllInEditor('‡∏°‡∏≤')" class="px-4 py-2 bg-emerald-500 text-white rounded-lg font-bold text-xs hover:bg-emerald-600 transition-all">‚úÖ ‡∏°‡∏≤‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô</button>
                <button onclick="markAllInEditor('‡∏™‡∏≤‡∏¢')" class="px-4 py-2 bg-amber-500 text-white rounded-lg font-bold text-xs hover:bg-amber-600 transition-all">‚è≥ ‡∏™‡∏≤‡∏¢‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô</button>
                <button onclick="markAllInEditor('‡∏Ç‡∏≤‡∏î')" class="px-4 py-2 bg-rose-500 text-white rounded-lg font-bold text-xs hover:bg-rose-600 transition-all">‚ùå ‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô</button>
            </div>
            <div class="max-h-[50vh] overflow-y-auto border rounded-lg mb-4">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-100 sticky top-0">
                        <tr><th class="p-3 border-b">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th class="p-3 border-b w-32 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr>
                    </thead>
                    <tbody id="editor-table-body">`;

        roomData.sort((a,b) => a.id - b.id).forEach(s => {
            const currentStatus = currentAtt[s.id]?.status || "‡∏Ç‡∏≤‡∏î";
            html += `
                <tr class="border-b hover:bg-slate-50">
                    <td class="p-3 font-medium text-left">${s.name}</td>
                    <td class="p-3">
                        <select data-id="${s.id}" onchange="queueChange('${s.id}', this.value)" class="att-select w-full p-2 rounded-md border shadow-sm cursor-pointer">
                            <option value="‡∏°‡∏≤" ${currentStatus === '‡∏°‡∏≤' ? 'selected' : ''}>‚úÖ ‡∏°‡∏≤</option>
                            <option value="‡∏™‡∏≤‡∏¢" ${currentStatus === '‡∏™‡∏≤‡∏¢' ? 'selected' : ''}>‚è≥ ‡∏™‡∏≤‡∏¢</option>
                            <option value="‡∏Ç‡∏≤‡∏î" ${currentStatus === '‡∏Ç‡∏≤‡∏î' ? 'selected' : ''}>‚ùå ‡∏Ç‡∏≤‡∏î</option>
                            <option value="‡∏•‡∏≤" ${currentStatus === '‡∏•‡∏≤' ? 'selected' : ''}>üìù ‡∏•‡∏≤</option>
                        </select>
                    </td>
                </tr>`;
        });
        html += `</tbody></table></div>`;

        Swal.fire({
            title: `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${sessionId}`,
            html: html,
            showCancelButton: true,
            confirmButtonText: 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
            confirmButtonColor: '#10b981',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
            width: '600px',
            preConfirm: async () => {
                const total = Object.keys(temporaryChanges).length;
                if (total === 0) return Swal.showValidationMessage('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                try {
                    await db.ref(`attendance/${cleanGr}/${cleanSub}/${sessionId}`).update(temporaryChanges);
                    return true;
                } catch (e) { Swal.showValidationMessage(`Error: ${e.message}`); }
            }
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                if (typeof generateStatsReport === "function") generateStatsReport();
            }
        });
    } catch (e) { Swal.fire('Error', e.message, 'error'); }
}

// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏°: ‡∏ï‡∏¥‡πä‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ---
function markAllInEditor(status) {
    const selects = document.querySelectorAll('.att-select');
    selects.forEach(sel => {
        sel.value = status; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        const sid = sel.getAttribute('data-id');
        queueChange(sid, status); // ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô temporaryChanges
    });
}

// 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß (‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö)
function queueChange(studentId, newStatus) {
    temporaryChanges[studentId] = {
        status: newStatus,
        time: new Date().toLocaleTimeString('th-TH')
    };

}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏µ Dropdown
function getStatusStyle(status) {
    if (status === '‡∏°‡∏≤') return 'bg-emerald-50 text-emerald-700 border-emerald-200';
    if (status === '‡∏™‡∏≤‡∏¢') return 'bg-amber-50 text-amber-700 border-amber-200';
    if (status === '‡∏•‡∏≤') return 'bg-blue-50 text-blue-700 border-blue-200';
    return 'bg-rose-50 text-rose-700 border-rose-200';
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ Select ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
function getStatusColor(s) {
    if(s === '‡∏°‡∏≤') return 'bg-emerald-50 text-emerald-600';
    if(s === '‡∏™‡∏≤‡∏¢') return 'bg-amber-50 text-amber-600';
    if(s === '‡∏Ç‡∏≤‡∏î') return 'bg-rose-50 text-rose-600';
    if(s === '‡∏•‡∏≤') return 'bg-blue-50 text-blue-600';
    return '';
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏±‡∏ß‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏•‡∏á Firebase
async function updateSingleStatus(sessionId, studentId, newStatus) {
    const gr = document.getElementById('st-grade').value;
    const sub = document.getElementById('st-sub').value;
    const cleanGr = gr.replace(/[.#$[\]]/g, "_");
    const cleanSub = sub.replace(/[.#$[\]]/g, "_");

    try {
        await db.ref(`attendance/${cleanGr}/${cleanSub}/${sessionId}/${studentId}`).update({
            status: newStatus,
            time: new Date().toLocaleTimeString('th-TH')
        });
        
        // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏•‡πá‡∏Å‡πÜ ‡∏°‡∏∏‡∏°‡∏à‡∏≠
        const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1000 });
        Toast.fire({ icon: 'success', title: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß' });
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        generateStatsReport();
    } catch (e) {
        Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ', 'error');
    }
}
        // --- 7. QR PRINT TOOL ---
        function previewQR() {
            const gr = document.getElementById('qr-grade-sel').value; const list = students.filter(s => s.grade === gr).sort((a,b)=>a.id-b.id);
            const g = document.getElementById('preview-grid'), pg = document.getElementById('qr-print-grid');
            g.innerHTML = pg.innerHTML = ""; document.getElementById('qr-preview-box').classList.remove('hidden');
            list.forEach(s => {
                const h = `<div class="p-2 border rounded-xl flex flex-col items-center bg-white"><div id="qrp-${s.id}"></div><div class="text-[9px] mt-1 font-bold">${s.name}</div><div class="text-[8px] opacity-50">${s.id}</div></div>`;
                g.innerHTML += h; pg.innerHTML += h;
            });
            setTimeout(() => { list.forEach(s => { new QRCode(document.getElementById(`qrp-${s.id}`), { text: s.id, width: 80, height: 80 }); }); }, 500);
        }

        // --- 8. STUDENT LOGIC ---
        function handleStudentLogin() {
            const id = document.getElementById('std-login-id').value.trim(); const s = students.find(x => x.id === id);
            if(!s) return Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô');
            currentSid = id; showPage('std-dashboard');
            document.getElementById('std-name-txt').innerText = s.name; document.getElementById('std-grade-txt').innerText = `‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${s.grade}`;
            document.getElementById('std-img').src = s.photo || `https://api.dicebear.com/7.x/initials/svg?seed=${id}`;
            const g = document.getElementById('std-subject-list'); g.innerHTML = "";
            Object.entries(s.subjects || {}).forEach(([n, v]) => { if(v) {
                const b = document.createElement('button'); b.className = "glass p-6 text-left border-l-8 border-indigo-600 font-bold hover:bg-slate-50 transition-all";
                b.innerHTML = `<span class="text-[10px] block text-slate-400 uppercase">‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</span>${n}`;
                b.onclick = () => { currentSub = n; showPage('std-subject-menu'); document.getElementById('std-menu-sub-title').innerText = n; };
                g.appendChild(b);
            }});
        }

        async function showStdScores() { const s = await db.ref(`scores/${currentSid}/${currentSub}`).once('value'); const scs = s.val()||{}; const h = Object.entries(scs).map(([t,d])=>`<div class="flex justify-between p-5 bg-white border-2 rounded-2xl"><span class="font-bold">${t}</span><span class="font-black text-indigo-600 text-xl">${d.score}</span></div>`).join('') || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô'; renderContent("üèÜ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°", "#4f46e5", h); }
        async function showStdPending() { const sS = await db.ref('scores').once('value'); const allS = sS.val()||{}; let allT = new Set(); Object.values(allS).forEach(u => { if(u[currentSub]) Object.keys(u[currentSub]).forEach(t => allT.add(t)); }); const myS = allS[currentSid]?.[currentSub]||{}; const miss = Array.from(allT).filter(t => !myS[t]); const h = miss.map(m => `<div class="p-5 bg-rose-50 border-2 border-rose-100 rounded-2xl text-rose-600 font-bold text-lg">‚ùå ‡∏Ñ‡πâ‡∏≤‡∏á‡∏™‡πà‡∏á: ${m}</div>`).join('') || '<div class="text-emerald-500 font-black text-2xl text-center py-10">üéâ ‡∏Ñ‡∏∏‡∏ì‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß!</div>'; renderContent("üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á", "#f43f5e", h); }
        async function showStdDoNow() { const s = await db.ref('donow').once('value'); const d = s.val()||{}; const ok = d.active && d.subject === currentSub && students.find(x=>x.id===currentSid).grade === d.grade; renderContent("‚ö° ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° Do Now", "#fbbf24", ok ? `<div class="p-10 bg-amber-50 rounded-3xl border-4 border-dashed border-amber-300 text-center font-bold text-3xl text-amber-700">${d.text}</div>` : '<p class="text-center text-slate-300">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏î‡πà‡∏ß‡∏ô‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</p>'); }
        function renderContent(t, c, h) { showPage('std-content-view'); document.getElementById('content-title').innerText = t; document.getElementById('content-border').style.borderColor = c; document.getElementById('content-area').innerHTML = h; }
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏π: ‡∏Å‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö
        async function saveDoNow(isActive) {
    const grade = document.getElementById('dn-grade').value;
    const subject = document.getElementById('dn-sub').value;
    const message = document.getElementById('dn-msg').value;

    if (isActive && (!grade || !subject || !message)) {
        return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á ‡∏ß‡∏¥‡∏ä‡∏≤ ‡πÅ‡∏•‡∏∞‡πÇ‡∏à‡∏ó‡∏¢‡πå', 'warning');
    }

    // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
    const data = {
        active: isActive,
        grade: grade,
        subject: subject,
        text: message,
        startTime: firebase.database.ServerValue.TIMESTAMP // ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≤‡∏Å Server ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô
    };

    try {
        // ‡∏•‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Path: donow_config
        await db.ref('donow_config').set(data);
        
        if (isActive) {
            Swal.fire('‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß', 'success');
        } else {
            Swal.fire('‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö', '‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß', 'info');
        }
    } catch (e) {
        console.error(e);
        Swal.fire('Error', '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ' + e.message, 'error');
    }
}   

        // --- 9. HELPERS ---
        function updateSelectMenus() {
            const gs = [...new Set(students.map(s => s.grade))].sort();
            ['t-grade','sc-grade','st-grade','dn-grade','qr-grade-sel','tr-grade'].forEach(id => {
                const el = document.getElementById(id); if(el) el.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á --</option>` + gs.map(g => `<option value="${g}">${g}</option>`).join('');
            });
        }
        function updateSubFilter(g, t) {
            const sel = document.getElementById(t); const subs = new Set();
            students.filter(s => s.grade === g).forEach(s => Object.entries(s.subjects || {}).forEach(([n, v]) => { if(v) subs.add(n); }));
            sel.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤ --</option>` + Array.from(subs).map(s => `<option value="${s}">${s}</option>`).join('');
        }

        async function showStdDoNow() {
    const snap = await db.ref('donow').once('value');
    const d = snap.val();
    if (!d || !d.active) return Swal.fire('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°');
    
    // ‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏à‡∏ó‡∏¢‡πå
    renderContent('DO NOW', '#fbbf24', `<div class="p-8 rounded-3xl border-4 border-dashed border-amber-300 text-center font-bold text-3xl text-amber-700">${d.text}</div>`);
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏™‡πà‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
    const check = await db.ref(`donow_answers/${currentSid}`).once('value');
    if (check.exists()) {
        document.getElementById('dn-input-area').innerHTML = '<p class="text-center text-emerald-600 font-bold text-xl">‡∏Ñ‡∏∏‡∏ì‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß</p>';
    } else {
        document.getElementById('dn-input-area').classList.remove('hidden');
        startDoNowTimer();
    }
}

// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ Admin Do Now
db.ref('donow_answers').on('value', snap => {
    const data = snap.val() || {};
    let html = "";
    Object.values(data).forEach(a => {
        html += `<div class="p-3 bg-slate-50 rounded-lg border-b flex justify-between">
                    <span class="font-bold text-indigo-600">${a.name}:</span>
                    <span>${a.answer}</span>
                 </div>`;
    });
    document.getElementById('dn-admin-monitor').innerHTML = html || "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏™‡πà‡∏á‡∏°‡∏≤";
});

async function resetAttendance() {
    const gr = document.getElementById('st-grade').value;
    const sub = document.getElementById('st-sub').value;

    if (!gr || !sub) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" ‡πÅ‡∏•‡∏∞ "‡∏ß‡∏¥‡∏ä‡∏≤" ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö', 'warning');

    Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });

    try {
        // 1. ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Sessions ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏°‡∏≤‡∏´‡∏≤‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ
        const sSnap = await db.ref('sessions').once('value');
        const allSessions = sSnap.val();

        if (!allSessions) return Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏î‡πÜ', 'info');

        const sessions = Object.entries(allSessions)
            .map(([id, data]) => ({ id, ...data }))
            .filter(s => s.grade === gr && s.subject === sub);

        if (sessions.length === 0) return Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', `‡∏ß‡∏¥‡∏ä‡∏≤ ${sub} ‡∏´‡πâ‡∏≠‡∏á ${gr} ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏•‡∏ö`, 'info');

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤
        sessions.reverse();

        // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö
        let sessionButtons = sessions.map(s => {
            const sidStr = String(s.id);
            const displayId = sidStr.length > 5 ? sidStr.slice(-5) : sidStr;
            return `
                <button onclick="confirmDeleteSession('${s.id}', '${s.date}')" 
                    class="m-1 px-4 py-3 bg-rose-50 text-rose-700 border border-rose-200 rounded-xl hover:bg-rose-600 hover:text-white shadow-sm transition-all text-sm font-bold min-w-[120px]">
                    üóëÔ∏è ‡∏•‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤<br>
                    <span class="text-[11px] font-normal opacity-80">${s.date} (${displayId})</span>
                </button>`;
        }).join('');

        Swal.fire({
            title: '<span class="text-rose-600">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á</span>',
            html: `<div class="p-2 mb-2 text-xs text-slate-500">‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ñ‡∏≤‡∏ß‡∏£</div>
                   <div class="flex flex-wrap justify-center p-2">${sessionButtons}</div>`,
            showConfirmButton: false,
            showCloseButton: true,
            width: '500px'
        });

    } catch (error) {
        Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', error.message, 'error');
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Ñ‡∏≤‡∏ö
async function confirmDeleteSession(sessionId, sessionDate) {
    const gr = document.getElementById('st-grade').value;
    const sub = document.getElementById('st-sub').value;
    const cleanGr = gr.replace(/[.#$[\]]/g, "_");
    const cleanSub = sub.replace(/[.#$[\]]/g, "_");

    const result = await Swal.fire({
        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ñ‡∏≤‡∏ö‡∏ô‡∏µ‡πâ?',
        text: `‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${sessionDate} ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á‡∏ñ‡∏≤‡∏ß‡∏£ ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#e11d48',
        cancelButtonColor: '#64748b',
        confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á‡πÄ‡∏•‡∏¢',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
    });

    if (result.isConfirmed) {
        try {
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });

            // 1. ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Attendance ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≤‡∏ö‡∏ô‡∏±‡πâ‡∏ô
            await db.ref(`attendance/${cleanGr}/${cleanSub}/${sessionId}`).remove();

            // 2. ‡∏•‡∏ö‡∏ï‡∏±‡∏ß Session ‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏¥‡πâ‡∏á
            await db.ref(`sessions/${sessionId}`).remove();

            await Swal.fire({
                icon: 'success',
                title: '‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≤‡∏ö‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                timer: 1500,
                showConfirmButton: false
            });

            // 3. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            generateStatsReport();

        } catch (error) {
            Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏î‡πâ: ' + error.message, 'error');
        }
    }
}
    async function viewDoNowAnswers() {
        if (typeof students === 'undefined' || students.length === 0) {
            return Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Excel ‡∏Å‡πà‡∏≠‡∏ô', 'error');
        }
        const grades = [...new Set(students.map(s => s.grade))].sort();
        let html = `<div class="grid grid-cols-2 gap-4 p-2">`;
        grades.forEach(gr => {
            html += `<button onclick='selectDoNowSubject(${JSON.stringify(gr)})' class="p-5 bg-indigo-600 text-white rounded-2xl font-black text-xl shadow-md">üè´ ‡∏´‡πâ‡∏≠‡∏á ${gr}</button>`;
        });
        html += `</div>`;
        Swal.fire({ title: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', html: html, showConfirmButton: false, showCloseButton: true });
    }

    async function selectDoNowSubject(gr) {
        Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...', didOpen: () => Swal.showLoading() });
        try {
            const cleanGr = gr.replace(/[.#$[\]]/g, "_");
            const snap = await db.ref(`donow/${cleanGr}`).once('value');
            const data = snap.val();
            if (!data) return Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', `‡∏´‡πâ‡∏≠‡∏á ${gr} ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ Do Now`, 'info');
            const subjects = Object.keys(data).filter(k => !['active', 'global'].includes(k));
            let html = `<div class="grid grid-cols-1 gap-3 p-2">`;
            subjects.forEach(sub => {
                html += `<button onclick='selectDoNowDate(${JSON.stringify(gr)}, ${JSON.stringify(sub)})' class="p-4 bg-emerald-50 text-emerald-700 border-2 border-emerald-200 rounded-2xl font-bold text-lg text-left shadow-sm">üìö ‡∏ß‡∏¥‡∏ä‡∏≤ ${sub.replace(/_/g, " ")}</button>`;
            });
            Swal.fire({ title: `‡∏ß‡∏¥‡∏ä‡∏≤‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á ${gr}`, html: html, showConfirmButton: false });
        } catch (e) { Swal.fire('Error', '‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏¥‡∏ä‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error'); }
    }

    async function selectDoNowDate(gr, sub) {
        Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...', didOpen: () => Swal.showLoading() });
        try {
            const cleanGr = gr.replace(/[.#$[\]]/g, "_");
            const cleanSub = sub.replace(/[.#$[\]]/g, "_");
            const snap = await db.ref(`donow/${cleanGr}/${cleanSub}`).once('value');
            const dates = Object.keys(snap.val()).sort().reverse();
            let html = `<div class="grid grid-cols-2 gap-3 p-2">`;
            dates.forEach(d => {
                html += `<button onclick="showDoNowDetail('${cleanGr}', '${cleanSub}', '${d}')" class="p-4 bg-amber-50 text-amber-700 border-2 border-amber-200 rounded-2xl font-bold text-lg shadow-sm">üìÖ ${d}</button>`;
            });
            Swal.fire({ title: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', html: html, showConfirmButton: false });
        } catch (e) { Swal.fire('Error', '‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error'); }
}
// ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö Timer ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ô‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
let donowTimerInterval;

function initDoNowListener() {
    // ‡∏î‡∏±‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏à‡∏≤‡∏Å Firebase Path: donow_config
    db.ref('donow_config').on('value', (snap) => {
        const d = snap.val();
        if (!d || !d.active) return; // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏£‡∏π‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£

        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏•‡∏∞‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏´‡∏°
        // (‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ currentSub ‡πÅ‡∏•‡∏∞ currentSid ‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ‡∏ï‡∏≠‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤)
        const student = students.find(s => s.id === currentSid);
        const isTarget = d.subject === currentSub && student.grade === d.grade;

        if (isTarget) {
            // 1. ‡πÄ‡∏î‡πâ‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            showPage('page-std-content-view');
            
            // 2. ‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏à‡∏ó‡∏¢‡πå‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤
            document.getElementById('content-title').innerText = "‚ö° ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° DO NOW";
            document.getElementById('content-area').innerHTML = `
                <div class="space-y-6">
                    <div class="p-8 bg-amber-50 rounded-3xl border-4 border-dashed border-amber-300 text-center font-bold text-3xl text-amber-700">
                        ${d.text}
                    </div>
                    
                    <div class="text-center">
                        <div class="text-sm text-slate-500 uppercase tracking-widest">‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏µ‡∏Å</div>
                        <div id="dn-clock" class="text-5xl font-black text-red-500 my-2">180</div>
                        <div class="text-sm text-slate-500">‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</div>
                    </div>

                    <div id="dn-input-section" class="space-y-4">
                        <textarea id="std-dn-answer" class="w-full p-4 border-2 border-indigo-200 rounded-2xl focus:ring-4 focus:ring-indigo-100 outline-none text-lg" rows="3" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
                        <button onclick="submitDoNowAnswer()" id="btn-dn-submit" class="w-full py-4 bg-indigo-600 text-white rounded-2xl font-bold text-xl shadow-lg hover:bg-indigo-700 active:scale-95 transition-all">
                            ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡∏µ‡πâ!
                        </button>
                    </div>
                </div>
            `;

            // 3. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ 180 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            startCountdown(180);
        }
    });
}

function startCountdown(seconds) {
    clearInterval(donowTimerInterval);
    let timeLeft = seconds;
    const clockDisplay = document.getElementById('dn-clock');
    const btn = document.getElementById('btn-dn-submit');
    const textarea = document.getElementById('std-dn-answer');

    donowTimerInterval = setInterval(() => {
        timeLeft--;
        clockDisplay.innerText = timeLeft;

        if (timeLeft <= 0) {
            clearInterval(donowTimerInterval);
            clockDisplay.innerText = "‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤!";
            btn.disabled = true;
            btn.classList.replace('bg-indigo-600', 'bg-slate-400');
            textarea.disabled = true;
            textarea.placeholder = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤";
        }
    }, 1000);
}

async function submitDoNowAnswer() {
    const ans = document.getElementById('std-dn-answer').value;
    if (!ans) return Swal.fire('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö');

    try {
        await db.ref(`donow_answers/${currentSid}`).set({
            name: students.find(s => s.id === currentSid).name,
            answer: ans,
            time: new Date().toLocaleTimeString('th-TH'),
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });
        
        clearInterval(donowTimerInterval);
        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
        showPage('page-std-subject-menu'); // ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤
    } catch (e) {
        Swal.fire('Error', '‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e.message, 'error');
    }
}

    </script>
</body>
</html>

