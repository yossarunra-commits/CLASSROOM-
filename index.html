<!doctype html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom Yossarun - Complete Edition</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Kanit', sans-serif; background: #f1f5f9; color: #1e293b; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .glass { background: white; border-radius: 1.25rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        #reader { width: 100% !important; max-width: 380px; margin: 0 auto; border-radius: 1rem; overflow: hidden; border: 4px solid white; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .status-present { background: #dcfce7; color: #166534; }
        .status-late { background: #ffedd5; color: #9a3412; }
        .status-absent { background: #f1f5f9; color: #64748b; }
        @media print { .no-print { display: none; } .print-area { display: block !important; } }
        th, td { border: 1px solid #e2e8f0; padding: 12px; }
        @keyframes scan {
            0% { top: 0%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }
        #tr-body td.sticky, #tr-head th.sticky {
    position: sticky;
    background-color: white;
    z-index: 10;
        }
        .sticky-left-0 { left: 0; }
        .sticky-left-16 { left: 4rem; }
        .sticky-left-120 { left: 7.5rem; }
        /* ‡∏•‡πá‡∏≠‡∏Ñ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ä‡∏∑‡πà‡∏≠ */
        #tr-head th { position: sticky; top: 0; z-index: 40; }
        .sticky-col { position: sticky; left: 0; background-color: white !important; z-index: 30; }
        .name-col { left: 64px; } /* ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà */
    </style>
</head>
<body>

    <nav class="bg-white/80 backdrop-blur-md sticky top-0 z-[100] border-b p-4 flex justify-between items-center no-print">
        <h1 class="text-xl font-bold tracking-tight text-slate-800">CLASSROOM <span class="text-indigo-600">Yossarun</span></h1>
        <div class="flex gap-2">
            <button onclick="location.reload()" class="p-2 bg-slate-100 rounded-lg">üîÑ</button>
            <button onclick="authAdmin()" class="bg-slate-900 text-white px-5 py-2 rounded-xl text-xs font-semibold uppercase hover:bg-indigo-600 transition-all">Teacher Mode</button>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto p-4 md:p-6 no-print">

        <section id="page-home" class="page active">
            <div class="max-w-md mx-auto mt-16 glass p-10 text-center border-t-8 border-indigo-600">
                <div class="text-6xl mb-6">üéí</div>
                <h2 class="text-3xl font-bold mb-2 text-slate-800">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                <p class="text-slate-400 mb-8">‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                <input type="text" id="std-login-id" class="w-full p-5 bg-slate-50 border-2 rounded-2xl mb-4 text-center text-4xl font-bold focus:ring-4 focus:ring-indigo-100 outline-none border-slate-200 transition-all" placeholder="00000">
                <button onclick="handleStudentLogin()" class="w-full py-5 bg-indigo-600 text-white rounded-2xl text-xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-all">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </section>

        <section id="page-admin-menu" class="page">
            <h2 class="text-2xl font-bold mb-8 flex items-center gap-3"><span class="w-2 h-8 bg-indigo-600 rounded-full"></span> ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <button onclick="showPage('admin-teach')" class="glass p-8 bg-indigo-600 text-white text-lg font-bold hover:scale-105 transition-transform shadow-indigo-200 shadow-lg">üìç ‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</button>
                <button onclick="showPage('admin-monitor')" class="glass p-8 bg-emerald-600 text-white text-lg font-bold hover:scale-105 transition-transform shadow-emerald-200 shadow-lg">üñ•Ô∏è ‡∏à‡∏≠‡∏°‡∏≠‡∏ô‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå</button>
                <button onclick="showPage('admin-donow')" class="glass p-8 bg-amber-400 text-white text-lg font-bold">‚ö° ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° Do Now</button>
                <button onclick="showPage('admin-check'); populateCheckGrade();" class="glass p-8 bg-emerald-500 text-white text-lg font-bold hover:scale-105 transition-all shadow-emerald-200 shadow-lg flex flex-col items-center justify-center gap-3"><span class="text-4xl">üì∏</span><span>Scan & Check</span></button>
                <button onclick="showPage('admin-exam'); initAdminExamPage();" class="glass p-8 bg-emerald-600 text-white text-xl font-black rounded-[2.5rem] hover:scale-105 transition-transform shadow-emerald-200 shadow-xl flex flex-col items-center gap-3"> <span class="text-4xl">üìù</span> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≠‡∏ö </button>
                <button onclick="showPage('admin-random'); populateRandomGrade();" class="glass p-8 bg-orange-500 text-white text-lg font-bold hover:scale-105 transition-transform shadow-orange-200 shadow-lg">üé≤ ‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ä‡∏∑‡πà‡∏≠</button>
                <button onclick="showPage('admin-stats')" class="glass p-8 bg-sky-500 text-white text-lg font-bold hover:scale-105 transition-transform shadow-sky-200 shadow-lg">üìà ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                <button onclick="showPage('admin-tracking')" class="glass p-8 bg-rose-500 text-white text-lg font-bold hover:scale-105 transition-transform shadow-rose-200 shadow-lg">üìã ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô</button>
                <button onclick="showPage('admin-score')" class="glass p-8 bg-violet-600 text-white text-lg font-bold">üìä ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
                <button onclick="showPage('admin-qr-print-tool')" class="glass p-8 bg-white text-slate-700 text-lg font-bold border-2">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå QR Code</button>
                <button onclick="showPage('admin-master')" class="glass p-8 bg-slate-800 text-white text-lg font-bold italic">üíæ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
            </div>       
        </section>

        <section id="page-admin-teach" class="page">
            <button onclick="showPage('admin-menu')" class="mb-4 font-bold text-slate-400">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π</button>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="glass p-6">
                    <h3 class="text-lg font-bold mb-4 text-indigo-600 underline">1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                    <div class="space-y-3">
                        <select id="t-grade" onchange="updateSubFilter(this.value, 't-sub')" class="w-full p-4 border rounded-xl"></select>
                        <select id="t-sub" class="w-full p-4 border rounded-xl"></select>
                        <input type="date" id="t-date" class="w-full p-4 border rounded-xl">
                        <div class="grid grid-cols-2 gap-2">
                            <input type="time" id="t-start" class="p-4 border rounded-xl" placeholder="‡πÄ‡∏£‡∏¥‡πà‡∏°">
                            <input type="time" id="t-end" class="p-4 border rounded-xl" placeholder="‡∏à‡∏ö">
                        </div>
                        <button onclick="createSession()" class="w-full py-4 bg-indigo-600 text-white rounded-xl font-bold text-lg">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö Global Sync</button>
                    </div>
                </div>
                
                <div class="lg:col-span-2 glass p-10 text-center relative">
    <div id="ses-label" class="mb-6 text-xl font-bold text-slate-400 italic">
        ‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠/‡∏á‡∏≤‡∏ô
    </div>

    <div id="reader" class="overflow-hidden rounded-3xl border-4 border-white shadow-inner bg-slate-100"></div>

    <div class="mt-8 max-w-sm mx-auto">
        <div class="relative group">
            <input type="number" 
                    id="manual-id" 
                   class="w-full p-5 bg-white/50 backdrop-blur-sm border-2 border-slate-200 rounded-2xl text-center text-2xl font-black text-slate-700 outline-none focus:border-slate-900 transition-all"
                   placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">
            
                   <button onclick="checkManual()" 
                    class="absolute right-2 top-2 bottom-2 px-6 bg-slate-900 text-white rounded-xl font-bold hover:bg-slate-700 transition-all">
                OK
            </button>
        </div>
        <p class="mt-2 text-xs text-slate-400 font-bold uppercase tracking-widest">Manual Input ID</p>
    </div>

    <div class="flex gap-4 mt-8 max-w-sm mx-auto">
        <button id="btn-on" onclick="toggleScanner(true)" class="flex-1 py-4 bg-slate-900 text-white rounded-2xl font-bold shadow-lg">‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
        <button id="btn-off" onclick="toggleScanner(false)" class="flex-1 py-4 bg-slate-200 text-slate-500 rounded-2xl font-bold" disabled>‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
    </div>
</div>
        </section>

        <section id="page-admin-monitor" class="page">
            <button onclick="showPage('admin-menu')" class="mb-4 font-bold text-slate-400">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π</button>
            <div class="glass p-6 mb-6 flex flex-wrap justify-between items-center border-l-[12px] border-emerald-500">
                <div>
                    <h2 id="mon-sub-title" class="text-3xl font-bold text-indigo-600">‡∏ß‡∏¥‡∏ä‡∏≤: -</h2>
                    <p id="mon-ses-info" class="text-slate-400 font-medium"></p>
                </div>
                <div class="flex gap-4">
                    <div class="bg-emerald-50 p-4 rounded-2xl text-center min-w-[100px]">
                        <div class="text-xs font-bold text-emerald-600 uppercase">‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
                        <div id="mon-count-present" class="text-3xl font-bold text-emerald-700">0</div>
                    </div>
                    <div class="bg-orange-50 p-4 rounded-2xl text-center min-w-[100px]">
                        <div class="text-xs font-bold text-orange-600 uppercase">‡∏°‡∏≤‡∏™‡∏≤‡∏¢</div>
                        <div id="mon-count-late" class="text-3xl font-bold text-orange-700">0</div>
                    </div>
                    <div class="bg-slate-100 p-4 rounded-2xl text-center min-w-[100px]">
                        <div class="text-xs font-bold text-slate-500 uppercase">‡∏Ç‡∏≤‡∏î</div>
                        <div id="mon-count-absent" class="text-3xl font-bold text-slate-600">0</div>
                    </div>
                </div>
            </div>
            <div id="monitor-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-4"></div>
        </section>

<section id="page-admin-score" class="page p-4 md:p-6 bg-slate-50 min-h-screen">
    <div class="max-w-7xl mx-auto mb-6 flex items-center justify-between">
        <button onclick="showPage('admin-menu')" class="flex items-center gap-2 px-5 py-2.5 bg-white text-slate-500 font-bold rounded-2xl shadow-sm hover:text-violet-600 transition-all group">
            <span class="group-hover:-translate-x-1 transition-transform">‚Üê</span> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
        </button>
        <div class="text-right">
            <h2 class="text-2xl md:text-3xl font-black text-violet-600 tracking-tight">üìä ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h2>
            <p class="text-slate-400 text-sm font-medium">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≤‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå ‡∏´‡∏£‡∏∑‡∏≠ ‡∏™‡∏£‡πâ‡∏≤‡∏á Template ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</p>
        </div>
    </div>

    <div class="max-w-7xl mx-auto bg-white p-6 rounded-[2.5rem] shadow-xl border border-violet-100 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="space-y-2">
                <label class="block text-xs font-black text-violet-400 ml-4 uppercase tracking-widest">1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                <select id="sc-grade" onchange="updateSubFilter(this.value, 'sc-sub'); resetScoreConfig();" class="w-full p-4 bg-slate-50 border-2 border-transparent focus:border-violet-300 rounded-2xl font-bold text-slate-700 outline-none transition-all"></select>
            </div>
            <div class="space-y-2">
                <label class="block text-xs font-black text-violet-400 ml-4 uppercase tracking-widest">2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤</label>
                <select id="sc-sub" onchange="showMethodSelection()" class="w-full p-4 bg-slate-50 border-2 border-transparent focus:border-violet-300 rounded-2xl font-bold text-slate-700 outline-none transition-all"></select>
            </div>
        </div>
    </div>

    <div id="method-selection" class="max-w-7xl mx-auto mb-6 hidden animate-in zoom-in duration-300">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <button onclick="switchScoreMode('link')" class="p-6 bg-white border-2 border-slate-100 rounded-[2rem] hover:border-violet-500 hover:bg-violet-50 transition-all group text-left">
                <div class="text-3xl mb-2">üîó</div>
                <h4 class="font-black text-slate-700">‡πÉ‡∏ä‡πâ‡∏•‡∏¥‡∏á‡∏Å‡πå Google Sheets</h4>
                <p class="text-slate-400 text-xs">‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß</p>
            </button>
            <button onclick="switchScoreMode('template')" class="p-6 bg-white border-2 border-slate-100 rounded-[2rem] hover:border-emerald-500 hover:bg-emerald-50 transition-all group text-left">
                <div class="text-3xl mb-2">üìÑ</div>
                <h4 class="font-black text-slate-700">‡∏™‡∏£‡πâ‡∏≤‡∏á Template ‡πÉ‡∏´‡∏°‡πà</h4>
                <p class="text-slate-400 text-xs">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Excel</p>
            </button>
        </div>
    </div>

    <div id="config-link-area" class="max-w-7xl mx-auto bg-violet-50 p-8 rounded-[3rem] border-4 border-dashed border-violet-200 mb-8 hidden">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="md:col-span-4 space-y-2">
                <label class="text-sm font-bold text-slate-600 ml-2">‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå Google Sheets</label>
                <input type="text" id="sc-sheet-url" placeholder="https://docs.google.com/spreadsheets/d/..." class="w-full p-5 bg-white border-none rounded-3xl shadow-sm outline-none font-medium">
            </div>
            <div class="md:col-span-2 space-y-2">
                <label class="text-xs font-black text-emerald-500 ml-4 uppercase tracking-widest">‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ú‡πà‡∏ô‡∏á‡∏≤‡∏ô (Tab Name)</label>
                <input type="text" id="sc-sheet-name" value="‡∏á‡∏≤‡∏ô" class="w-full p-4 bg-white border-none rounded-2xl font-bold text-slate-700">
            </div>
            <div class="md:col-span-1 space-y-2">
                <label class="text-xs font-black text-violet-400 ml-4 uppercase tracking-widest">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà</label>
                <input type="number" id="sc-row-start" value="2" class="w-full p-4 bg-white border-none rounded-2xl text-center font-bold text-slate-700">
            </div>
            <div class="md:col-span-1 flex items-end">
                <button onclick="syncScoreFromSheets()" class="w-full py-4 bg-violet-600 text-white rounded-2xl font-black shadow-lg hover:bg-violet-700 transition-all">üöÄ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
        </div>
    </div>

    <div id="config-template-area" class="max-w-7xl mx-auto bg-white p-8 rounded-[3rem] shadow-xl border border-slate-100 mb-8 hidden">
    <div class="flex items-center gap-3 mb-8">
        <div class="w-12 h-12 bg-emerald-100 rounded-2xl flex items-center justify-center text-2xl">üõ†Ô∏è</div>
        <div>
            <h3 class="text-2xl font-black text-slate-800">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h3>
            <p class="text-slate-400 text-sm">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</p>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10">
        <div class="space-y-4">
            <h4 class="font-black text-emerald-600 px-4 flex items-center gap-2">
                <span class="w-2 h-6 bg-emerald-500 rounded-full"></span>
                ‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ
            </h4>
            <div id="pre-task-container" class="space-y-2">
                </div>
            <button onclick="addTaskRow('pre')" class="w-full p-4 border-2 border-dashed border-slate-200 rounded-3xl text-slate-400 font-bold hover:border-emerald-400 hover:text-emerald-500 transition-all">
                + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
            </button>
        </div>

        <div class="space-y-4">
            <h4 class="font-black text-indigo-600 px-4 flex items-center gap-2">
                <span class="w-2 h-6 bg-indigo-500 rounded-full"></span>
                ‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ
            </h4>
            <div id="post-task-container" class="space-y-2">
                </div>
            <button onclick="addTaskRow('post')" class="w-full p-4 border-2 border-dashed border-slate-200 rounded-3xl text-slate-400 font-bold hover:border-indigo-400 hover:text-indigo-500 transition-all">
                + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10 border-t pt-8">
        <div class="flex items-center gap-4 bg-orange-50 p-4 rounded-3xl border border-orange-100">
            <span class="font-black text-orange-600 min-w-[100px]">‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ</span>
            <input type="number" id="mid-max" value="20" class="w-full p-3 rounded-2xl border-none font-black text-center text-orange-600 outline-none" placeholder="‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏°">
        </div>
        <div class="flex items-center gap-4 bg-rose-50 p-4 rounded-3xl border border-rose-100">
            <span class="font-black text-rose-600 min-w-[100px]">‡∏õ‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏Ñ</span>
            <input type="number" id="final-max" value="30" class="w-full p-3 rounded-2xl border-none font-black text-center text-rose-600 outline-none" placeholder="‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏°">
        </div>
    </div>

    <div class="flex flex-wrap gap-4 items-center justify-between border-t pt-8 mt-6">
    <button onclick="generateTemplatePreview()" class="px-12 py-4 bg-slate-900 text-white rounded-[2rem] font-black hover:scale-105 transition-all shadow-xl shadow-slate-200">
        ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    </button>
    
    <div class="flex flex-wrap items-center gap-3 bg-slate-50 p-3 rounded-[2.5rem] border border-slate-100 shadow-sm">
        <span class="text-xs font-black text-slate-400 ml-4 uppercase tracking-widest">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å Template ‡πÑ‡∏õ‡∏¢‡∏±‡∏á:</span>
        
        <select id="copy-grade" onchange="updateSubFilter(this.value, 'copy-sub')" class="bg-white border-none rounded-2xl text-xs font-bold p-3 outline-none shadow-sm min-w-[120px]">
            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
            </select>

        <select id="copy-sub" class="bg-white border-none rounded-2xl text-xs font-bold p-3 outline-none shadow-sm min-w-[150px]">
            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤</option>
        </select>

        <button onclick="confirmCopyTemplate()" class="bg-indigo-600 text-white px-6 py-3 rounded-2xl text-xs font-black hover:bg-indigo-700 transition-all shadow-md">
            ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å
        </button>
    </div>
</div>
</div>

<div id="score-preview-container" class="max-w-7xl mx-auto hidden animate-in fade-in slide-in-from-bottom duration-700">
    <div class="flex flex-wrap items-center justify-between mb-6 gap-4">
        <h3 class="text-2xl font-black text-slate-800 flex items-center gap-3">
            üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
        </h3>
        <div class="flex gap-3">
            <button onclick="exportTemplateToExcel()" class="px-6 py-3 bg-emerald-100 text-emerald-700 rounded-2xl font-bold flex items-center gap-2 hover:bg-emerald-200 transition-all">
                üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Excel
            </button>
            <label class="px-6 py-3 bg-indigo-100 text-indigo-700 rounded-2xl font-bold flex items-center gap-2 hover:bg-indigo-200 transition-all cursor-pointer">
                üì§ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
                <input type="file" class="hidden" onchange="importScoreFromExcel(this)">
            </label>
            <button onclick="saveAllScoresToDB()" class="px-8 py-3 bg-indigo-600 text-white rounded-2xl font-black shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-all">
                ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö
            </button>
        </div>
    </div>

    <div class="bg-white rounded-[3rem] shadow-2xl overflow-hidden border border-slate-100">
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead id="sc-preview-head">
                    </thead>
                <tbody id="sc-preview-body">
                    </tbody>
            </table>
        </div>
    </div>
</div>
</section>

        <section id="page-admin-stats" class="page">
            <button onclick="showPage('admin-menu')" class="mb-4 font-bold text-slate-400">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
            <div class="glass p-8 mb-6">
                <h2 class="text-2xl font-bold mb-6">üìà ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•/‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞)</h2>
                <div class="flex flex-wrap gap-4">
                    <select id="st-grade" onchange="updateSubFilter(this.value, 'st-sub')" class="p-4 border rounded-2xl flex-1"></select>
                    <select id="st-sub" class="p-4 border rounded-2xl flex-1"></select>
                    <button onclick="generateStatsReport()" class="px-10 py-4 bg-indigo-600 text-white rounded-2xl font-bold">‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•</button>
                    <button onclick="showSessionEditor()" class="px-6 py-4 bg-indigo-600 text-white rounded-2xl font-bold hover:bg-indigo-700 transition-all ml-2">üîç ‡∏î‡∏π/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏£‡∏≤‡∏¢‡∏Ñ‡∏≤‡∏ö</button>
                    <button onclick="resetAttendance()" class="px-10 py-4 bg-rose-600 text-white rounded-2xl font-bold hover:bg-rose-700 transition-all"> ‚ö†Ô∏è ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    <button onclick="exportStatsCSV()" class="px-10 py-4 bg-emerald-600 text-white rounded-2xl font-bold">Export CSV</button>
                </div>
            </div>
            <div id="stats-area" class="hidden">
                <div id="stats-summary-cards" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"></div>
                <div class="glass overflow-hidden">
                    <table class="w-full text-sm">
                        <thead class="bg-slate-800 text-white">
                            <tr><th>‡∏ó‡∏µ‡πà</th><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th class="bg-emerald-600">‡∏°‡∏≤</th><th class="bg-orange-500">‡∏™‡∏≤‡∏¢</th><th class="bg-rose-600">‡∏Ç‡∏≤‡∏î</th><th>‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞</th></tr>
                        </thead>
                        <tbody id="stats-table-body" class="bg-white"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="page-admin-tracking" class="page p-4 md:p-6 bg-slate-50/50 min-h-screen">
    <div class="max-w-7xl mx-auto mb-6 flex items-center justify-between">
        <button onclick="showPage('admin-menu')" class="flex items-center gap-2 px-4 py-2 bg-white text-slate-500 font-bold rounded-2xl shadow-sm hover:text-rose-500 hover:shadow transition-all group">
            <span class="text-xl group-hover:-translate-x-1 transition-transform">‚Üê</span> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
        </button>
        <div class="text-right">
            <h2 class="text-2xl md:text-3xl font-black text-rose-500 tracking-tight flex items-center gap-3">
                <span class="p-2 bg-rose-100 rounded-2xl">üìã</span> ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á
            </h2>
            <p class="text-slate-400 text-sm font-medium">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö Real-time</p>
        </div>
    </div>

    <div class="max-w-7xl mx-auto bg-white/80 backdrop-blur-md p-6 rounded-[2.5rem] shadow-xl shadow-slate-200/50 border border-white mb-8">
        <div class="flex flex-col md:flex-row gap-4">
            <div class="flex-1 relative">
                <label class="block text-xs font-bold text-slate-400 ml-4 mb-1 uppercase tracking-wider">‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                <select id="tr-grade" onchange="updateSubFilter(this.value, 'tr-sub')" class="w-full p-4 bg-slate-100/50 border-2 border-transparent focus:border-rose-300 focus:bg-white rounded-2xl font-bold text-slate-700 outline-none transition-all appearance-none"></select>
            </div>
            <div class="flex-1 relative">
                <label class="block text-xs font-bold text-slate-400 ml-4 mb-1 uppercase tracking-wider">‡∏ß‡∏¥‡∏ä‡∏≤ / ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô</label>
                <select id="tr-sub" class="w-full p-4 bg-slate-100/50 border-2 border-transparent focus:border-rose-300 focus:bg-white rounded-2xl font-bold text-slate-700 outline-none transition-all appearance-none"></select>
            </div>
            <div class="md:pt-5">
                <button onclick="loadTrackingReport()" class="w-full md:w-auto px-10 py-4 bg-rose-500 hover:bg-rose-600 text-white rounded-2xl font-black shadow-lg shadow-rose-200 active:scale-95 transition-all flex items-center justify-center gap-2">
                    üîç ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto bg-white rounded-[2.5rem] shadow-2xl shadow-slate-200/60 overflow-hidden border border-slate-100">
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr id="tr-head" class="bg-slate-900 text-white">
                        </tr>
                </thead>
                <tbody id="tr-body" class="divide-y divide-slate-100 text-slate-600">
                    </tbody>
            </table>
        </div>
        <div id="no-data-view" class="py-20 text-center hidden">
            <div class="text-6xl mb-4">üìÇ</div>
            <p class="text-slate-400 font-bold text-lg">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ</p>
        </div>
    </div>
</section>

        <section id="page-admin-master" class="page">
            <button onclick="showPage('admin-menu')" class="mb-4 font-bold text-slate-400">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="glass p-8 border-t-8 border-slate-800">
                    <h3 class="text-xl font-bold mb-4">üíæ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                    <input type="file" onchange="loadExcel(event)" class="w-full p-6 border-2 border-dashed rounded-2xl mb-4 bg-slate-50">
                    <div id="map-ui" class="hidden bg-white p-6 border rounded-2xl space-y-4">
    <p class="text-xs font-bold text-slate-400 uppercase">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (5 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏´‡∏•‡∏±‡∏Å)</p>
    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
        <div>‡∏£‡∏´‡∏±‡∏™: <select id="m-id" class="w-full p-2 border rounded"></select></div>
        <div>‡∏ä‡∏∑‡πà‡∏≠: <select id="m-name" class="w-full p-2 border rounded"></select></div>
        <div>‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•: <select id="m-surname" class="w-full p-2 border rounded"></select></div>
        <div>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô: <select id="m-nickname" class="w-full p-2 border rounded"></select></div>
        <div>‡∏´‡πâ‡∏≠‡∏á: <select id="m-grade" class="w-full p-2 border rounded"></select></div>
    </div>
    <p class="text-[10px] text-indigo-500">* ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏à‡∏≤‡∏Å‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
    <button onclick="saveMasterData()" class="w-full py-4 bg-indigo-600 text-white rounded-xl font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
</div>
                </div>
                <div class="glass p-8 bg-slate-900 text-white text-center">
                    <h3 class="text-xl font-bold mb-4 text-indigo-400">üì∏ Sync ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                    <input type="file" id="photo-input" multiple accept="image/*" class="hidden" onchange="handlePhotoUpload(event)">
                    <div onclick="document.getElementById('photo-input').click()" class="cursor-pointer py-16 border-2 border-dashed border-slate-700 rounded-3xl hover:border-indigo-500 transition-all opacity-60 hover:opacity-100">
                        <div class="text-5xl mb-4">üñºÔ∏è</div>
                        <p class="font-bold text-lg">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</p>
                        <p class="text-xs text-slate-500 mt-2">‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô.jpg (‡πÄ‡∏ä‡πà‡∏ô 1001.jpg)</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="page-admin-qr-print-tool" class="page">
            <button onclick="showPage('admin-menu')" class="mb-4 font-bold text-slate-400">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
            <div class="glass p-10 text-center">
                <h2 class="text-3xl font-bold mb-8">üñ®Ô∏è ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå QR Code</h2>
                <div class="flex gap-4 justify-center mb-10">
                    <select id="qr-grade-sel" class="p-4 border rounded-2xl min-w-[250px] font-bold"></select>
                    <button onclick="previewQR()" class="px-10 bg-indigo-600 text-white rounded-2xl font-bold shadow-lg shadow-indigo-100">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡πÅ‡∏Å‡∏ô</button>
                </div>
                <div id="qr-preview-box" class="hidden">
                    <button onclick="window.print()" class="w-full py-6 bg-emerald-500 text-white rounded-3xl font-bold text-2xl mb-10 hover:bg-emerald-600 transition-all">üñ®Ô∏è ‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå (A4)</button>
                    <div id="preview-grid" class="grid grid-cols-4 md:grid-cols-6 gap-4 p-6 bg-white border-2 border-slate-100 rounded-3xl"></div>
                </div>
            </div>
        </section>

        <section id="page-std-dashboard" class="page">
            <button onclick="showPage('home')" class="mb-4 font-bold text-slate-400">‚Üê ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            <div class="glass p-8 flex items-center gap-8 mb-8 border-l-[15px] border-indigo-600">
                <img id="std-img" class="w-24 h-24 rounded-3xl object-cover border-4 border-white shadow-xl">
                <div><h2 id="std-name-txt" class="text-4xl font-bold text-slate-800"></h2><p id="std-grade-txt" class="text-indigo-600 text-xl font-bold"></p></div>
            </div>
            <div id="std-subject-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </section>

        <section id="page-std-subject-menu" class="page max-w-6xl mx-auto px-4 py-8">
    <button onclick="showPage('std-dashboard')" class="mb-8 flex items-center gap-2 font-black text-slate-400 hover:text-indigo-600 transition-colors uppercase text-xs tracking-widest">
        <span class="text-lg">‚Üê</span> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
    </button>

    <div class="mb-12">
        <p class="text-indigo-500 font-black text-sm uppercase tracking-[0.3em] mb-2">Subject Menu</p>
        <h2 id="std-menu-sub-title" class="text-6xl font-black text-slate-900 tracking-tighter leading-none italic"></h2>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        
        <button onclick="showStdDoNow()" class="group relative p-10 bg-white border-2 border-slate-100 rounded-[3rem] shadow-sm hover:shadow-2xl hover:-translate-y-2 transition-all duration-300 overflow-hidden text-left">
            <div class="absolute top-0 left-0 w-full h-2 bg-amber-400"></div>
            <div class="w-16 h-16 bg-amber-50 rounded-2xl flex items-center justify-center text-4xl mb-6 group-hover:scale-110 transition-transform">‚ö°</div>
            <h3 class="text-2xl font-black text-slate-800 tracking-tighter mb-2">DO NOW</h3>
            <p class="text-slate-400 text-xs font-bold leading-relaxed">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
        </button>

        <button onclick="showStdScores()" class="group relative p-10 bg-white border-2 border-slate-100 rounded-[3rem] shadow-sm hover:shadow-2xl hover:-translate-y-2 transition-all duration-300 overflow-hidden text-left">
            <div class="absolute top-0 left-0 w-full h-2 bg-indigo-600"></div>
            <div class="w-16 h-16 bg-indigo-50 rounded-2xl flex items-center justify-center text-4xl mb-6 group-hover:scale-110 transition-transform">üèÜ</div>
            <h3 class="text-2xl font-black text-slate-800 tracking-tighter mb-2">SCORES</h3>
            <p class="text-slate-400 text-xs font-bold leading-relaxed">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</p>
        </button>

        <button onclick="showStdPending()" class="group relative p-10 bg-white border-2 border-slate-100 rounded-[3rem] shadow-sm hover:shadow-2xl hover:-translate-y-2 transition-all duration-300 overflow-hidden text-left">
            <div class="absolute top-0 left-0 w-full h-2 bg-rose-500"></div>
            <div class="w-16 h-16 bg-rose-50 rounded-2xl flex items-center justify-center text-4xl mb-6 group-hover:scale-110 transition-transform">üìã</div>
            <h3 class="text-2xl font-black text-slate-800 tracking-tighter mb-2">PENDING</h3>
            <p class="text-slate-400 text-xs font-bold leading-relaxed">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</p>
        </button>

        <button onclick="loadStudentExam()" class="group relative p-10 bg-white border-2 border-slate-100 rounded-[3rem] shadow-sm hover:shadow-2xl hover:-translate-y-2 transition-all duration-300 overflow-hidden text-left">
            <div class="absolute top-0 left-0 w-full h-2 bg-emerald-500"></div>
            <div class="w-16 h-16 bg-emerald-50 rounded-2xl flex items-center justify-center text-4xl mb-6 group-hover:scale-110 transition-transform">üìç</div>
            <h3 class="text-2xl font-black text-slate-800 tracking-tighter mb-2">EXAM</h3>
            <p class="text-slate-400 text-xs font-bold leading-relaxed">‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</p>
        </button>

    </div>
</section>

<section id="page-exam-page" class="page hidden px-4 max-w-4xl mx-auto py-10">
    <div class="bg-white p-8 rounded-[3rem] shadow-xl border border-slate-50">
        <div class="flex justify-between items-center mb-8 border-b pb-6">
            <div>
                <h2 id="student-exam-title" class="text-3xl font-black text-slate-800">‡∏ß‡∏¥‡∏ä‡∏≤: ...</h2>
                <p class="text-slate-400 font-bold">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</p>
            </div>
            <div id="exam-timer" class="text-2xl font-black text-rose-500 bg-rose-50 px-6 py-2 rounded-2xl">
                00:00
            </div>
        </div>

        <div id="student-questions-container" class="space-y-10"></div>

        <button onclick="submitExam()" class="w-full mt-10 bg-emerald-500 text-white p-8 rounded-[2rem] font-black text-2xl shadow-lg shadow-emerald-100 hover:scale-[1.02] transition-all">
            ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô üö©
        </button>
    </div>
</section>

        <section id="page-std-content-view" class="page">
    <button onclick="showPage('std-subject-menu')" class="mb-4 font-bold text-slate-400">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
    <div class="glass p-12 border-t-[20px] border-amber-400">
        <h2 id="content-title" class="text-4xl font-bold mb-10 italic text-amber-600"></h2>
        <div id="content-area" class="text-2xl mb-6"></div>

    </div>
</section>
        
    <section id="page-admin-donow" class="page p-4">
 <button onclick="showPage('admin-menu')" class="mb-4 font-bold text-slate-400">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
    <div class="max-w-md mx-auto bg-white rounded-3xl shadow-xl p-6 border-t-8 border-indigo-600">
        <h2 class="text-2xl font-bold text-indigo-900 mb-4 text-center">üöÄ ‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô Do Now</h2>
        
        <div class="space-y-4">
            <div>
                <label class="text-sm font-bold text-slate-500">1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                <select id="dn-grade" onchange="updateSubFilter(this.value, 'dn-sub')" class="w-full p-3 bg-slate-50 border rounded-2xl outline-none">
                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á --</option>
                    <option value="‡∏°.1/1">‡∏°.1/1</option>
                    <option value="‡∏°.1/2">‡∏°.1/2</option>
                </select>
            </div>

            <div>
                <label class="text-sm font-bold text-slate-500">2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏à‡∏≤‡∏Å Excel</label>
                <select id="dn-sub" class="w-full p-3 bg-slate-50 border rounded-2xl outline-none">
                    <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô --</option>
                </select>
            </div>

            <textarea id="dn-msg" rows="3" class="w-full p-4 bg-slate-50 border rounded-2xl outline-none" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÇ‡∏à‡∏ó‡∏¢‡πå‡πÉ‡∏´‡πâ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô..."></textarea>
            
            <button onclick="saveDoNow(true)" class="w-full bg-emerald-500 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 mb-2">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö</button>

            <div class="flex gap-2">
                <button onclick="saveDoNow(false)" class="flex-1 bg-rose-500 text-white font-bold py-3 rounded-2xl opacity-70">‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö</button>
                <button onclick="monitorAnswers()" class="flex-1 bg-indigo-600 text-white font-bold py-3 rounded-2xl shadow-lg">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
            </div>
        
    </div>
</section>
        
<section id="page-std-donow" class="page p-4">
    <div class="max-w-md mx-auto space-y-6">
        <div class="p-8 bg-amber-50 rounded-3xl border-4 border-dashed border-amber-300 text-center">
            <h3 class="text-amber-600 font-bold mb-2 uppercase text-sm">Do Now Activity</h3>
            <p id="dn-question-text" class="font-bold text-2xl text-amber-800">‡∏£‡∏≠‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏à‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π...</p>
        </div>

        <div class="text-center py-4 bg-white rounded-3xl shadow-sm border border-slate-100">
            <div id="dn-clock" class="text-7xl font-black text-rose-500 mb-1">180</div>
            <p class="text-slate-400 text-xs font-bold uppercase">‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠</p>
        </div>

        <div id="dn-input-section" class="space-y-4">
            <textarea id="std-dn-answer" class="w-full p-5 border-2 border-indigo-100 rounded-3xl outline-none text-lg" rows="3" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì..."></textarea>
            <button onclick="submitDoNowAnswer()" id="btn-dn-submit" class="w-full py-4 bg-indigo-600 text-white rounded-2xl font-bold text-xl shadow-xl active:scale-95">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
        </div>
    </div>
</section>

<section id="page-admin-random" class="page p-4">
    <div class="max-w-2xl mx-auto bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-200">
        <div class="bg-orange-500 p-6 text-white flex justify-between items-center shadow-lg">
            <div>
                <h2 class="text-2xl font-bold flex items-center gap-2">üé≤ ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ä‡∏∑‡πà‡∏≠</h2>
                <p class="text-orange-100 text-sm">‡∏™‡∏∏‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏à‡∏≤‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
            </div>
            <button onclick="showPage('admin-menu')" class="bg-white/20 hover:bg-white/30 px-5 py-2 rounded-2xl transition-all font-bold">
                üè† ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
            </button>
        </div>

        <div class="p-6 bg-orange-50/50 border-b border-orange-100">
            <label class="block text-sm font-bold text-orange-700 mb-2 ml-1">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
            <select id="r-grade" onchange="loadStudentsForRandom(this.value)" class="w-full p-4 rounded-2xl border-2 border-orange-200 text-lg font-bold outline-none focus:border-orange-500 shadow-sm transition-all">
                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏° --</option>
            </select>
            
            <div class="flex gap-3 mt-4">
                <button onclick="selectAllStudents(true)" class="flex-1 bg-white border border-orange-200 py-2.5 rounded-xl text-orange-600 font-bold hover:bg-orange-100 transition-colors">‚úÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                <button onclick="selectAllStudents(false)" class="flex-1 bg-white border border-slate-200 py-2.5 rounded-xl text-slate-500 font-bold hover:bg-slate-100 transition-colors">‚ùå ‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            </div>
        </div>

        <div id="student-selector-list" class="grid grid-cols-2 gap-3 p-6 max-h-[300px] overflow-y-auto bg-white border-b border-slate-100">
            <p class="col-span-2 text-center text-slate-400 py-10 italic">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô... ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</p>
        </div>

        <div class="p-8 bg-slate-50 text-center">
            <div id="display-random-area" class="mb-8 min-h-[140px] flex items-center justify-center bg-white rounded-3xl border-2 border-dashed border-orange-200 shadow-inner">
                <div id="spin-text" class="text-5xl font-black text-orange-600 drop-shadow-sm tracking-tight">? ? ?</div>
            </div>
            
            <div class="mb-6 flex flex-wrap justify-center gap-6 p-4 bg-orange-100/50 rounded-2xl border border-orange-200">
                <label class="flex items-center gap-3 cursor-pointer group">
                    <input type="radio" name="random-mode" value="keep" checked class="w-5 h-5 accent-orange-500">
                    <span class="text-slate-700 font-bold group-hover:text-orange-600 transition-colors">üé≤ ‡πÑ‡∏°‡πà‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠ (‡∏™‡∏∏‡πà‡∏°‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ)</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer group">
                    <input type="radio" name="random-mode" value="remove" class="w-5 h-5 accent-orange-500">
                    <span class="text-slate-700 font-bold group-hover:text-orange-600 transition-colors">üóëÔ∏è ‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å (‡∏™‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)</span>
                </label>
            </div>
            
            <button onclick="startRandomSpin()" class="w-full bg-orange-500 hover:bg-orange-600 text-white text-3xl font-black py-6 rounded-[2.5rem] shadow-xl shadow-orange-200 active:scale-95 transition-all flex items-center justify-center gap-4 border-b-8 border-orange-700">
                <span>üé≤ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏∏‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠!</span>
            </button>
        </div>
    </div>
</section>

<section id="std-content-view" class="page p-4" style="display:none;">
    <div id="content-border" class="max-w-md mx-auto bg-white rounded-3xl shadow-xl border-t-8 p-6 transition-all">
        <div class="flex justify-between items-center mb-6">
            <h2 id="content-title" class="text-2xl font-bold text-slate-800">Title</h2>
            <button onclick="showPage('page-std-subject-menu')" class="text-slate-400 font-bold px-3">‡∏õ‡∏¥‡∏î</button>
        </div>
        
        <div id="content-area" class="space-y-3"></div>
    </div>
</section>

<section id="page-admin-check" class="page p-4">
    <div class="max-w-6xl mx-auto bg-white rounded-[3rem] shadow-2xl overflow-hidden border-4 border-emerald-50">
        <div class="bg-gradient-to-r from-emerald-400 to-teal-500 p-8 text-white flex justify-between items-center">
            <div>
                <h2 class="text-3xl font-black flex items-center gap-3">üì∏ Scan & Check</h2>
                <p class="text-emerald-50 opacity-90">‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</p>
            </div>
            <button onclick="stopCamera(); showPage('admin-menu')" class="bg-white/20 hover:bg-white/40 px-6 py-3 rounded-2xl transition-all font-bold backdrop-blur-sm">üè† ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
        </div>

        <div class="p-6 bg-emerald-50/50 border-b border-emerald-100 flex flex-wrap gap-4 items-end">
            <div class="flex-1 min-w-[200px]">
                <label class="block text-sm font-bold text-emerald-700 mb-2 ml-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                <select id="c-grade" onchange="updateCheckSubjectFilter(this.value)" class="w-full p-4 rounded-2xl border-2 border-emerald-200 outline-none focus:border-emerald-500 shadow-sm transition-all text-lg font-bold text-emerald-800">
                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á --</option>
                </select>
            </div>
            <div class="flex-1 min-w-[200px]">
                <label class="block text-sm font-bold text-emerald-700 mb-2 ml-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à</label>
                <select id="c-subject"(this.value)" class="w-full p-4 rounded-2xl border-2 border-emerald-200 outline-none focus:border-emerald-500 shadow-sm transition-all text-lg font-bold text-emerald-800">
                    <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô --</option>
                </select>
            </div>
            <button onclick="startScanner()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-8 py-4 rounded-2xl font-bold shadow-lg shadow-emerald-200 flex items-center gap-2 transition-all active:scale-95">
                üîã ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô
            </button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-0">
            <div class="p-8 bg-slate-900 flex flex-col items-center justify-center min-h-[400px] relative">
                <div class="absolute top-4 left-4 z-10 bg-emerald-500 text-white px-3 py-1 rounded-full text-xs font-bold animate-pulse">LIVE CAMERA</div>
                
                <div id="scanner-container" class="w-full max-w-sm aspect-square bg-slate-800 rounded-3xl overflow-hidden border-4 border-emerald-500/30 relative">
                    <button onclick="switchCamera()" class="absolute top-4 right-4 z-50 bg-white/20 hover:bg-white/40 backdrop-blur-md p-3 rounded-2xl shadow-lg transition-all active:scale-90 border border-white/20">
                        <span class="text-xl">üîÑ</span>
                    </button>

                    <video id="check-video" class="w-full h-full object-cover"></video>
                    
                    <div class="absolute inset-0 border-[40px] border-black/40 flex items-center justify-center pointer-events-none">
                        <div class="w-full h-full border-2 border-emerald-400 shadow-[0_0_20px_rgba(52,211,153,0.5)]"></div>
                   
                    </div>
                    
                </div>
                
                <div class="w-full max-w-sm flex flex-col gap-3">
            <div class="relative w-full max-w-sm mx-auto mt-4">
    <input type="number" 
           id="manual-id1" 
           class="w-full p-4 bg-slate-800 border-2 border-slate-700 rounded-2xl text-white text-center text-xl font-black focus:border-emerald-500 outline-none" 
           placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."
           autocomplete="off">
           
    <button type="button" 
            onclick="checkByInput()" 
            class="absolute right-2 top-2 bottom-2 px-6 bg-emerald-500 hover:bg-emerald-600 text-slate-900 rounded-xl font-black transition-all active:scale-95 shadow-lg">
        OK
    </button>
</div>
            <p class="text-slate-400 text-xs text-center italic">‡∏Å‡∏î OK ‡∏´‡∏£‡∏∑‡∏≠ Enter ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
        </div>
        
                <p class="mt-6 text-slate-400 text-sm italic">‡∏ß‡∏≤‡∏á QR Code ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏£‡∏≠‡∏ö</p>
            </div>

            <div class="p-8 bg-white border-l border-emerald-100 overflow-y-auto max-h-[600px]">
                <div id="student-result-card" class="hidden animate__animated animate__fadeInRight">
    <div class="flex flex-col sm:flex-row items-center gap-6 mb-6 bg-white p-8 rounded-[3rem] shadow-xl border-4 border-emerald-100">
        <div class="relative group">
            <div class="w-40 h-40 rounded-[2.5rem] overflow-hidden border-4 border-emerald-400 shadow-lg">
                <img id="student-photo" src="" class="w-full h-full object-cover bg-slate-100">
            </div>
            <div class="absolute -bottom-2 -right-2 bg-emerald-500 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg border-4 border-white">
                <span class="text-xl">‚úÖ</span>
            </div>
        </div>

        <div class="text-center sm:text-left">
            <span id="res-code" class="inline-block px-4 py-1 bg-emerald-100 text-emerald-700 rounded-full text-sm font-black mb-3 uppercase tracking-widest">‡∏£‡∏´‡∏±‡∏™: -</span>
            <h3 id="res-name" class="text-3xl font-black text-slate-800 mb-2">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</h3>
            <p id="res-nick" class="text-xl text-emerald-500 font-bold">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô: -</p>
            
            <div class="mt-4 flex items-center justify-center sm:justify-start gap-2 text-emerald-600 font-bold">
                <span class="relative flex h-3 w-3">
                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                  <span class="relative inline-flex rounded-full h-3 w-3 bg-emerald-500"></span>
                </span>
                ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß
            </div>
        </div>
    </div>
</div>

                </div>

                <div id="scan-placeholder" class="h-full flex flex-col items-center justify-center text-slate-300 py-20">
                    <p class="text-sm">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á/‡∏ß‡∏¥‡∏ä‡∏≤ ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</p>
                </div>
            </div>
        </div>

        <div class="p-6 bg-slate-50 border-t border-emerald-100">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
        <h4 class="text-2xl font-black text-slate-800 flex items-center gap-2">
            <span class="bg-emerald-500 text-white p-2 rounded-xl text-sm">üìã</span>
            ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡πâ‡∏≠‡∏á <span id="display-selected-grade" class="text-emerald-600">-</span>
        </h4>
        <div class="flex gap-3 font-bold bg-white p-3 rounded-2xl shadow-sm border border-slate-100">
            <div class="px-4 border-r border-slate-100 text-center">
                <p class="text-[10px] text-slate-400 uppercase">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                <p id="total-std" class="text-lg text-slate-700">0</p>
            </div>
            <div class="px-4 border-r border-slate-100 text-center">
                <p class="text-[10px] text-emerald-400 uppercase">‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</p>
                <p id="total-sent" class="text-lg text-emerald-600">0</p>
            </div>
            <div class="px-4 text-center">
                <p class="text-[10px] text-rose-400 uppercase">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á</p>
                <p id="total-remain" class="text-lg text-rose-500">0</p>
            </div>
        </div>
    </div>
    
    <div id="student-checklist-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        </div>
</div>
    

        <div class="p-6 bg-slate-50 border-t flex justify-between items-center">
            <p class="text-slate-500 text-sm">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö Cloud ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
            <button onclick="exportCheckToExcel()" class="bg-slate-800 hover:bg-black text-white px-6 py-3 rounded-2xl font-bold flex items-center gap-2 shadow-lg transition-all">
                üìä Export ‡πÄ‡∏õ‡πá‡∏ô Excel (.xlsx)
            </button>
        </div>
    </div>
</section>

<section id="page-admin-exam" class="page px-4 max-w-6xl mx-auto py-8">
    <div class="flex items-center justify-between mb-8">
        <div class="flex items-center gap-4">
            <button onclick="showPage('admin-menu')" class="w-12 h-12 bg-white shadow-sm flex items-center justify-center rounded-2xl text-xl border border-slate-100 hover:bg-slate-50 transition-all">‚¨ÖÔ∏è</button>
            <div>
                <h2 class="text-3xl font-black text-slate-800 tracking-tighter">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≠‡∏ö</h2>
                <p class="text-slate-400 text-sm font-bold">Dashboard ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</p>
            </div>
        </div>
        
        <div class="flex gap-3 bg-white p-2 rounded-[1.5rem] shadow-sm border border-slate-100">
            <button onclick="viewScores()" class="flex items-center gap-2 bg-amber-50 text-amber-600 px-5 py-3 rounded-xl font-black hover:bg-amber-100 transition-all text-sm">
                üìä ‡∏î‡∏π‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
            </button>
            <button id="btn-toggle-exam" onclick="toggleExamStatus()" class="flex items-center gap-2 bg-emerald-500 text-white px-5 py-3 rounded-xl font-black shadow-lg shadow-emerald-100 transition-all text-sm">
                <span>üü¢</span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏≠‡∏ö
            </button>
        </div>
    </div>

    <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100 mb-8">
        <div class="grid grid-cols-1 md:grid-cols-12 gap-6 items-end">
            <div class="md:col-span-3">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-3 block ml-1">1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                <select id="select-grade" onchange="filterSubjectsByGrade()" class="w-full p-4 bg-slate-50 border-2 border-transparent rounded-2xl font-bold text-slate-800 focus:border-indigo-500 focus:bg-white outline-none transition-all">
                    <option value="">--- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ---</option>
                </select>
            </div>
            <div class="md:col-span-4">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-3 block ml-1">2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤</label>
                <select id="select-subject" onchange="showImportMethods()" class="w-full p-4 bg-slate-50 border-2 border-transparent rounded-2xl font-bold text-slate-800 focus:border-indigo-500 focus:bg-white outline-none transition-all disabled:opacity-50" disabled>
                    <option value="">--- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô ---</option>
                </select>
            </div>
            <div class="md:col-span-5">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-3 block ml-1">3. ‡∏ß‡∏¥‡∏ò‡∏µ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</label>
                <div id="method-options" class="flex gap-2 opacity-50 pointer-events-none transition-all">
                    <button onclick="preparePasteMode()" class="flex-1 bg-indigo-600 text-white p-4 rounded-2xl font-black text-sm hover:shadow-lg hover:shadow-indigo-100 transition-all shadow-md">üìù ‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà</button>
                    <button onclick="loadExamDataDirect()" class="flex-1 bg-white border-2 border-slate-100 text-slate-600 p-4 rounded-2xl font-black text-sm hover:bg-slate-50 transition-all">‚öôÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÄ‡∏î‡∏¥‡∏°</button>
                </div>
            </div>
        </div>
    </div>

    <div id="exam-work-area" class="hidden animate-in fade-in duration-500">
        <div id="paste-section" class="hidden space-y-4">
            <div class="flex items-center gap-3 bg-amber-50 p-5 rounded-3xl border border-amber-100">
                <span class="text-2xl">üí°</span>
                <p class="text-amber-700 text-sm font-bold leading-relaxed">
                    ‡∏ß‡∏≤‡∏á‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏Ç‡πâ‡∏≠ (1. 2. 3.) ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡∏Å. ‡∏Ç. ‡∏Ñ. ‡∏á.) ‡∏£‡∏∞‡∏ö‡∏ö Smart AI ‡∏à‡∏∞‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                </p>
            </div>
            
            <div class="relative group">
                <textarea id="main-paste-area" 
                    class="w-full h-80 p-8 bg-white border-2 border-dashed border-slate-200 rounded-[3rem] outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-50 transition-all font-sans text-lg leading-relaxed shadow-inner" 
                    placeholder="‡∏ß‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å Word ‡∏´‡∏£‡∏∑‡∏≠ PDF ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
                <div class="absolute bottom-6 right-6 text-slate-300 font-bold pointer-events-none group-focus-within:hidden">
                    Paste content here...
                </div>
            </div>

            <button onclick="processSmartPaste()" class="w-full bg-slate-900 text-white p-7 rounded-[2.5rem] font-black text-xl shadow-2xl shadow-slate-200 hover:bg-indigo-600 hover:scale-[1.01] active:scale-95 transition-all flex items-center justify-center gap-3">
                <span>‚ö°</span> ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            </button>
        </div>
    </div>

    <div id="preview-section" class="hidden mt-12 space-y-8 pb-20">
        <div class="flex items-center justify-between border-b border-slate-200 pb-6">
            <div>
                <h3 class="text-2xl font-black text-slate-800">üìã ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</h3>
                <p class="text-slate-400 font-bold text-sm">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ç‡πâ‡∏≠</p>
            </div>
            <button onclick="saveAllQuestions()" class="bg-emerald-500 text-white px-10 py-4 rounded-[1.5rem] font-black shadow-xl shadow-emerald-100 hover:scale-105 active:scale-95 transition-all flex items-center gap-2 text-lg">
                üöÄ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            </button>
        </div>

        <div id="questions-list" class="grid grid-cols-1 gap-6">
            </div>
    </div>
</section>


    </main>

    <div id="print-layout" class="hidden print-area">
        <div id="qr-print-grid" class="grid grid-cols-4 gap-4 p-8"></div>
    </div>

    <script>
        
        
        // --- 1. FIREBASE & STATE ---
        const config = { apiKey: "AIzaSyAJhpfPS7TCe3N1n6oWpFsWVQ7ipocv4kg", authDomain: "classroom-9813f.firebaseapp.com", databaseURL: "https://classroom-9813f-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "classroom-9813f" };
        firebase.initializeApp(config);
        const db = firebase.database();
        let students = [], currentSid = null, currentSub = null, currentSes = null, html5Qr = null, rawXL = null;

        db.ref('students').on('value', snap => { students = snap.val() ? Object.values(snap.val()) : []; updateSelectMenus(); });

        function showPage(p) {
            document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
            document.getElementById(`page-${p}`).classList.add('active');
            if(p === 'admin-monitor') startGlobalMonitor();
        }

        async function authAdmin() {
            const { value: pw } = await Swal.fire({ title: 'Teacher Security', input: 'password', confirmButtonColor: '#4f46e5' });
            if (pw === "1234") showPage('admin-menu');
        }

        // --- 2. MASTER DATA & PHOTOS ---
        function loadExcel(e) {
    const r = new FileReader(); 
    r.readAsBinaryString(e.target.files[0]);
    r.onload = (evt) => {
        const wb = XLSX.read(evt.target.result, { type: 'binary' });
        rawXL = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        const heads = Object.keys(rawXL[0]);
        document.getElementById('map-ui').classList.remove('hidden');
        
        // ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ ID ‡∏Ç‡∏≠‡∏á select ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á Excel ‡∏•‡∏á‡πÑ‡∏õ
        const selectors = ['m-id','m-name','m-surname','m-nickname','m-grade'];
        selectors.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.innerHTML = heads.map(h => `<option value="${h}">${h}</option>`).join('');
        });
    };
}

        async function saveMasterData() {
    // 1. ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Dropdown
    const cI = document.getElementById('m-id').value;
    const cN = document.getElementById('m-name').value;
    const cS = document.getElementById('m-surname').value;
    const cNk = document.getElementById('m-nickname').value;
    const cG = document.getElementById('m-grade').value;

    const data = rawXL.map(row => {
        const id = row[cI]?.toString().trim(); 
        if(!id) return null;

        // 2. ‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡∏ä‡∏≤ (‡πÄ‡∏≠‡∏≤‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà 5 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏´‡∏•‡∏±‡∏Å ‡πÅ‡∏•‡∏∞ ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà/‡∏•‡∏≥‡∏î‡∏±‡∏ö)
        const subs = {}; 
        const mainKeys = [cI, cN, cS, cNk, cG, "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà", "‡∏•‡∏≥‡∏î‡∏±‡∏ö"];
        
        Object.keys(row).forEach(k => {
            if (!mainKeys.includes(k)) {
                subs[k] = row[k] || ""; // ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤
            }
        });

        return { 
            id: id, 
            name: `${row[cN]} ${row[cS]}`, // ‡∏£‡∏ß‡∏°‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢‡πÜ
            firstName: row[cN],
            lastName: row[cS],
            nickname: row[cNk],
            grade: row[cG]?.toString(), 
            subjects: subs, 
            photo: ""
        };
    }).filter(d => d);

    // 3. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firebase
    try {
        await db.ref('students').set(data); 
        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 5 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
    } catch (error) {
        Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
    }
}

        async function handlePhotoUpload(e) {
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û...', didOpen: () => Swal.showLoading() });
            for(let f of Array.from(e.target.files)) {
                const sid = f.name.split('.')[0].trim();
                const idx = students.findIndex(s => s.id === sid);
                if(idx !== -1) students[idx].photo = await resizeImg(f);
            }
            await db.ref('students').set(students); Swal.close(); Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }

        function resizeImg(f) {
            return new Promise(r => {
                const rd = new FileReader(); rd.readAsDataURL(f);
                rd.onload = (e) => {
                    const i = new Image(); i.src = e.target.result;
                    i.onload = () => {
                        const c = document.createElement('canvas'); c.width = 300; c.height = (i.height*300)/i.width;
                        c.getContext('2d').drawImage(i,0,0,300,c.height); r(c.toDataURL('image/jpeg', 0.8));
                    }
                }
            });
        }

        // --- 3. TEACH & SCANNER ---
        function createSession() {
            const gr = document.getElementById('t-grade').value, sub = document.getElementById('t-sub').value, dt = document.getElementById('t-date').value;
            if(!gr || !sub || !dt) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö');
            const id = Date.now();
            const data = { id, grade: gr, subject: sub, date: dt, start: document.getElementById('t-start').value, end: document.getElementById('t-end').value, fullDate: new Date(dt).toLocaleDateString('th-TH', { dateStyle: 'long' }) };
            db.ref(`sessions/${id}`).set(data); db.ref(`global/activeSessionID`).set(id);
            currentSes = data; document.getElementById('ses-label').innerHTML = `üî¥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô: <span class="text-indigo-600 font-black underline">${sub} [‡∏´‡πâ‡∏≠‡∏á ${gr}]</span>`;
        }

        async function toggleScanner(on) {
    if(!currentSes) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° [‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö Global Sync] ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πÅ‡∏Å‡∏ô', 'warning');
    
    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Path ‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤
    const cleanGr = currentSes.grade.replace(/[.#$[\]]/g, "_");
    const cleanSub = currentSes.subject.replace(/[.#$[\]]/g, "_");
    const aid = currentSes.id;

    if(on) {
        // ‡∏•‡πâ‡∏≤‡∏á Instance ‡πÄ‡∏Å‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà
        if(html5Qr) { try { await html5Qr.clear(); } catch(e) {} }
        
        html5Qr = new Html5Qrcode("reader");
        document.getElementById('btn-on').disabled = true; 
        document.getElementById('btn-off').disabled = false;
        
        // config ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏Å‡∏±‡∏ö Samsung (‡πÄ‡∏û‡∏¥‡πà‡∏° focusMode)
        const config = { 
            fps: 20, 
            qrbox: { width: 250, height: 250 }, 
            aspectRatio: 1.0,
            videoConstraints: { focusMode: "continuous" } 
        };

        html5Qr.start({ facingMode: "environment" }, config, async (code) => {
            // --- [1] ‡∏´‡∏¢‡∏∏‡∏î‡∏™‡πÅ‡∏Å‡∏ô‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≠ QR ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏†‡∏≤‡∏£‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ---
            html5Qr.pause(true); 

            const sid = code.trim(); 
            const std = students.find(s => String(s.id) === sid);
            
            // --- [2] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
            if(!std) {
                if(window.soundError) soundError.play();
                await Swal.fire({ title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™!', icon: 'error', timer: 1500, showConfirmButton: false });
                html5Qr.resume(); // ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏™‡πÅ‡∏Å‡∏ô‡∏ï‡πà‡∏≠
                return;
            }

            if(std.grade !== currentSes.grade) {
                if(window.soundError) soundError.play();
                await Swal.fire({ 
                    title: '‡∏ú‡∏¥‡∏î‡∏´‡πâ‡∏≠‡∏á!', 
                    text: `${std.name} ‡∏≠‡∏¢‡∏π‡πà‡∏´‡πâ‡∏≠‡∏á ${std.grade}`, 
                    icon: 'warning', 
                    timer: 1500, 
                    showConfirmButton: false 
                });
                html5Qr.resume();
                return;
            }

            // --- [3] ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firebase ---
            const now = new Date(); 
            const timeStr = now.toLocaleTimeString('th-TH', { hour:'2-digit', minute:'2-digit' });
            const [sH, sM] = currentSes.start.split(':'); 
            const startTime = new Date(currentSes.date); 
            startTime.setHours(parseInt(sH), parseInt(sM), 0);
            const status = ((now - startTime) / 60000) > 15 ? "‡∏™‡∏≤‡∏¢" : "‡∏°‡∏≤";
            
            try {
                await db.ref(`attendance/${cleanGr}/${cleanSub}/${aid}/${std.id}`).set({ 
                    name: std.name, 
                    time: timeStr, 
                    status: status 
                });

                // --- [4] ‡πÅ‡∏™‡∏î‡∏á Pop-up ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô) ---
                if(window.soundSuccess) soundSuccess.play();
                
                await Swal.fire({
                    title: `<span class="${status === '‡∏°‡∏≤' ? 'text-emerald-600' : 'text-amber-500'} font-black text-3xl">${status === "‡∏°‡∏≤" ? "‚úÖ ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" : "‚è≥ ‡∏°‡∏≤‡∏™‡∏≤‡∏¢"}</span>`,
                    html: `
                        <div class="flex flex-col items-center mt-2">
                            <img src="${std.photo || `https://api.dicebear.com/7.x/initials/svg?seed=${std.id}`}" 
                                 class="w-56 h-56 rounded-[2.5rem] object-cover border-8 border-white shadow-2xl mb-4">
                            <div class="text-4xl font-black text-slate-800">${std.name}</div>
                            <div class="text-xl font-bold text-slate-400 mt-1">‡πÄ‡∏ß‡∏•‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ${timeStr}</div>
                        </div>`,
                    timer: 2000,
                    timerProgressBar: true,
                    showConfirmButton: false,
                    backdrop: `rgba(0,0,0,0.4)`
                });

            } catch (err) {
                console.error("Save Error:", err);
            }

            // --- [5] ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Pop-up ‡∏´‡∏≤‡∏¢‡πÑ‡∏õ ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡∏Ñ‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ ---
            html5Qr.resume();

        }).catch(err => {
            console.error("Camera Error:", err);
            Swal.fire('‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á', '‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏ä‡πâ Chrome/Samsung Internet ‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏•‡πâ‡∏≠‡∏á (HTTPS)', 'error');
            document.getElementById('btn-on').disabled = false;
        });
    } else { 
        if(html5Qr) {
            html5Qr.stop().then(() => { 
                document.getElementById('btn-on').disabled = false; 
                document.getElementById('btn-off').disabled = true; 
            }).catch(e => console.error("Stop Error:", e));
        }
    }
}

// --- 2. ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏à‡∏≠‡∏°‡∏≠‡∏ô‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå (Monitor Pop-up) ---
function startGlobalMonitor() {
    db.ref(`global/activeSessionID`).on('value', snap => {
        const aid = snap.val(); if(!aid) return;
        
        db.ref(`sessions/${aid}`).once('value', sSnap => {
            const ses = sSnap.val(); if(!ses) return;

            const cleanGr = ses.grade.replace(/[.#$[\]]/g, "_");
            const cleanSub = ses.subject.replace(/[.#$[\]]/g, "_");

            // ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡∏ö Real-time
            db.ref(`attendance/${cleanGr}/${cleanSub}/${aid}`).on('value', aSnap => {
                const att = aSnap.val() || {};
                const room = students.filter(s => s.grade === ses.grade).sort((a,b) => a.id - b.id);
                
                let p=0, l=0, a=0, html="";
                room.forEach(s => {
                    const d = att[s.id];
                    let cls = "bg-rose-50 text-rose-600 border-rose-100", stTxt = "‡∏Ç‡∏≤‡∏î", tTxt = "-";
                    if(d) {
                        if(d.status === "‡∏™‡∏≤‡∏¢") { cls="bg-amber-50 text-amber-800"; stTxt="‡∏™‡∏≤‡∏¢"; l++; }
                        else { cls="bg-emerald-50 text-emerald-800"; stTxt="‡∏°‡∏≤"; p++; }
                        tTxt = d.time;
                    } else a++;

                    html += `
                        <div class="flex items-center p-3 rounded-2xl border ${cls}">
                            <img src="${s.photo || `https://api.dicebear.com/7.x/initials/svg?seed=${s.id}`}" class="w-16 h-16 rounded-xl mr-4 object-cover">
                            <div><div class="font-black text-lg">${s.name}</div><div class="text-xs">${stTxt} ${tTxt}</div></div>
                        </div>`;
                });
                document.getElementById('monitor-grid').innerHTML = html;
            });

            // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ Pop-up ‡πÄ‡∏î‡πâ‡∏á‡∏ö‡∏ô‡∏à‡∏≠‡∏°‡∏≠‡∏ô‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏ç‡πà ---
            db.ref(`attendance/${cleanGr}/${cleanSub}/${aid}`).limitToLast(1).on('child_added', (snapshot) => {
                const studentId = snapshot.key;
                const data = snapshot.val();
                const std = students.find(x => x.id === studentId);
                
                if (std && data) {
                    Swal.fire({
                        title: `<div class="text-4xl font-black text-emerald-600">‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>`,
                        html: `
                            <div class="p-4">
                                <img src="${std.photo || `https://api.dicebear.com/7.x/initials/svg?seed=${std.id}`}" class="w-64 h-64 mx-auto rounded-[3rem] object-cover border-8 border-white shadow-2xl mb-6">
                                <div class="text-5xl font-black mb-2">${std.name}</div>
                                <div class="text-2xl text-slate-500 font-bold">‡πÄ‡∏ß‡∏•‡∏≤: ${data.time}</div>
                            </div>`,
                        timer: 2500,
                        showConfirmButton: false,
                        backdrop: `rgba(0,123,255,0.2)`
                    });
                }
            });
        });
    });
}

        // --- 4. LIVE MONITOR ---
        function startGlobalMonitor() {
        db.ref(`global/activeSessionID`).on('value', snap => {
        const aid = snap.val(); 
        if(!aid) {
            document.getElementById('mon-sub-title').innerText = "‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...";
            return;
        }
        
        db.ref(`sessions/${aid}`).once('value', sSnap => {
            const ses = sSnap.val();
            if(!ses) return;

            document.getElementById('mon-sub-title').innerText = "‡∏ß‡∏¥‡∏ä‡∏≤: " + ses.subject;
            document.getElementById('mon-ses-info').innerText = `‡∏´‡πâ‡∏≠‡∏á ${ses.grade} | ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${ses.fullDate || ses.date}`;

            const cleanGr = ses.grade.replace(/[.#$[\]]/g, "_");
            const cleanSub = ses.subject.replace(/[.#$[\]]/g, "_");

            db.ref(`attendance/${cleanGr}/${cleanSub}/${aid}`).on('value', aSnap => {
                const att = aSnap.val() || {};
                const room = students.filter(s => s.grade === ses.grade).sort((a,b) => (a.id || 0) - (b.id || 0));
                
                let p=0, l=0, a=0, html="";

                room.forEach(s => {
                    const d = att[s.id];
                    let cls = "bg-rose-50 border-rose-200 text-rose-700"; // ‡∏Ç‡∏≤‡∏î
                    let statusTxt = "‚ùå ‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô";
                    let timeTxt = "--:--";
                    
                    if(d) {
                        if(d.status === "‡∏™‡∏≤‡∏¢") {
                            cls = "bg-amber-50 border-amber-300 text-amber-800";
                            statusTxt = "‚è≥ ‡∏°‡∏≤‡∏™‡∏≤‡∏¢";
                            l++;
                        } else {
                            cls = "bg-emerald-50 border-emerald-300 text-emerald-800";
                            statusTxt = "‚úÖ ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô";
                            p++;
                        }
                        timeTxt = d.time || "";
                    } else { a++; }

                    // --- ‡∏õ‡∏£‡∏±‡∏ö UI ‡πÄ‡∏õ‡πá‡∏ô 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (‡∏£‡∏π‡∏õ‡∏ã‡πâ‡∏≤‡∏¢ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏ß‡∏≤) ---
                    html += `
                        <div class="flex items-center p-4 rounded-3xl border-2 shadow-sm transition-all ${cls}">
                            <div class="flex-shrink-0 mr-6">
                                <img src="${s.photo || `https://api.dicebear.com/7.x/initials/svg?seed=${s.id}`}" 
                                     class="w-32 h-32 rounded-2xl object-cover border-4 border-white shadow-md">
                            </div>
                            
                            <div class="flex-grow overflow-hidden">
                                <div class="text-3xl font-black truncate">${s.name}</div>
                                <div class="text-xl font-bold opacity-70 mb-2">ID: ${s.id}</div>
                                <div class="inline-flex items-center px-4 py-1 rounded-full bg-white bg-opacity-60">
                                    <span class="text-2xl font-black uppercase">${statusTxt}</span>
                                    <span class="ml-3 text-lg font-bold opacity-80">${timeTxt}</span>
                                </div>
                            </div>
                        </div>`;
                });

                // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Grid ‡πÄ‡∏õ‡πá‡∏ô 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (‡∏ö‡∏ô‡∏Ñ‡∏≠‡∏°)
                const grid = document.getElementById('monitor-grid');
                grid.className = "grid grid-cols-1 xl:grid-cols-2 gap-6 p-6"; 
                grid.innerHTML = html;
                
                document.getElementById('mon-count-present').innerText = p;
                document.getElementById('mon-count-late').innerText = l;
                document.getElementById('mon-count-absent').innerText = a;
            });
        });
    });
}

        // --- 5. SCORE & TRACKING (NEW VERSION) ---
let tempColsPre = [];  // ‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ
let tempColsPost = []; // ‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Modal ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏•‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
function openBulkAddModal(type) {
    const typeText = type === 'pre' ? '‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ' : '‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ';
    Swal.fire({
        title: `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô (${typeText})`,
        html: `
            <div class="text-left space-y-3 p-2">
                <p class="text-[10px] font-bold text-slate-400 uppercase">‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏° (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏à‡∏∏‡∏•‡∏†‡∏≤‡∏Ñ ,)</p>
                <textarea id="bulk-tasks" class="w-full p-4 border-2 border-slate-100 rounded-2xl h-40 font-bold text-sm" 
                    placeholder="‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà 1, 10&#10;‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà 2, 10&#10;‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏¢‡πà‡∏≠‡∏¢, 20"></textarea>
                <p class="text-[10px] text-rose-400">* 1 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î ‡∏Ñ‡∏∑‡∏≠ 1 ‡∏á‡∏≤‡∏ô (‡πÄ‡∏ä‡πà‡∏ô: ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á, ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)</p>
            </div>
        `,
        confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
        showCancelButton: true,
        confirmButtonColor: '#10b981',
        preConfirm: () => {
            const text = document.getElementById('bulk-tasks').value;
            if (!text) return Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
            return text;
        }
    }).then((result) => {
        if (result.isConfirmed) {
            const lines = result.value.split('\n');
            lines.forEach(line => {
                const parts = line.split(',');
                if (parts.length >= 2) {
                    const title = parts[0].trim();
                    const max = parseInt(parts[1].trim()) || 10;
                    if (type === 'pre') tempColsPre.push({ title, max });
                    else tempColsPost.push({ title, max });
                }
            });
            renderTemplateSetup(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            renderStructureList(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö
            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô ${lines.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`, 'success');
        }
    });
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö
function renderStructureList() {
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π‡πÄ‡∏´‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏•‡∏ö‡πÑ‡∏î‡πâ
    renderTemplateSetup(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á
}

// 1 & 2. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤ ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
function showMethodSelection() {
    const sub = document.getElementById('sc-sub').value;
    if(sub) {
        document.getElementById('method-selection').classList.remove('hidden');
    }
}

// 3. ‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå ‡∏´‡∏£‡∏∑‡∏≠ Template
function switchScoreMode(mode) {
    document.getElementById('config-link-area').classList.add('hidden');
    document.getElementById('config-template-area').classList.add('hidden');
    document.getElementById('score-preview-container').classList.add('hidden');

    if(mode === 'link') {
        document.getElementById('config-link-area').classList.remove('hidden');
    } else {
        document.getElementById('config-template-area').classList.remove('hidden');
        renderTemplateSetup();
    }
}

// 5. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Template
function addTemplateColumn(type) {
    Swal.fire({
        title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô',
        html: `
            <input id="swal-title" class="swal2-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ (‡πÄ‡∏ä‡πà‡∏ô ‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà 1)">
            <input id="swal-max" type="number" class="swal2-input" placeholder="‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏°">
        `,
        confirmButtonText: '‡πÄ‡∏û‡∏¥‡πà‡∏°',
        showCancelButton: true
    }).then((result) => {
        if (result.isConfirmed) {
            const title = document.getElementById('swal-title').value || '‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏°‡πà';
            const max = parseInt(document.getElementById('swal-max').value) || 10;
            if(type === 'pre') tempColsPre.push({title, max});
            else tempColsPost.push({title, max});
            renderTemplateSetup();
        }
    });
}

// ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Render ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏¥‡∏°)
function renderTemplateSetup() {
    const h1 = document.getElementById('temp-head-1');
    const h2 = document.getElementById('temp-head-2');
    
    let html1 = `<th rowspan="2" class="p-4 border border-slate-700 bg-slate-800">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>`;
    let html2 = "";

    // ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ
    tempColsPre.forEach((c, i) => {
        html1 += `
            <th class="p-2 border border-slate-700 bg-emerald-600 text-center relative group">
                <div class="text-[10px]">${c.title}</div>
                <button onclick="removeTask('pre', ${i})" class="absolute -top-1 -right-1 bg-rose-500 text-white w-4 h-4 rounded-full text-[8px] opacity-0 group-hover:opacity-100 transition-all">√ó</button>
            </th>`;
        html2 += `<th class="p-1 border border-slate-700 bg-slate-800 text-center text-emerald-400 font-bold">(${c.max})</th>`;
    });

    // ‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ (‡∏•‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)
    html1 += `<th class="p-2 border border-slate-700 bg-amber-500 text-center">‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ</th>`;
    html2 += `<th class="p-1 border border-slate-700 bg-slate-800 text-center text-amber-400 font-bold">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th>`;

    // ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ
    tempColsPost.forEach((c, i) => {
        html1 += `
            <th class="p-2 border border-slate-700 bg-emerald-600 text-center relative group">
                <div class="text-[10px]">${c.title}</div>
                <button onclick="removeTask('post', ${i})" class="absolute -top-1 -right-1 bg-rose-500 text-white w-4 h-4 rounded-full text-[8px] opacity-0 group-hover:opacity-100 transition-all">√ó</button>
            </th>`;
        html2 += `<th class="p-1 border border-slate-700 bg-slate-800 text-center text-emerald-400 font-bold">(${c.max})</th>`;
    });

    // ‡∏õ‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏Ñ (‡∏•‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)
    html1 += `<th class="p-2 border border-slate-700 bg-rose-500 text-center">‡∏õ‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏Ñ</th>`;
    html2 += `<th class="p-1 border border-slate-700 bg-slate-800 text-center text-rose-400 font-bold">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th>`;
    
    html1 += `<th rowspan="2" class="p-2 border border-slate-700 bg-indigo-600 text-center">‡∏£‡∏ß‡∏°/‡πÄ‡∏Å‡∏£‡∏î</th>`;

    h1.innerHTML = html1;
    h2.innerHTML = html2;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ä‡∏¥‡πâ‡∏ô
function removeTask(type, index) {
    if (type === 'pre') {
        tempColsPre.splice(index, 1);
    } else {
        tempColsPost.splice(index, 1);
    }
    renderTemplateSetup();
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á (Template) ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡∏´‡πâ‡∏≠‡∏á
async function saveTemplateStructure() {
    const sub = document.getElementById('sc-sub').value;
    if (!sub) return Swal.fire('‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤');

    const structure = {
        pre: tempColsPre,
        post: tempColsPost,
        lastUpdated: new Date().getTime()
    };

    try {
        await db.ref(`score_templates/${sub}`).set(structure);
        Swal.fire({
            icon: 'success',
            title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢',
            text: '‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏Å‡∏±‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÉ‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ',
            timer: 2000
        });
    } catch (e) {
        Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ', 'error');
    }
}
function addTaskRow(type, title = '', max = 10) {
    const container = document.getElementById(`${type}-task-container`);
    const rowId = Date.now() + Math.random(); // ‡∏™‡∏£‡πâ‡∏≤‡∏á ID ‡∏™‡∏∏‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ï‡∏≠‡∏ô‡∏•‡∏ö
    
    const div = document.createElement('div');
    div.className = "flex items-center gap-2 animate-in fade-in slide-in-from-left duration-300";
    div.id = `row-${rowId}`;
    
    div.innerHTML = `
        <div class="flex-1 bg-slate-50 p-1 rounded-2xl flex items-center border border-slate-100 shadow-sm">
            <input type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤/‡∏á‡∏≤‡∏ô" value="${title}" 
                   class="task-title w-full p-3 bg-transparent border-none font-bold text-slate-700 outline-none">
        </div>
        <div class="w-24 bg-slate-50 p-1 rounded-2xl flex items-center border border-slate-100 shadow-sm">
            <input type="number" placeholder="‡πÄ‡∏ï‡πá‡∏°" value="${max}" 
                   class="task-max w-full p-3 bg-transparent border-none font-black text-center text-indigo-500 outline-none">
        </div>
        <button onclick="removeTaskRow('row-${rowId}')" 
                class="w-12 h-12 flex items-center justify-center bg-rose-50 text-rose-500 rounded-2xl hover:bg-rose-500 hover:text-white transition-all shadow-sm">
            <span class="text-xl">√ó</span>
        </button>
    `;
    
    container.appendChild(div);
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡∏á‡∏≤‡∏ô
function removeTaskRow(rowId) {
    const row = document.getElementById(rowId);
    if (row) {
        row.classList.add('animate-out', 'fade-out', 'slide-out-to-right', 'duration-300');
        setTimeout(() => row.remove(), 250);
    }
}
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å Template
async function confirmCopyTemplate() {
    const targetGrade = document.getElementById('copy-grade').value;
    const targetSub = document.getElementById('copy-sub').value;

    // 1. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
    if (!targetGrade || !targetSub) {
        return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ä‡∏≤‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á', 'warning');
    }

    // 2. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏π‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    const currentTemplate = {
        pre: [],
        post: [],
        midMax: parseInt(document.getElementById('mid-max').value) || 20,
        finalMax: parseInt(document.getElementById('final-max').value) || 30
    };

    // ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ (‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ class ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á Input)
    document.querySelectorAll('#pre-task-container .task-title').forEach((el, i) => {
        const maxVal = document.querySelectorAll('#pre-task-container .task-max')[i].value;
        if (el.value.trim()) currentTemplate.pre.push({ title: el.value, max: parseInt(maxVal) || 0 });
    });

    document.querySelectorAll('#post-task-container .task-title').forEach((el, i) => {
        const maxVal = document.querySelectorAll('#post-task-container .task-max')[i].value;
        if (el.value.trim()) currentTemplate.post.push({ title: el.value, max: parseInt(maxVal) || 0 });
    });

    // 3. ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å
    const result = await Swal.fire({
        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å?',
        text: `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ß‡∏¥‡∏ä‡∏≤ ${targetSub} (${targetGrade})`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
    });

    if (result.isConfirmed) {
        try {
            // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Path ‡πÉ‡∏´‡πâ‡∏™‡∏±‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏õ‡∏ó‡∏µ‡πà score_templates > ‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤ > ‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
            await db.ref('score_templates').child(targetSub).child(targetGrade).set(currentTemplate);
            
            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
        } catch (error) {
            console.error("Firebase Error:", error);
            Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', `‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏: ${error.message}`, 'error');
        }
    }
}

// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ï‡∏¥‡∏°‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô select ‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
function initCopyFilter() {
    const copyGradeSelect = document.getElementById('copy-grade');
    // ‡∏î‡∏∂‡∏á‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà (‡πÄ‡∏ä‡πà‡∏ô grades[])
    if (typeof grades !== 'undefined') {
        copyGradeSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>' + 
            grades.map(g => `<option value="${g}">${g}</option>`).join('');
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á Preview ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á
function generateTemplatePreview() {
    const grade = document.getElementById('sc-grade').value;
    const roomStudents = students.filter(s => s.grade === grade);
    const midScoreMax = document.getElementById('mid-max').value || 20;
    const finalScoreMax = document.getElementById('final-max').value || 30;
    
    
    if(roomStudents.length === 0) return Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà', 'warning');

    // 1. ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏Å‡∏•‡∏á‡∏Å‡∏±‡∏ô)
    let headHtml = `
        <tr class="bg-slate-800 text-white text-[12px]">
            <th rowspan="2" class="p-4 border border-slate-700 text-center">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
            <th rowspan="2" class="p-4 border border-slate-700 text-center">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
            <th rowspan="2" class="p-4 border border-slate-700 text-center text-rose-300">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</th>
    `;

    tempColsPre.forEach(c => headHtml += `<th class="p-2 border border-slate-700 bg-emerald-700 text-center">${c.title}</th>`);
    headHtml += `<th class="p-2 border border-slate-700 bg-amber-600 text-center">‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ</th>`;
    tempColsPost.forEach(c => headHtml += `<th class="p-2 border border-slate-700 bg-emerald-700 text-center">${c.title}</th>`);
    headHtml += `<th class="p-2 border border-slate-700 bg-rose-600 text-center">‡∏õ‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏Ñ</th>`;
    headHtml += `<th rowspan="2" class="p-4 border border-slate-700 bg-indigo-700 text-center w-20">‡∏£‡∏ß‡∏°</th>`;
    headHtml += `<th rowspan="2" class="p-4 border border-slate-700 bg-indigo-900 text-center w-16">‡πÄ‡∏Å‡∏£‡∏î</th></tr>`;

    headHtml += `<tr class="bg-slate-700 text-emerald-400 text-[10px]">`;
    tempColsPre.forEach(c => headHtml += `<td class="p-1 border border-slate-600 text-center">(${c.max})</td>`);
    headHtml += `<td class="p-1 border border-slate-600 text-center text-amber-300 font-bold">(${midScoreMax})</td>`;
    tempColsPost.forEach(c => headHtml += `<td class="p-1 border border-slate-600 text-center">(${c.max})</td>`);
    headHtml += `<td class="p-1 border border-slate-600 text-center text-rose-300 font-bold">(${finalScoreMax})</td></tr>`;

    document.getElementById('sc-preview-head').innerHTML = headHtml;

    // 2. ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
    let bodyHtml = roomStudents.map((s, index) => {
        // ‡πÉ‡∏ä‡πâ s.no ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ index + 1 ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        const studentNo = s.no || (index + 1);
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ
    tempColsPre = [];
    const preTitles = document.querySelectorAll('#pre-task-container .task-title');
    const preMaxs = document.querySelectorAll('#pre-task-container .task-max');
    preTitles.forEach((el, i) => {
        if(el.value.trim()) tempColsPre.push({ title: el.value, max: parseInt(preMaxs[i].value) || 0 });
    });

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ
    tempColsPost = [];
    const postTitles = document.querySelectorAll('#post-task-container .task-title');
    const postMaxs = document.querySelectorAll('#post-task-container .task-max');
    postTitles.forEach((el, i) => {
        if(el.value.trim()) tempColsPost.push({ title: el.value, max: parseInt(postMaxs[i].value) || 0 });
    });

        let rows = `
            <tr id="row-std-${index}" class="hover:bg-slate-50 transition-all border-b border-slate-100">
                <td class="p-3 text-center font-bold text-slate-500 bg-slate-50/50">${studentNo}</td>
                <td class="p-3 font-bold text-slate-800">${s.name}</td>
                <td class="p-3 text-rose-500 italic font-medium">${s.nickname || '-'}</td>
        `;

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á Input ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‡∏û‡∏£‡πâ‡∏≠‡∏° Event ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        const totalInputCount = tempColsPre.length + 1 + tempColsPost.length + 1;
        for(let i=0; i < totalInputCount; i++) {
            rows += `
                <td class="p-1 border border-slate-100">
                    <input type="number" 
                        oninput="calculateRowScore(${index})" 
                        class="score-input-field w-full p-2 text-center bg-transparent focus:bg-amber-50 outline-none font-bold text-indigo-600" 
                        value="0" min="0">
                </td>`;
        }

        rows += `<td id="total-${index}" class="p-3 text-center font-black text-emerald-600 bg-emerald-50/30 text-xl">0</td>`;
        rows += `<td id="grade-${index}" class="p-3 text-center font-black text-slate-700 bg-slate-100 text-xl">-</td></tr>`;
        return rows;
    }).join('');

    document.getElementById('sc-preview-body').innerHTML = bodyHtml;
    document.getElementById('score-preview-container').classList.remove('hidden');
}

// üßÆ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡∏£‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î
function calculateRowScore(rowIndex) {
    const row = document.getElementById(`row-std-${rowIndex}`);
    const inputs = row.getElementsByClassName('score-input-field');
    let sum = 0;

    for (let input of inputs) {
        sum += parseFloat(input.value) || 0;
    }

    // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏£‡∏ß‡∏°
    document.getElementById(`total-${rowIndex}`).innerText = sum;

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏Å‡∏£‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏≠‡∏¥‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô)
    let grade = "-";
    if (sum >= 80) grade = "4";
    else if (sum >= 75) grade = "3.5";
    else if (sum >= 70) grade = "3";
    else if (sum >= 65) grade = "2.5";
    else if (sum >= 60) grade = "2";
    else if (sum >= 55) grade = "1.5";
    else if (sum >= 50) grade = "1";
    else grade = "0";

    const gradeCell = document.getElementById(`grade-${rowIndex}`);
    gradeCell.innerText = grade;
    
    // ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏µ‡πÄ‡∏Å‡∏£‡∏î
    if(grade === "4" || grade === "3.5") gradeCell.className = "p-3 text-center font-black text-emerald-600 bg-slate-100 text-xl";
    else if(grade === "0") gradeCell.className = "p-3 text-center font-black text-rose-600 bg-slate-100 text-xl";
    else gradeCell.className = "p-3 text-center font-black text-slate-700 bg-slate-100 text-xl";
}

function exportTemplateToExcel() {
    const grade = document.getElementById('sc-grade').value;
    const sub = document.getElementById('sc-sub').value;
    const roomStudents = students.filter(s => s.grade === grade);

    if (roomStudents.length === 0) return Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î', 'warning');

    // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (Header)
    let headers = ["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà", "‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•", "‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô"];
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ
    tempColsPre.forEach(c => headers.push(`${c.title} (${c.max})` || "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Å‡πá‡∏ö"));
    headers.push("‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ");
    tempColsPost.forEach(c => headers.push(`${c.title} (${c.max})` || "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Å‡πá‡∏ö"));
    headers.push("‡∏õ‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏Ñ");

    // 2. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Rows)
    const data = roomStudents.map((s, index) => {
        let rowData = [
            s.no || (index + 1), // ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            s.name,
            s.nickname || "-"
        ];
        // ‡πÄ‡∏ï‡∏¥‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡πÉ‡∏™‡πà 0 ‡πÑ‡∏ß‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)
        const scoreColsCount = tempColsPre.length + 1 + tempColsPost.length + 1;
        for(let i=0; i < scoreColsCount; i++) rowData.push(0);
        
        return rowData;
    });

    // 3. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);

    // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    ws['!cols'] = [{ wch: 8 }, { wch: 30 }, { wch: 15 }];

    XLSX.utils.book_append_sheet(wb, ws, "Template_‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô");

    // 4. ‡∏™‡∏±‡πà‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå
    const fileName = `Template_‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô_${sub}_‡∏ä‡∏±‡πâ‡∏ô_${grade}.xlsx`;
    XLSX.writeFile(wb, fileName);

    Swal.fire({
        icon: 'success',
        title: '‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        text: `‡πÑ‡∏ü‡∏•‡πå ${fileName} ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß`,
        timer: 2000
    });
}

function importScoreFromExcel(input) {
    const file = input.files[0];
    const reader = new FileReader();

    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà 2 (index 1) ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏õ
        const scoreRows = jsonData.slice(1); 
        const previewRows = document.getElementById('sc-preview-body').getElementsByTagName('tr');

        scoreRows.forEach((row, rowIndex) => {
            if (previewRows[rowIndex]) {
                const inputs = previewRows[rowIndex].getElementsByClassName('score-input-field');
                // ‡∏Ç‡πâ‡∏≤‡∏° 3 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏£‡∏Å (‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà, ‡∏ä‡∏∑‡πà‡∏≠, ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô) ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel
                let excelColIndex = 3; 
                
                for (let i = 0; i < inputs.length; i++) {
                    if (row[excelColIndex] !== undefined) {
                        inputs[i].value = row[excelColIndex];
                    }
                    excelColIndex++;
                }
                // ‡∏™‡∏±‡πà‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡∏£‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                calculateRowScore(rowIndex);
            }
        });
        
        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
        input.value = ''; // Reset input
    };
    reader.readAsArrayBuffer(file);
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏±‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£ "‡∏ß‡∏≤‡∏á" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏û‡∏¥‡∏°‡∏û‡πå" ‡∏•‡∏¥‡∏á‡∏Å‡πå
async function autoSyncFromUrl() {
    const urlInput = document.getElementById('sc-sheet-url').value;
    
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå Google Sheets ‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
    if (urlInput.includes('docs.google.com/spreadsheets')) {
        // ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≠‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
        document.getElementById('score-preview-container').classList.remove('hidden');
        document.getElementById('sc-preview-body').innerHTML = `
            <tr><td colspan="100%" class="p-10 text-center text-violet-500 font-bold animate-pulse">
                üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥...
            </td></tr>`;
            
        // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (0.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô‡∏Ç‡∏ì‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå
        clearTimeout(window.syncTimer);
        window.syncTimer = setTimeout(() => {
            syncScoreFromSheets(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å
        }, 500);
    }
}


// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á URL
// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå
async function handleUrlInput() {
    const urlInput = document.getElementById('sc-sheet-url').value;
    const sheetIdMatch = urlInput.match(/\/d\/(.*?)(\/|$)/);
    
    if (sheetIdMatch && sheetIdMatch[1]) {
        const spreadsheetId = sheetIdMatch[1];
        const wrapper = document.getElementById('sheet-selector-wrapper');
        const select = document.getElementById('sc-sheet-name');
        
        wrapper.classList.remove('hidden');
        select.innerHTML = '<option value="">üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ú‡πà‡∏ô‡∏á‡∏≤‡∏ô...</option>';

        // ‡πÉ‡∏ä‡πâ Visualization API ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ Sheet
        // ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏°‡∏µ Error ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏™‡∏∏‡πà‡∏°‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ Sheet
        // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Sheet ‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏ú‡πà‡∏≤‡∏ô CSV ‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏∏ GID ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠
        // ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£ Fetch ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡πÅ‡∏Å‡∏ô JSON ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏î‡πâ‡∏ß‡∏¢ Regex ‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏Ç‡∏∂‡πâ‡∏ô
        await fetchAllSheetNames(urlInput);
    }
}

async function fetchAllSheetNames(url) {
    try {
        const response = await fetch(url);
        const text = await response.text();
        
        // Regex ‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Google Sheets 2026
        const regex = /{"sheetId":\d+,"name":"([^"]+)"/g;
        let sheets = [];
        let match;
        
        while ((match = regex.exec(text)) !== null) {
            const sName = match[1];
            // ‡∏Å‡∏£‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡∏ó‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏≠‡∏≠‡∏Å
            if (!sheets.includes(sName) && sName !== "Template") {
                sheets.push(sName);
            }
        }

        const select = document.getElementById('sc-sheet-name');
        if (sheets.length > 0) {
            select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡πà‡∏ô‡∏á‡∏≤‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏á‡∏≤‡∏ô 1, ‡∏á‡∏≤‡∏ô 2) --</option>' + 
                sheets.map(s => `<option value="${s}">${s}</option>`).join('');
        } else {
            // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏π‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏á
            select.innerHTML = '<option value="Sheet1">Sheet1 (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</option>';
        }
    } catch (e) {
        console.error(e);
    }
}

// 2. ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ó‡πá‡∏ö (‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå)
async function loadSheetTabs(url) {
    try {
        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô /edit ‡πÄ‡∏õ‡πá‡∏ô /view ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
        const fetchUrl = url.split('/edit')[0] + '/view';
        const response = await fetch(fetchUrl);
        const html = await response.text();
        
        // Regex ‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠ Sheet ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Google Sheets ‡πÅ‡∏ó‡πâ‡πÜ
        const regex = /{"sheetId":\d+,"name":"([^"]+)"/g;
        let sheets = [];
        let match;
        
        while ((match = regex.exec(html)) !== null) {
            let sName = match[1];
            if (!sheets.includes(sName)) sheets.push(sName);
        }

        const select = document.getElementById('sc-sheet-name');
        if (sheets.length > 0) {
            document.getElementById('sheet-selector-wrapper').classList.remove('hidden');
            select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡πà‡∏ô‡∏á‡∏≤‡∏ô --</option>' + 
                sheets.map(s => `<option value="${s}">${s}</option>`).join('');
        } else {
            // ‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö ‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (url.includes('rtpof=true')) {
                select.innerHTML = '<option value="">‚ùå ‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô Excel ‡πÇ‡∏õ‡∏£‡∏î Save as Google Sheets ‡∏Å‡πà‡∏≠‡∏ô</option>';
            } else {
                select.innerHTML = '<option value="">‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ú‡πà‡∏ô‡∏á‡∏≤‡∏ô ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå</option>';
            }
        }
    } catch (e) {
        console.error(e);
    }
}

// 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏µ‡∏ó)

// ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global ‡πÑ‡∏ß‡πâ‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡πÄ‡∏™‡∏°‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ
let scoreTasks = []; 

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
async function syncScoreFromSheets() {
    const urlInput = document.getElementById('sc-sheet-url').value;
    const sheetName = document.getElementById('sc-sheet-name').value.trim();
    // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏£‡∏π‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç 2 ‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡πà‡∏≤‡πÅ‡∏ñ‡∏ß 1-2 ‡∏Ñ‡∏∑‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ ‡πÅ‡∏•‡∏∞‡πÅ‡∏ñ‡∏ß 3 ‡∏Ñ‡∏∑‡∏≠ "‡πÄ‡∏ö‡∏™"
    const startRowInput = document.getElementById('sc-row-start').value;
    const startRowSetting = parseInt(startRowInput) || 2; 

    if (!urlInput || !sheetName) {
        return Swal.fire('‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡∏ó‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'warning');
    }

    try {
        const previewBody = document.getElementById('sc-preview-body');
        const previewHead = document.getElementById('sc-preview-head');
        previewBody.innerHTML = `<tr><td colspan="100%" class="text-center p-10 animate-pulse text-violet-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>`;

        const baseAddr = urlInput.split('/edit')[0];
        const proxyUrl = `${baseAddr}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;

        const response = await fetch(proxyUrl);
        if (!response.ok) throw new Error('Network response was not ok');
        const csvText = await response.text();
        
        // ‡πÅ‡∏¢‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (‡∏ï‡∏±‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏≠‡∏±‡∏ç‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏ù‡∏á)
        const rows = csvText.split(/\r?\n/).map(row => {
            const cols = [];
            let curr = '', inQ = false;
            for (let c of row) {
                if (c === '"') inQ = !inQ;
                else if (c === ',' && !inQ) { cols.push(curr.trim()); curr = ''; }
                else curr += c;
            }
            cols.push(curr.trim());
            return cols.map(v => v.replace(/^"|"$/g, '').trim());
        });

        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡πÅ‡∏ñ‡∏ß 1 ‡πÅ‡∏•‡∏∞ 2)
        const mainH = rows[0]; 
        const subH = rows[1];  
        scoreTasks = []; 
        let currentGroup = ""; 

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏∂‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå F (Index 5) ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏õ
        for (let i = 5; i < subH.length; i++) {
            if (mainH[i] && mainH[i] !== "") currentGroup = mainH[i];
            if (subH[i] && subH[i] !== "") {
                scoreTasks.push({ 
                    fullName: `${currentGroup}|${subH[i]}`, 
                    displayName: `${currentGroup}<br><span class="text-[9px] text-slate-400">${subH[i]}</span>`,
                    colIdx: i 
                });
            }
        }

        // ‡∏ß‡∏≤‡∏î‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á Preview
        previewHead.innerHTML = `
            <tr class="bg-slate-800 text-white text-[10px]">
                <th class="p-4">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th><th class="p-4 text-left">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th class="p-4">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</th>
                ${scoreTasks.map(t => `<th class="p-2 border-l border-slate-700">${t.displayName}</th>`).join('')}
            </tr>`;

        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (slice ‡∏à‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏π‡∏Å‡∏≥‡∏´‡∏ô‡∏î)
        const studentRows = rows.slice(startRowSetting); 

        previewBody.innerHTML = studentRows.map((row, i) => {
            if (!row[2] || row[2] === "") return ''; // ‡∏Ç‡πâ‡∏≤‡∏°‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå C
            
            const scoreCells = scoreTasks.map(t => {
                const val = row[t.colIdx] || "";
                return `<td class="p-3 text-center border-l border-slate-100">${val}</td>`;
            }).join('');

            return `<tr class="border-b hover:bg-slate-50 transition-colors">
                <td class="p-3 text-center text-slate-400 font-bold">${row[0] || i+1}</td>
                <td class="p-3 font-bold text-slate-700 text-left">${row[2]} ${row[3] || ''}</td>
                <td class="p-3 text-center font-bold text-violet-500 italic">${row[4] || '-'}</td>
                ${scoreCells}
            </tr>`;
        }).join('');

        document.getElementById('score-preview-container').classList.remove('hidden');

    } catch (e) { 
        console.error(e);
        Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ä‡∏£‡πå‡∏•‡∏¥‡∏á‡∏Å‡πå (‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå)', 'error'); 
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏•‡∏á Firebase
async function saveAllScoresToDB() {
    const grade = document.getElementById('sc-grade').value;
    const sub = document.getElementById('sc-sub').value;
    if (!grade || !sub) return;

    const midMax = document.getElementById('mid-max').value || 0;
    const finalMax = document.getElementById('final-max').value || 0;

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Metadata ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á
    let taskOrder = [];
    tempColsPre.forEach(c => taskOrder.push(`‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ|${c.title} (${c.max})`));
    taskOrder.push(`‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ|‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≠‡∏ö (${midMax})`);
    tempColsPost.forEach(c => taskOrder.push(`‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ|${c.title} (${c.max})`));
    taskOrder.push(`‡∏õ‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏Ñ|‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≠‡∏ö (${finalMax})`);

    const updates = {};
    const roomStudents = students.filter(s => s.grade === grade);
    const rows = document.querySelectorAll('#sc-preview-body tr');

    rows.forEach((row, idx) => {
        const student = roomStudents[idx];
        if (!student) return;
        const inputs = row.querySelectorAll('.score-input-field');
        let studentScores = {};
        let i = 0;

        // ‡πÅ‡∏°‡∏õ‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö taskOrder ‡πÄ‡∏õ‡πä‡∏∞‡πÜ
        tempColsPre.forEach(c => { studentScores[`‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ|${c.title} (${c.max})`] = inputs[i++].value; });
        studentScores[`‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ|‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≠‡∏ö (${midMax})`] = inputs[i++].value;
        tempColsPost.forEach(c => { studentScores[`‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ|${c.title} (${c.max})`] = inputs[i++].value; });
        studentScores[`‡∏õ‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏Ñ|‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≠‡∏ö (${finalMax})`] = inputs[i++].value;

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Path 'scores'
        updates[`scores/${student.id || student.name}/${sub}`] = studentScores;
    });

    await db.ref().update(updates);
    await db.ref(`scores_meta/${sub}/taskOrder`).set(taskOrder); // ‡πÄ‡∏Å‡πá‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ
    Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
}


// --- 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô (‡πÇ‡∏ä‡∏ß‡πå‡πÅ‡∏¢‡∏Å ‡∏™‡∏°‡∏∏‡∏î/‡∏ä‡∏µ‡∏ó) ---
async function loadTrackingReport() {
    const sub = document.getElementById('tr-sub').value;
    const gr = document.getElementById('tr-grade').value;
    if (!sub || !gr) return;

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase
    const sSnap = await db.ref('scores').once('value'); 
    const mSnap = await db.ref(`scores_meta/${sub}/taskOrder`).once('value');
    
    const allS = sSnap.val() || {};
    const taskOrder = mSnap.val() || []; // ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ Array ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ
    const room = students.filter(s => s.grade === gr); 

    // 1. ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô (Grouping) ‡∏ï‡∏≤‡∏° Prefix ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ |
    let tasksByG = {}; 
    taskOrder.forEach(fullKey => {
        const parts = fullKey.split('|');
        const groupName = parts[0] || "‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ";
        if (!tasksByG[groupName]) tasksByG[groupName] = [];
        tasksByG[groupName].push(fullKey); 
    });

    // 2. ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    const order = ["‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ", "‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ", "‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ", "‡∏õ‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏Ñ"];
    const sortedGroups = Object.keys(tasksByG).sort((a, b) => order.indexOf(a) - order.indexOf(b));

    // 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (H1) - ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏Å
    let h1 = `<tr class="bg-white text-black text-[11px] uppercase tracking-widest">
                <th class="p-4 sticky left-0 z-50 bg-white border-r border-slate-200 rounded-tl-3xl shadow-md text-black">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
                <th class="p-4 sticky left-12 z-50 bg-white border-r border-slate-200 text-left min-w-[180px] shadow-md text-black">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                <th class="p-4 sticky left-[228px] z-50 bg-white border-r border-slate-200 font-bold shadow-md text-black">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</th>`;

    sortedGroups.forEach(g => {
        let display = g;
        let color = "bg-slate-700";
        if (g.includes("‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ")) { display = "üìù ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ"; color = "bg-indigo-600"; }
        else if (g === "‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ") { display = "üéØ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ"; color = "bg-orange-600"; }
        else if (g.includes("‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ")) { display = "üìù ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏Ñ"; color = "bg-purple-600"; }
        else if (g === "‡∏õ‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏Ñ") { display = "üéØ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏Ñ"; color = "bg-rose-600"; }

        h1 += `<th colspan="${tasksByG[g].length}" class="${color} p-4 border-l border-white/20 font-extrabold text-white text-center">${display}</th>`;
    });

    h1 += `<th class="bg-emerald-500 text-black p-4 sticky right-16 z-40 font-black border-l border-emerald-600">‡∏£‡∏ß‡∏°</th>
           <th class="bg-slate-200 text-black p-4 sticky right-0 z-40 font-black border-l border-slate-300 rounded-tr-3xl">‡πÄ‡∏Å‡∏£‡∏î</th></tr>`;
    
    document.getElementById('tr-head').innerHTML = h1;

    // 4. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô)
    document.getElementById('tr-body').innerHTML = room.map((s, idx) => {
        let cells = "";
        let total = 0;
        const studentKey = s.id || s.name;
        const myData = allS[studentKey]?.[sub] || {};

        sortedGroups.forEach(g => {
            tasksByG[g].forEach(fullKey => {
                const val = (myData[fullKey] || "").toString().trim();
                let display = "-";
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö border-l ‡πÅ‡∏•‡∏∞ border-slate-200 ‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
                let cellClass = "p-3 text-center border-l border-slate-200 text-black";

                if (val !== "" && !isNaN(val)) {
                    const scoreNum = parseFloat(val);
                    total += scoreNum;
                    display = `<span class="font-bold text-sm">${val}</span>`;
                } else {
                    display = `<div class="w-2 h-2 bg-rose-400 rounded-full mx-auto opacity-30"></div>`;
                    cellClass += " bg-rose-50/10";
                }
                cells += `<td class="${cellClass}">${display}</td>`;
            });
        });

        const gradeResult = calculateGrade(total);

        return `<tr class="hover:bg-slate-50 border-b border-slate-300 transition-colors">
            <td class="p-3 text-center bg-white sticky left-0 z-10 text-black font-bold border-r border-slate-300 shadow-sm">${idx + 1}</td>
            <td class="p-3 bg-white sticky left-12 z-10 text-black font-bold text-left border-r border-slate-300 shadow-sm">${s.name || '-'}</td>
            <td class="p-3 bg-white sticky left-[228px] z-10 text-rose-600 italic font-bold border-r border-slate-300 shadow-sm">${s.nickname || '-'}</td>
            
            ${cells}

            <td class="p-3 text-center bg-emerald-100 sticky right-16 z-20 font-black text-black border-l border-slate-300 shadow-[-2px_0_5px_rgba(0,0,0,0.05)]">
                ${total}
            </td>
            <td class="p-3 text-center bg-slate-200 sticky right-0 z-20 font-black text-black border-l border-slate-300 shadow-[-2px_0_5px_rgba(0,0,0,0.05)]">
                ${gradeResult}
            </td>
        </tr>`;
    }).join('');
}
    
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏Å‡∏£‡∏î‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô (0-100 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)
function calculateGrade(score) {
    if (score === null || score === undefined || score === "") return "-";
    
    const s = parseFloat(score);
    if (isNaN(s)) return "-";

    if (s >= 80) return "4";
    if (s >= 75) return "3.5";
    if (s >= 70) return "3";
    if (s >= 65) return "2.5";
    if (s >= 60) return "2";
    if (s >= 55) return "1.5";
    if (s >= 50) return "1";
    return "0";
}


        // --- 6. ADVANCED STATS ---
        async function generateStatsReport() {
    const gr = document.getElementById('st-grade').value;
    const sub = document.getElementById('st-sub').value;
    
    // --- ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πâ‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ---
    const cleanGr = gr.replace(/[.#$[\]]/g, "_");
    const cleanSub = sub.replace(/[.#$[\]]/g, "_");

    Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });

    // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase (‡∏î‡∏∂‡∏á‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏õ)
    const sSnap = await db.ref('sessions').once('value'); 
    const aSnap = await db.ref(`attendance/${cleanGr}/${cleanSub}`).once('value');
    
    const sess = Object.values(sSnap.val() || {}).filter(s => s.grade === gr && s.subject === sub);
    const att = aSnap.val() || {}; 
    const room = students.filter(s => s.grade === gr).sort((a,b)=>a.id-b.id);
    
    let html = "", tP=0, tL=0, tA=0;

    room.forEach((s, idx) => {
        let p=0, l=0, a=0;
        sess.forEach(ses => { 
            // ‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ att ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏î‡∏∂‡∏á‡∏°‡∏≤
            const r = att[ses.id]?.[s.id]; 
            if(!r || r.status === "‡∏Ç‡∏≤‡∏î") a++; 
            else if(r.status === "‡∏™‡∏≤‡∏¢") l++; 
            else p++; 
        });
        
        const per = sess.length > 0 ? (((p+l)/sess.length)*100).toFixed(0) : 0;
        tP+=p; tL+=l; tA+=a;
        html += `<tr><td>${idx+1}</td><td>${s.id}</td><td class="text-left font-medium">${s.name}</td><td class="status-present font-bold">${p}</td><td class="status-late font-bold">${l}</td><td class="status-absent font-bold">${a}</td><td class="font-bold ${per<80?'text-rose-600':'text-emerald-600'}">${per}%</td></tr>`;
    });

    document.getElementById('stats-table-body').innerHTML = html;
    document.getElementById('stats-area').classList.remove('hidden');
    document.getElementById('stats-summary-cards').innerHTML = `
        <div class="glass p-4 text-center border-l-8 border-emerald-500"><div>‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏∞‡∏™‡∏°</div><div class="text-3xl font-bold">${tP}</div></div>
        <div class="glass p-4 text-center border-l-8 border-orange-500"><div>‡∏°‡∏≤‡∏™‡∏≤‡∏¢‡∏™‡∏∞‡∏™‡∏°</div><div class="text-3xl font-bold">${tL}</div></div>
        <div class="glass p-4 text-center border-l-8 border-rose-500"><div>‡∏Ç‡∏≤‡∏î‡∏™‡∏∞‡∏™‡∏°</div><div class="text-3xl font-bold">${tA}</div></div>`;
    
    Swal.close();
}

        function exportStatsCSV() {
            let csv = []; const rows = document.querySelectorAll("#page-admin-stats table tr");
            rows.forEach(r => { let row = []; r.querySelectorAll("th, td").forEach(c => row.push(`"${c.innerText}"`)); csv.push(row.join(",")); });
            const blob = new Blob(["\ufeff" + csv.join("\n")], { type: "text/csv;charset=utf-8;" });
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = "Stats.csv"; link.click();
        }

        // 1. ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÑ‡∏ß‡πâ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß (‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô)
let temporaryChanges = {};

// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡πà‡∏á‡∏°‡∏≤ ‡∏ú‡∏°‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢)
async function showSessionEditor() {
    try {
        const gradeEl = document.getElementById('st-grade');
        const subEl = document.getElementById('st-sub');
        if (!gradeEl || !subEl) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á/‡∏ß‡∏¥‡∏ä‡∏≤', 'error');

        const gr = gradeEl.value, sub = subEl.value;
        if (!gr || !sub) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" ‡πÅ‡∏•‡∏∞ "‡∏ß‡∏¥‡∏ä‡∏≤" ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö', 'warning');

        Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });

        const sSnap = await db.ref('sessions').once('value');
        const allSessions = sSnap.val();
        if (!allSessions) return Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏î‡πÜ', 'info');

        const sessions = Object.entries(allSessions)
            .map(([id, data]) => ({ id, ...data }))
            .filter(s => s.grade === gr && s.subject === sub);

        if (sessions.length === 0) return Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', `‡∏ß‡∏¥‡∏ä‡∏≤ ${sub} ‡∏´‡πâ‡∏≠‡∏á ${gr} ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô`, 'info');

        sessions.reverse();
        let sessionButtons = sessions.map(s => {
            const sidStr = String(s.id); 
            const displayId = sidStr.length > 5 ? sidStr.slice(-5) : sidStr;
            return `
                <button onclick="editSessionAttendance('${s.id}')" 
                    class="m-1 px-4 py-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 shadow-sm transition-all text-sm font-bold min-w-[120px]">
                    üìÖ ${s.date || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'}<br>
                    <span class="text-xs font-normal opacity-80">ID: ${displayId}</span>
                </button>`;
        }).join('');

        Swal.fire({
            title: '<span class="text-lg">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</span>',
            html: `<div class="flex flex-wrap justify-center p-2">${sessionButtons}</div>`,
            showConfirmButton: false,
            showCloseButton: true,
            width: '500px'
        });
    } catch (error) {
        Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', error.message, 'error');
    }
}

// 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡πÅ‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)
async function editSessionAttendance(sessionId) {
    const gr = document.getElementById('st-grade').value;
    const sub = document.getElementById('st-sub').value;
    const cleanGr = gr.replace(/[.#$[\]]/g, "_");
    const cleanSub = sub.replace(/[.#$[\]]/g, "_");

    // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
    temporaryChanges = {};

    Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });

    try {
        const aSnap = await db.ref(`attendance/${cleanGr}/${cleanSub}/${sessionId}`).once('value');
        const currentAtt = aSnap.val() || {};
        const roomData = typeof students !== 'undefined' ? students.filter(s => s.grade === gr) : [];

        if (roomData.length === 0) return Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠', '‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô Master Data', 'warning');

        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ---
        let html = `
            <div class="flex justify-center gap-2 mb-4 bg-slate-50 p-2 rounded-xl">
                <button onclick="markAllInEditor('‡∏°‡∏≤')" class="px-4 py-2 bg-emerald-500 text-white rounded-lg font-bold text-xs hover:bg-emerald-600 transition-all">‚úÖ ‡∏°‡∏≤‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô</button>
                <button onclick="markAllInEditor('‡∏™‡∏≤‡∏¢')" class="px-4 py-2 bg-amber-500 text-white rounded-lg font-bold text-xs hover:bg-amber-600 transition-all">‚è≥ ‡∏™‡∏≤‡∏¢‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô</button>
                <button onclick="markAllInEditor('‡∏Ç‡∏≤‡∏î')" class="px-4 py-2 bg-rose-500 text-white rounded-lg font-bold text-xs hover:bg-rose-600 transition-all">‚ùå ‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô</button>
            </div>
            <div class="max-h-[50vh] overflow-y-auto border rounded-lg mb-4">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-100 sticky top-0">
                        <tr><th class="p-3 border-b">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th class="p-3 border-b w-32 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr>
                    </thead>
                    <tbody id="editor-table-body">`;

        roomData.sort((a,b) => a.id - b.id).forEach(s => {
            const currentStatus = currentAtt[s.id]?.status || "‡∏Ç‡∏≤‡∏î";
            html += `
                <tr class="border-b hover:bg-slate-50">
                    <td class="p-3 font-medium text-left">${s.name}</td>
                    <td class="p-3">
                        <select data-id="${s.id}" onchange="queueChange('${s.id}', this.value)" class="att-select w-full p-2 rounded-md border shadow-sm cursor-pointer">
                            <option value="‡∏°‡∏≤" ${currentStatus === '‡∏°‡∏≤' ? 'selected' : ''}>‚úÖ ‡∏°‡∏≤</option>
                            <option value="‡∏™‡∏≤‡∏¢" ${currentStatus === '‡∏™‡∏≤‡∏¢' ? 'selected' : ''}>‚è≥ ‡∏™‡∏≤‡∏¢</option>
                            <option value="‡∏Ç‡∏≤‡∏î" ${currentStatus === '‡∏Ç‡∏≤‡∏î' ? 'selected' : ''}>‚ùå ‡∏Ç‡∏≤‡∏î</option>
                            <option value="‡∏•‡∏≤" ${currentStatus === '‡∏•‡∏≤' ? 'selected' : ''}>üìù ‡∏•‡∏≤</option>
                        </select>
                    </td>
                </tr>`;
        });
        html += `</tbody></table></div>`;

        Swal.fire({
            title: `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${sessionId}`,
            html: html,
            showCancelButton: true,
            confirmButtonText: 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
            confirmButtonColor: '#10b981',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
            width: '600px',
            preConfirm: async () => {
                const total = Object.keys(temporaryChanges).length;
                if (total === 0) return Swal.showValidationMessage('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                try {
                    await db.ref(`attendance/${cleanGr}/${cleanSub}/${sessionId}`).update(temporaryChanges);
                    return true;
                } catch (e) { Swal.showValidationMessage(`Error: ${e.message}`); }
            }
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                if (typeof generateStatsReport === "function") generateStatsReport();
            }
        });
    } catch (e) { Swal.fire('Error', e.message, 'error'); }
}

// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏°: ‡∏ï‡∏¥‡πä‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ---
function markAllInEditor(status) {
    const selects = document.querySelectorAll('.att-select');
    selects.forEach(sel => {
        sel.value = status; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        const sid = sel.getAttribute('data-id');
        queueChange(sid, status); // ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô temporaryChanges
    });
}

// 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß (‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö)
function queueChange(studentId, newStatus) {
    temporaryChanges[studentId] = {
        status: newStatus,
        time: new Date().toLocaleTimeString('th-TH')
    };

}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏µ Dropdown
function getStatusStyle(status) {
    if (status === '‡∏°‡∏≤') return 'bg-emerald-50 text-emerald-700 border-emerald-200';
    if (status === '‡∏™‡∏≤‡∏¢') return 'bg-amber-50 text-amber-700 border-amber-200';
    if (status === '‡∏•‡∏≤') return 'bg-blue-50 text-blue-700 border-blue-200';
    return 'bg-rose-50 text-rose-700 border-rose-200';
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ Select ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
function getStatusColor(s) {
    if(s === '‡∏°‡∏≤') return 'bg-emerald-50 text-emerald-600';
    if(s === '‡∏™‡∏≤‡∏¢') return 'bg-amber-50 text-amber-600';
    if(s === '‡∏Ç‡∏≤‡∏î') return 'bg-rose-50 text-rose-600';
    if(s === '‡∏•‡∏≤') return 'bg-blue-50 text-blue-600';
    return '';
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏±‡∏ß‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏•‡∏á Firebase
async function updateSingleStatus(sessionId, studentId, newStatus) {
    const gr = document.getElementById('st-grade').value;
    const sub = document.getElementById('st-sub').value;
    const cleanGr = gr.replace(/[.#$[\]]/g, "_");
    const cleanSub = sub.replace(/[.#$[\]]/g, "_");

    try {
        await db.ref(`attendance/${cleanGr}/${cleanSub}/${sessionId}/${studentId}`).update({
            status: newStatus,
            time: new Date().toLocaleTimeString('th-TH')
        });
        
        // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏•‡πá‡∏Å‡πÜ ‡∏°‡∏∏‡∏°‡∏à‡∏≠
        const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1000 });
        Toast.fire({ icon: 'success', title: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß' });
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        generateStatsReport();
    } catch (e) {
        Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ', 'error');
    }
}
        // --- 7. QR PRINT TOOL ---
        function previewQR() {
            const gr = document.getElementById('qr-grade-sel').value; const list = students.filter(s => s.grade === gr).sort((a,b)=>a.id-b.id);
            const g = document.getElementById('preview-grid'), pg = document.getElementById('qr-print-grid');
            g.innerHTML = pg.innerHTML = ""; document.getElementById('qr-preview-box').classList.remove('hidden');
            list.forEach(s => {
                const h = `<div class="p-2 border rounded-xl flex flex-col items-center bg-white"><div id="qrp-${s.id}"></div><div class="text-[9px] mt-1 font-bold">${s.name}</div><div class="text-[8px] opacity-50">${s.id}</div></div>`;
                g.innerHTML += h; pg.innerHTML += h;
            });
            setTimeout(() => { list.forEach(s => { new QRCode(document.getElementById(`qrp-${s.id}`), { text: s.id, width: 80, height: 80 }); }); }, 500);
        }

        // --- 8. STUDENT LOGIC ---
        function handleStudentLogin() {
    const id = document.getElementById('std-login-id').value.trim(); 
    const s = students.find(x => x.id === id);
    
    if(!s) return Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');

    window.currentStudent = s;
    currentSid = id; 
    showPage('std-dashboard');
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß
    document.getElementById('std-name-txt').innerText = s.name; 
    document.getElementById('std-grade-txt').innerText = `‡∏´‡πâ‡∏≠‡∏á ${s.grade}`;
    document.getElementById('std-img').src = s.photo || `https://api.dicebear.com/7.x/initials/svg?seed=${id}`;
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏ö‡∏ö Grid Card
    const g = document.getElementById('std-subject-list'); 
    g.innerHTML = "";
    
    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏°‡∏µ‡∏™‡∏±‡∏ô
    const colors = ['border-indigo-500', 'border-emerald-500', 'border-rose-500', 'border-amber-500', 'border-purple-500'];
    let colorIdx = 0;

    Object.entries(s.subjects || {}).forEach(([n, v]) => { 
        if(v) {
            const color = colors[colorIdx % colors.length];
            const btn = document.createElement('button');
            
            // ‡∏õ‡∏£‡∏±‡∏ö Class ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Card ‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
            btn.className = `group relative overflow-hidden bg-white p-8 text-left border-l-[12px] ${color} rounded-3xl shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all duration-300`;
            
            btn.innerHTML = `
                <div class="relative z-10">
                    <span class="text-[11px] font-black text-slate-400 uppercase tracking-[0.2em] mb-1 block">Subject</span>
                    <h3 class="text-2xl font-black text-slate-800 tracking-tighter group-hover:text-indigo-600 transition-colors">${n}</h3>
                </div>
                <div class="absolute right-[-10px] bottom-[-10px] text-6xl opacity-[0.03] group-hover:opacity-[0.08] transition-opacity">üìö</div>
            `;
            
            btn.onclick = () => { 
                currentSub = n; 
                showPage('std-subject-menu'); 
                document.getElementById('std-menu-sub-title').innerText = n; 
            };
            
            g.appendChild(btn);
            colorIdx++;
        }
    });
}

function selectSubject(subjectName) {
    currentSub = subjectName; // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤ ‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤‡∏•‡∏á‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    console.log("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢:", currentSub);
    
    // ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π (Do Now, Score, Pending)
    showPage('page-std-subject-menu');
} 
        // üèÜ ‡∏õ‡∏∏‡πà‡∏° SCORES
async function showStdScores() {
    if(!currentSub) return Swal.fire('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡πà‡∏≠‡∏ô');

    try {
        const [scoreSnap, metaSnap] = await Promise.all([
            db.ref(`scores/${currentSid}/${currentSub}`).once('value'),
            db.ref(`scores_meta/${currentSub}/taskOrder`).once('value')
        ]);

        const scs = scoreSnap.val() || {};
        const taskOrder = metaSnap.val() || []; 
        
        const filteredTasks = taskOrder.filter(task => {
            const name = task.toLowerCase();
            return name.includes("‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô") || name.includes("‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ") || name.includes("‡∏õ‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏Ñ");
        });

        let totalAccumulated = 0;
        let midtermScore = "-";
        let finalScore = "-";
        let detailItemsHtml = "";

        filteredTasks.forEach(fullTaskName => {
            const scoreValue = scs[fullTaskName];
            const val = (!isNaN(scoreValue) && scoreValue !== "") ? parseFloat(scoreValue) : 0;
            
            // --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÅ‡∏¢‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ---
            const parts = fullTaskName.split('|');
            const groupName = parts[0] || ""; // ‡∏Ñ‡∏∑‡∏≠ "‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ", "‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ" ‡∏Ø‡∏•‡∏Ø
            // ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏Ñ‡∏∑‡∏≠‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà 2 (index 1) ‡πÄ‡∏ä‡πà‡∏ô "‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà 1 (10)"
            const taskTitle = parts[1] || fullTaskName; 

            if (fullTaskName.includes("‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ") && !fullTaskName.includes("‡∏Å‡πà‡∏≠‡∏ô") && !fullTaskName.includes("‡∏´‡∏•‡∏±‡∏á")) {
                midtermScore = scoreValue || 0;
            } else if (fullTaskName.includes("‡∏õ‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏Ñ") && !fullTaskName.includes("‡∏´‡∏•‡∏±‡∏á")) {
                finalScore = scoreValue || 0;
            } else {
                totalAccumulated += val;
            }

            const isMissing = scoreValue === "‡πÑ‡∏°‡πà‡∏™‡πà‡∏á" || scoreValue === "" || scoreValue === undefined;
            const cardBg = isMissing ? "bg-rose-50 border-rose-200" : "bg-white border-slate-200";
            const scoreColor = isMissing ? "text-rose-600" : "text-indigo-700";

            // --- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Card: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å groupName ‡πÄ‡∏õ‡πá‡∏ô taskTitle ---
            detailItemsHtml += `
                <div class="p-8 border-2 rounded-[3.5rem] ${cardBg} transition-all shadow-sm flex flex-col justify-between min-h-[200px]">
                    <div>
                        <h4 class="text-4xl font-black text-slate-800 leading-tight mb-2 tracking-tighter">
                            ${taskTitle}
                        </h4>
                        <p class="text-sm font-bold text-indigo-400 uppercase tracking-widest">${groupName}</p>
                    </div>
                    
                    <div class="flex items-baseline gap-2 mt-4">
                        <span class="text-7xl font-black ${scoreColor}">${isMissing ? '‡∏Ñ‡πâ‡∏≤‡∏á' : scoreValue}</span>
                        <span class="text-xl font-bold text-slate-400">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>
                    </div>
                </div>
            `;
        });

        // HTML ‡∏™‡πà‡∏ß‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å (‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏ç‡πà‡πÅ‡∏•‡∏∞‡∏ä‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°)
        const finalHtml = `
            <div class="w-full max-w-7xl mx-auto px-6 pb-24 text-left">
                <div class="mb-12">
                    <p class="text-indigo-500 font-black text-2xl mb-3 tracking-tighter italic">Student Grade Report</p>
                    <h2 class="text-7xl font-black text-slate-900 tracking-tighter leading-none">${currentSub}</h2>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-8 mb-16">
                    <div class="lg:col-span-1 bg-indigo-700 rounded-[3.5rem] p-12 text-white shadow-2xl flex flex-col justify-center border-b-[12px] border-indigo-900">
                        <span class="text-sm font-black text-indigo-200 uppercase tracking-[0.3em] mb-4">Total Score</span>
                        <span class="text-9xl font-black text-emerald-400 leading-none">
                            ${totalAccumulated + (parseFloat(midtermScore)||0) + (parseFloat(finalScore)||0)}
                        </span>
                    </div>
                    
                    <div class="lg:col-span-3 grid grid-cols-1 sm:grid-cols-3 gap-6">
                        <div class="bg-white border-4 border-slate-100 rounded-[3.5rem] p-10 shadow-sm">
                            <span class="text-xs block text-slate-400 font-black uppercase mb-4 tracking-widest">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Å‡πá‡∏ö</span>
                            <span class="text-7xl font-black text-slate-800">${totalAccumulated}</span>
                        </div>
                        <div class="bg-white border-4 border-slate-100 rounded-[3.5rem] p-10 shadow-sm">
                            <span class="text-xs block text-orange-400 font-black uppercase mb-4 tracking-widest">‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ</span>
                            <span class="text-7xl font-black text-slate-800">${midtermScore}</span>
                        </div>
                        <div class="bg-white border-4 border-slate-100 rounded-[3.5rem] p-10 shadow-sm">
                            <span class="text-xs block text-rose-400 font-black uppercase mb-4 tracking-widest">‡∏õ‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏Ñ</span>
                            <span class="text-7xl font-black text-slate-800">${finalScore}</span>
                        </div>
                    </div>
                </div>

                <div>
                    <h4 class="font-black text-5xl text-slate-900 mb-10 flex items-center gap-5">
                        <span class="w-4 h-16 bg-indigo-600 rounded-full"></span>
                        ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏≤‡∏¢‡∏´‡∏ô‡πà‡∏ß‡∏¢
                    </h4>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8">
                        ${detailItemsHtml || '<p class="col-span-full p-20 text-center text-slate-300 text-3xl font-bold">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>'}
                    </div>
                </div>
            </div>
        `;
        
        renderContent("üèÜ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô", "#4f46e5", finalHtml);

    } catch (error) {
        console.error(error);
        Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
    }
}
// üìã ‡∏õ‡∏∏‡πà‡∏° PENDING
async function showStdPending() {
    if(!currentSub) return;
    
    try {
        // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡πÅ‡∏•‡∏∞ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å Meta
        const [scoreSnap, metaSnap] = await Promise.all([
            db.ref(`scores/${currentSid}/${currentSub}`).once('value'),
            db.ref(`scores_meta/${currentSub}/taskOrder`).once('value')
        ]);

        const myScores = scoreSnap.val() || {};
        const allTasks = metaSnap.val() || []; // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏π‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ
        
        // 2. ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô" ‡∏´‡∏£‡∏∑‡∏≠ "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á"
        const missingTasks = allTasks.filter(taskName => {
            const score = myScores[taskName];
            // ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡∏Ñ‡∏∑‡∏≠: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô DB ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡πà‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠ ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ß‡πà‡∏≤ "‡πÑ‡∏°‡πà‡∏™‡πà‡∏á"
            return score === undefined || score === "" || score === "‡πÑ‡∏°‡πà‡∏™‡πà‡∏á" || score === null;
        });

        // 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
        let htmlContent = "";

        if (missingTasks.length > 0) {
            const listHtml = missingTasks.map(task => {
                const parts = task.split('|');
                const group = parts[0] || "‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ";
                const title = parts[1] || task;

                return `
                    <div class="flex items-center justify-between p-6 bg-white border-2 border-rose-100 rounded-3xl shadow-sm mb-4 group hover:border-rose-300 transition-all">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-rose-100 rounded-2xl flex items-center justify-center text-rose-600 text-2xl group-hover:scale-110 transition-transform">
                                üìã
                            </div>
                            <div>
                                <h4 class="text-xl font-black text-slate-800 tracking-tighter">${title}</h4>
                                <p class="text-xs font-bold text-rose-400 uppercase tracking-widest">${group}</p>
                            </div>
                        </div>
                        <div class="px-4 py-2 bg-rose-500 text-white text-xs font-black rounded-full uppercase tracking-tighter">
                            ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á
                        </div>
                    </div>
                `;
            }).join('');

            htmlContent = `
                <div class="max-w-4xl mx-auto px-4">
                    <div class="mb-10 text-center">
                        <p class="text-rose-500 font-black text-xl mb-2 tracking-tighter">Pending Tasks</p>
                        <h2 class="text-5xl font-black text-slate-900 tracking-tighter">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á</h2>
                    </div>
                    <div class="flex flex-col">
                        ${listHtml}
                    </div>
                </div>
            `;
        } else {
            // ‡∏Å‡∏£‡∏ì‡∏µ‡∏™‡πà‡∏á‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß
            htmlContent = `
                <div class="flex flex-col items-center justify-center py-20">
                    <div class="w-32 h-32 bg-emerald-100 rounded-full flex items-center justify-center text-6xl mb-6 animate-bounce">
                        üéâ
                    </div>
                    <h2 class="text-4xl font-black text-slate-900 tracking-tighter mb-2">‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å!</h2>
                    <p class="text-emerald-500 font-bold text-xl uppercase tracking-widest">‡∏Ñ‡∏∏‡∏ì‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß</p>
                </div>
            `;
        }
        
        renderContent("üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á", "#f43f5e", htmlContent);

    } catch (error) {
        console.error(error);
        Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏î‡πâ', 'error');
    }
}

// ‚ö° ‡∏õ‡∏∏‡πà‡∏° DO NOW
async function showStdDoNow() {
    // 1. ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏ô‡∏ü‡∏¥‡∏Å Do Now
    const s = await db.ref('donow_config').once('value');
    const d = s.val() || {};
    
    // 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
    const student = students.find(x => x.id === currentSid);
    if (!student) return Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô');

    // 3. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ "‡πÄ‡∏Ñ‡∏¢‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á" ‡πÉ‡∏ô Node donow_answers
    const checkAns = await db.ref(`donow_answers/${currentSid}`).once('value');
    const hasSubmitted = checkAns.exists();

    const ok = d.active && 
               String(d.subject).trim() === String(currentSub).trim() && 
               String(student.grade).trim() === String(d.grade).trim();

    if (ok) {
        if (hasSubmitted) {
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß
            renderContent("‚ö° ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° Do Now", "#fbbf24", `
                <div class="text-center py-20">
                    <div class="text-6xl mb-4">‚úÖ</div>
                    <p class="text-emerald-500 text-xl font-bold">‡∏Ñ‡∏∏‡∏ì‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p>
                    <p class="text-slate-400 text-sm mt-2">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ</p>
                </div>
            `);
        } else {
            // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏™‡πà‡∏á ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡πÇ‡∏à‡∏ó‡∏¢‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤
            const h = `
                <div class="space-y-6">
                    <div class="p-8 bg-amber-50 rounded-3xl border-4 border-dashed border-amber-300 text-center font-bold text-2xl text-amber-700">
                        ${d.text}
                    </div>
                    <div class="text-center py-4 bg-white rounded-3xl shadow-sm border border-slate-100">
                        <div id="dn-clock" class="text-7xl font-black text-rose-500">180</div>
                        <p class="text-slate-400 text-xs font-bold uppercase mt-1">‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠</p>
                    </div>
                    <div class="space-y-4">
                        <textarea id="std-dn-answer" class="w-full p-5 border-2 border-amber-200 rounded-3xl outline-none text-lg" rows="3" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
                        <button onclick="submitDoNowAnswer()" id="btn-dn-submit" class="w-full py-4 bg-amber-500 text-white rounded-2xl font-bold text-xl shadow-lg active:scale-95">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
                    </div>
                </div>
            `;
            renderContent("‚ö° ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° Do Now", "#fbbf24", h);
            setTimeout(() => { startCountdown(180, Date.now()); }, 100);
        }
    } else {
        renderContent("‚ö° ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° Do Now", "#fbbf24", '<div class="text-center py-20 text-slate-300 font-bold">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</div>');
    }
}

function startCountdown(duration, startTime) {
    // ‡∏•‡πâ‡∏≤‡∏á Interval ‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡∏¥‡πà‡∏á‡∏ó‡∏±‡∏ö‡∏Å‡∏±‡∏ô‡∏ñ‡πâ‡∏≤‡∏Å‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≠‡∏ö
    if (donowInterval) clearInterval(donowInterval);

    const updateClock = () => {
        const clockEl = document.getElementById('dn-clock');
        const btnSubmit = document.getElementById('btn-dn-submit');
        const inputArea = document.getElementById('std-dn-answer');

        const now = Date.now();
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ ‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å startTime (‡∏ã‡∏∂‡πà‡∏á‡∏Ñ‡∏∑‡∏≠‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏à‡∏ó‡∏¢‡πå)
        const elapsed = Math.floor((now - startTime) / 1000);
        const remain = duration - elapsed;

        if (remain <= 0) {
            clearInterval(donowInterval);
            if (clockEl) clockEl.innerText = "0";
            if (btnSubmit) {
                btnSubmit.disabled = true;
                btnSubmit.innerText = "‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á";
                btnSubmit.style.backgroundColor = "#cbd5e1"; // ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤
            }
            if (inputArea) inputArea.disabled = true;
            Swal.fire('‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤!', '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß', 'error');
        } else {
            if (clockEl) clockEl.innerText = remain;
        }
    };

    updateClock(); // ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠ 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡πÅ‡∏£‡∏Å
    donowInterval = setInterval(updateClock, 1000);
}

        // --- 9. HELPERS ---
        function updateSelectMenus() {
            const gs = [...new Set(students.map(s => s.grade))].sort();
            ['t-grade','sc-grade','st-grade','dn-grade','qr-grade-sel','tr-grade'].forEach(id => {
                const el = document.getElementById(id); if(el) el.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á --</option>` + gs.map(g => `<option value="${g}">${g}</option>`).join('');
            });
        }
        function updateSubFilter(g, t) {
            const sel = document.getElementById(t); const subs = new Set();
            students.filter(s => s.grade === g).forEach(s => Object.entries(s.subjects || {}).forEach(([n, v]) => { if(v) subs.add(n); }));
            sel.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤ --</option>` + Array.from(subs).map(s => `<option value="${s}">${s}</option>`).join('');
        }


    async function resetAttendance() {
    const gr = document.getElementById('st-grade').value;
    const sub = document.getElementById('st-sub').value;

    if (!gr || !sub) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" ‡πÅ‡∏•‡∏∞ "‡∏ß‡∏¥‡∏ä‡∏≤" ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö', 'warning');

    Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });

    try {
        const sSnap = await db.ref('sessions').once('value');
        const allSessions = sSnap.val();

        if (!allSessions) return Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏î‡πÜ', 'info');

        const sessions = Object.entries(allSessions)
            .map(([id, data]) => ({ id, ...data }))
            .filter(s => s.grade === gr && s.subject === sub);

        if (sessions.length === 0) return Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', `‡∏ß‡∏¥‡∏ä‡∏≤ ${sub} ‡∏´‡πâ‡∏≠‡∏á ${gr} ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏•‡∏ö`, 'info');

        sessions.reverse();

        // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏ö‡∏ó‡∏µ‡∏•‡∏∞‡∏Ñ‡∏≤‡∏ö
        let sessionButtons = sessions.map(s => {
            const sidStr = String(s.id);
            const displayId = sidStr.length > 5 ? sidStr.slice(-5) : sidStr;
            return `
                <button onclick="confirmDeleteSession('${s.id}', '${s.date}')" 
                    class="m-1 px-4 py-3 bg-rose-50 text-rose-700 border border-rose-200 rounded-xl hover:bg-rose-600 hover:text-white shadow-sm transition-all text-sm font-bold min-w-[120px]">
                    üóëÔ∏è ‡∏•‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤<br>
                    <span class="text-[11px] font-normal opacity-80">${s.date} (${displayId})</span>
                </button>`;
        }).join('');

        // 2. ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏∏‡πà‡∏° "‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"
        Swal.fire({
            title: '<span class="text-rose-600">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>',
            html: `
                <div class="mb-4 p-4 bg-rose-600 text-white rounded-2xl shadow-lg cursor-pointer hover:bg-rose-700 transition-all" 
                     onclick="deleteAllSessions('${gr}', '${sub}', ${sessions.length})">
                    <div class="text-lg font-black">‚ö†Ô∏è ‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (${sessions.length} ‡∏Ñ‡∏≤‡∏ö)</div>
                    <div class="text-xs opacity-80 font-normal">‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡∏ä‡∏≤ ${sub} ‡∏´‡πâ‡∏≠‡∏á ${gr} ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏™‡πÅ‡∏Å‡∏ô‡∏°‡∏≤</div>
                </div>
                <div class="p-2 mb-2 text-xs text-slate-500 border-t pt-4">‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ö‡∏≤‡∏á‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö:</div>
                <div class="flex flex-wrap justify-center p-2 max-h-[300px] overflow-y-auto">${sessionButtons}</div>`,
            showConfirmButton: false,
            showCloseButton: true,
            width: '500px'
        });

    } catch (error) {
        Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', error.message, 'error');
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
async function deleteAllSessions(grade, subject, count) {
    const result = await Swal.fire({
        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?',
        text: `‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${count} ‡∏Ñ‡∏≤‡∏ö ‡∏Ç‡∏≠‡∏á‡∏ß‡∏¥‡∏ä‡∏≤ ${subject} ‡∏´‡πâ‡∏≠‡∏á ${grade} ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ñ‡∏≤‡∏ß‡∏£!`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î!',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
    });

    if (result.isConfirmed) {
        Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });

        try {
            const sSnap = await db.ref('sessions').once('value');
            const allSessions = sSnap.val();
            const updates = {};

            Object.entries(allSessions).forEach(([id, data]) => {
                if (data.grade === grade && data.subject === subject) {
                    updates[`/sessions/${id}`] = null; 
                }
            });

            await db.ref().update(updates);
            
            Swal.fire({
                icon: 'success',
                title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                text: '‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                timer: 1500,
                showConfirmButton: false
            });

            generateStatsReport();
        } catch (error) {
            Swal.fire('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', error.message, 'error');
        }
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Ñ‡∏≤‡∏ö
async function confirmDeleteSession(sessionId, sessionDate) {
    const gr = document.getElementById('st-grade').value;
    const sub = document.getElementById('st-sub').value;
    const cleanGr = gr.replace(/[.#$[\]]/g, "_");
    const cleanSub = sub.replace(/[.#$[\]]/g, "_");

    const result = await Swal.fire({
        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ñ‡∏≤‡∏ö‡∏ô‡∏µ‡πâ?',
        text: `‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${sessionDate} ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á‡∏ñ‡∏≤‡∏ß‡∏£ ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#e11d48',
        cancelButtonColor: '#64748b',
        confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á‡πÄ‡∏•‡∏¢',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
    });

    if (result.isConfirmed) {
        try {
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });

            // 1. ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Attendance ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≤‡∏ö‡∏ô‡∏±‡πâ‡∏ô
            await db.ref(`attendance/${cleanGr}/${cleanSub}/${sessionId}`).remove();

            // 2. ‡∏•‡∏ö‡∏ï‡∏±‡∏ß Session ‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏¥‡πâ‡∏á
            await db.ref(`sessions/${sessionId}`).remove();

            await Swal.fire({
                icon: 'success',
                title: '‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≤‡∏ö‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                timer: 1500,
                showConfirmButton: false
            });

            // 3. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            generateStatsReport();

        } catch (error) {
            Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏î‡πâ: ' + error.message, 'error');
        }
    }
}

let donowInterval;

function initDoNowListener() {
    console.log("üì° ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô: ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≠‡∏£‡∏±‡∏ö‡πÇ‡∏à‡∏ó‡∏¢‡πå Do Now");
    
    // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏±‡∏Å‡∏ü‡∏±‡∏á‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
    db.ref('donow_config').off(); 

    db.ref('donow_config').on('value', async (snap) => {
        const d = snap.val();
        
        // 1. ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏£‡∏π‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î
        if (!d || !d.active) {
            console.log("üí§ ‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà (Active = false)");
            return;
        }

        // 2. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÑ‡∏´‡∏°)
        const student = students.find(s => s.id === currentSid);
        if (!student) {
            console.log("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô currentSid:", currentSid);
            return;
        }

        // 3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç (‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢ trim)
        const teacherSub = String(d.subject).trim();
        const studentSub = String(currentSub).trim();
        const teacherGrade = String(d.grade).trim();
        const studentGrade = String(student.grade).trim();

        console.log(`üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏à‡∏ó‡∏¢‡πå: [‡∏ß‡∏¥‡∏ä‡∏≤: ${teacherSub} vs ${studentSub}] [‡∏´‡πâ‡∏≠‡∏á: ${teacherGrade} vs ${studentGrade}]`);

        // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡∏ñ‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á ‡πÅ‡∏•‡∏∞ ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ï‡∏£‡∏á (‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏±‡πâ‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏≤‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ß‡∏¥‡∏ä‡∏≤‡∏≠‡∏≠‡∏Å)
        if (teacherSub === studentSub && teacherGrade === studentGrade) {
            
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÑ‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
            const check = await db.ref(`donow_answers/${currentSid}`).once('value');
            if (check.exists()) {
                console.log("‚úÖ ‡∏Ñ‡∏∏‡∏ì‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏î‡πâ‡∏á‡∏ã‡πâ‡∏≥");
                return;
            }

            console.log("üöÄ ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ú‡πà‡∏≤‡∏ô! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ Do Now");
            
            // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ ID ‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö HTML)
            showPage('page-std-donow'); 
            
            // ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
            document.getElementById('dn-question-text').innerText = d.text;
            
            // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ 180 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÇ‡∏î‡∏¢‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏£‡∏π
            startCountdown(180, d.startTime);

        } else {
            console.log("‚ö†Ô∏è ‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏¢‡∏π‡πà");
        }
    });
}

function startCountdown(duration, startTime) {
    clearInterval(donowInterval);
    const clock = document.getElementById('dn-clock');
    
    donowInterval = setInterval(() => {
        const now = Date.now();
        const elapsed = Math.floor((now - startTime) / 1000);
        const remain = duration - elapsed;

        if (remain <= 0) {
            clearInterval(donowInterval);
            if(clock) clock.innerText = "0";
            if(document.getElementById('btn-dn-submit')) document.getElementById('btn-dn-submit').disabled = true;
            if(document.getElementById('std-dn-answer')) document.getElementById('std-dn-answer').disabled = true;
            Swal.fire('‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤!', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß', 'error');
        } else {
            if(clock) clock.innerText = remain;
        }
    }, 1000);
}

async function saveDoNow(isActive) {
    console.log("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô saveDoNow...");
    
    try {
        const grade = document.getElementById('dn-grade').value;
        const subject = document.getElementById('dn-sub').value;
        const text = document.getElementById('dn-msg').value;

        if (isActive && (!subject || !text || subject === "")) {
            Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå‡πÇ‡∏à‡∏ó‡∏¢‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'warning');
            return;
        }

        // --- [ ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà ] ---
        if (isActive) {
            console.log("‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÄ‡∏Å‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢...");
            await db.ref('donow_answers').remove(); 
        }

        const data = {
            active: isActive,
            grade: grade,
            subject: subject,
            text: text,
            startTime: isActive ? Date.now() : null
        };

        await db.ref('donow_config').set(data);

        if (isActive) {
            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÇ‡∏à‡∏ó‡∏¢‡πå‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!', 'success');
            monitorAnswers(); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•‡∏Ñ‡∏ô‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà
        } else {
            Swal.fire('‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö', '‡∏õ‡∏¥‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'info');
        }

    } catch (error) {
        console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:", error);
        Swal.fire('Error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
    }
}

// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î/‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
async function saveDoNow(isActive) {
    console.log("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô saveDoNow...");
    
    try {
        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ (‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î Error) ---
        const gradeElement = document.getElementById('dn-grade');
        const subElement = document.getElementById('dn-sub');
        const msgElement = document.getElementById('dn-msg');

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ Element ‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏´‡∏°
        if (!gradeElement || !subElement || !msgElement) {
            console.error("‡∏´‡∏≤ Element ‡πÑ‡∏°‡πà‡∏û‡∏ö! ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ID ‡πÉ‡∏ô HTML");
            return;
        }

        const grade = gradeElement.value; // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
        const subject = subElement.value; // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤
        const text = msgElement.value;    // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏à‡∏ó‡∏¢‡πå

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        if (isActive && (!grade || !subject || !text)) {
            Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á ‡∏ß‡∏¥‡∏ä‡∏≤ ‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå‡πÇ‡∏à‡∏ó‡∏¢‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'warning');
            return;
        }

        // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÄ‡∏Å‡πà‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà
        if (isActive) {
            await db.ref('donow_answers').remove(); 
        }

        const data = {
            active: isActive,
            grade: grade,
            subject: subject,
            text: text,
            startTime: isActive ? Date.now() : null
        };

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firebase
        await db.ref('donow_config').set(data);

        if (isActive) {
            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏™‡πà‡∏á‡πÇ‡∏à‡∏ó‡∏¢‡πå‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!', 'success');
            // ‚úÖ ‡∏•‡∏ö monitorAnswers(); ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ Popup ‡πÄ‡∏î‡πâ‡∏á
        } else {
            Swal.fire('‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö', '‡∏õ‡∏¥‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'info');
        }

    } catch (error) {
        console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:", error);
        Swal.fire('Error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
    }
}

function startDoNowTimer() {
    let count = 3;
    const btn = document.getElementById('btn-dn-submit');
    const timerEl = document.getElementById('dn-timer');
    const interval = setInterval(() => {
        timerEl.innerText = count;
        btn.innerText = `‡∏£‡∏≠‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö (${count})`;
        if (count <= 0) {
            clearInterval(interval);
            timerEl.innerText = "";
            btn.disabled = false;
            btn.innerText = "‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÑ‡∏î‡πâ";
            btn.classList.replace('bg-slate-400', 'bg-emerald-500');
        }
        count--;
    }, 1000);
}

async function submitDoNowAnswer() {
    const ansEl = document.getElementById('std-dn-answer');
    if (!ansEl || !ansEl.value.trim()) return Swal.fire('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö');

    const btnSubmit = document.getElementById('btn-dn-submit');
    if (btnSubmit) btnSubmit.disabled = true;

    try {
        const student = students.find(s => s.id === currentSid);
        
        // 1. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Firebase
        await db.ref(`donow_answers/${currentSid}`).set({
            name: student.name,
            grade: student.grade,
            subject: currentSub,
            answer: ansEl.value.trim(),
            time: new Date().toLocaleTimeString('th-TH'),
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });

        // 2. ‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏±‡∏ß‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤
        if (donowInterval) {
            clearInterval(donowInterval);
            donowInterval = null;
        }

        // 3. ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        await Swal.fire({
            icon: 'success',
            title: '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
            text: '‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
            timer: 1500,
            showConfirmButton: false
        });

        // 4. ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ login
        // ‡πÄ‡∏£‡∏≤‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏à‡∏ó‡∏¢‡πå Do Now ‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
        // ‡∏ã‡∏∂‡πà‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏á‡∏ß‡πà‡∏≤ "‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Firebase ‡πÅ‡∏•‡πâ‡∏ß" ‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤ "‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß" ‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        showStdDoNow(); 

    } catch (e) {
        console.error("Submit Error:", e);
        if (btnSubmit) btnSubmit.disabled = false;
        Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ' + e.message, 'error');
    }
}

async function clearAnswers() {
    const conf = await Swal.fire({
        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?',
        text: "‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: '‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
    });

    if (conf.isConfirmed) {
        await db.ref('donow_answers').remove();
        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ', 'success');
        if(typeof monitorAnswers === 'function') monitorAnswers(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ monitor
    }
}

function renderContent(t, c, h) {
    console.log("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤:", t); // ‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏ô Console ‡∏ß‡πà‡∏≤‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏´‡∏°
    
    const page = document.getElementById('std-content-view');
    const area = document.getElementById('content-area');
    
    if (!page || !area) {
        console.error("‡∏´‡∏≤‡πÑ‡∏≠‡∏î‡∏µ std-content-view ‡∏´‡∏£‡∏∑‡∏≠ content-area ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡πÉ‡∏ô HTML!");
        alert("‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏à‡πâ‡∏á‡∏Ñ‡∏£‡∏π");
        return;
    }

    showPage('std-content-view'); 
    document.getElementById('content-title').innerText = t;
    document.getElementById('content-border').style.borderColor = c;
    area.innerHTML = h;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö"
function monitorAnswers() {
    const popup = document.getElementById('REPORT_POPUP');
    if (popup) {
        popup.style.display = 'flex'; // ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á Popup
        
        // 1. ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡∏à‡∏≤‡∏Å Excel ‡∏°‡∏≤‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏î‡∏£‡∏≠‡∏õ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
        populateGradeFilterReport(); 
        
        // 2. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('f-date').value = today;
        
        // 3. ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏ß‡πà‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
        document.getElementById('answer-list-report').innerHTML = '<tr><td colspan="4" style="text-align:center; padding:40px; color:#94a3b8;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏ß‡∏¥‡∏ä‡∏≤ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤"</td></tr>';
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Excel (‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠ students)
function populateGradeFilterReport() {
    const gradeSelect = document.getElementById('f-grade');
    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô 'students' ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Excel ‡∏à‡∏£‡∏¥‡∏á‡πÜ
    const data = (typeof students !== 'undefined') ? students : [];
    
    if (data.length === 0) {
        gradeSelect.innerHTML = '<option value="">-- ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Excel --</option>';
        return;
    }

    const grades = [...new Set(data.map(item => item.grade || item['‡∏ä‡∏±‡πâ‡∏ô']))].filter(g => g).sort();
    gradeSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á --</option>';
    grades.forEach(g => {
        gradeSelect.innerHTML += `<option value="${g}">${g}</option>`;
    });
}

async function fetchDoNowAnswers() {
    const list = document.getElementById('answer-list-report');
    const gradeF = document.getElementById('f-grade').value;
    const subjectF = document.getElementById('f-subject').value;
    const dateF = document.getElementById('f-date').value;

    if (!gradeF) { 
        Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô', 'warning'); 
        return; 
    }

    list.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px;">‚åõ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>';

    try {
        const snapshot = await db.ref('donow_answers').once('value');
        const data = snapshot.val();
        list.innerHTML = '';

        if (!data) {
            list.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö</td></tr>';
            return;
        }

        let count = 0;
        Object.keys(data).forEach(key => {
            const item = data[key];
            
            // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á
            const matchGrade = item.grade === gradeF;
            const matchSubject = !subjectF || item.subject === subjectF;
            const matchDate = !dateF || !item.date || item.date === dateF;

            if (matchGrade && matchSubject && matchDate) {
                count++;
               
                // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å Excel (students) ---
                // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ Excel ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
                const stdInfo = (typeof students !== 'undefined') 
                    ? students.find(s => (s['‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'] || s.name) === item.name) 
                    : null;

                // ‡∏î‡∏∂‡∏á‡∏£‡∏´‡∏±‡∏™‡∏à‡∏≤‡∏Å Firebase ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Excel ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏µ‡∏Å‡πÉ‡∏´‡πâ‡∏Ç‡∏∂‡πâ‡∏ô '-'
                const displayCode = item.id || (stdInfo ? (stdInfo['‡∏£‡∏´‡∏±‡∏™'] || stdInfo.id) : '-');
                // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏≤‡∏Å Firebase ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Excel
                const displayNick = item.nickname || (stdInfo ? (stdInfo['‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô'] || stdInfo.nickname) : '-');
                
                list.innerHTML += `
                    <tr style="border-bottom:1px solid #f1f5f9;">
                        <td style="padding:15px; color:#4f46e5;">${displayCode}</td>
                        <td style="padding:15px; color:#4f46e5;">${item.name}</td> 
                        <td style="padding:15px; color:#4f46e5;">${displayNick}</td>
                        <td style="padding:15px; color:#4f46e5;">${item.grade}</td>
                        <td style="padding:15px; color:#4f46e5; font-weight:bold;">${item.answer}</td>
                        <td style="padding:15px; font-size:15px; color:gray;">${item.time || '-'}</td>
                    </tr>`;
            }
        });

        if (count === 0) {
            list.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
        }
    } catch (e) {
        list.innerHTML = '<tr><td colspan="6" style="text-align:center; color:red;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</td></tr>';
    }
}

// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡πà‡∏°)
function populateRandomGrade() {
    console.log("‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...");
    const gradeSelect = document.getElementById('r-grade');
    
    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á Select ‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÑ‡∏´‡∏°
    if (!gradeSelect) {
        console.error("‡∏´‡∏≤ id='r-grade' ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ HTML");
        return;
    }

    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏≤‡∏Å Excel (‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ students)
    const data = (typeof students !== 'undefined') ? students : [];
    
    if (data.length === 0) {
        gradeSelect.innerHTML = '<option value="">-- ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô --</option>';
        return;
    }

    // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á
    const grades = [...new Set(data.map(item => item.grade || item['‡∏ä‡∏±‡πâ‡∏ô']))].filter(g => g).sort();
    
    gradeSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏° --</option>';
    grades.forEach(g => {
        gradeSelect.innerHTML += `<option value="${g}">${g}</option>`;
    });
    console.log("‡πÇ‡∏´‡∏•‡∏î‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢:", grades);
}

// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á
function loadStudentsForRandom(grade) {
    const listContainer = document.getElementById('student-selector-list');
    const data = (typeof students !== 'undefined') ? students : [];
    
    if (!grade) {
        listContainer.innerHTML = '<p class="col-span-2 text-center text-slate-400 py-10 italic">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>';
        return;
    }

    const filtered = data.filter(s => (s.grade || s['‡∏ä‡∏±‡πâ‡∏ô']) === grade);
    listContainer.innerHTML = '';

    filtered.forEach((s, index) => {
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏£‡∏´‡∏±‡∏™ ‡πÅ‡∏•‡∏∞ ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏ì‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏ô Excel ‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô)
        const code = s['‡∏£‡∏´‡∏±‡∏™'] || s.id || '???';
        const nickname = s['‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô'] || s.nickname || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô';
        const fullName = s['‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'] || s.name;

        listContainer.innerHTML += `
            <label class="flex items-center gap-3 bg-slate-50 p-3 rounded-xl cursor-pointer hover:bg-orange-50 transition-colors border border-transparent hover:border-orange-200">
                <input type="checkbox" class="random-chk w-5 h-5 accent-orange-500" 
                       value="${code} ${nickname}" 
                       data-fullname="${fullName}">
                <div class="flex flex-col">
                    <span class="text-xs text-slate-400">${code}</span>
                    <span class="text-sm font-bold text-slate-700">${nickname}</span>
                </div>
            </label>
        `;
    });
}

// 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î / ‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
function selectAllStudents(isSelect) {
    const chks = document.querySelectorAll('.random-chk');
    chks.forEach(c => c.checked = isSelect);
}

// 4. üî• ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å: ‡∏™‡∏∏‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠ (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏∏‡πà‡∏°)
function startRandomSpin() {
    // 1. ‡∏î‡∏∂‡∏á Checkbox ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    const checkedBoxes = Array.from(document.querySelectorAll('.random-chk:checked'));
    const selectedStudents = checkedBoxes.map(c => c.value);
    
    if (selectedStudents.length === 0) {
        Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏∏‡πà‡∏°', 'warning');
        return;
    }

    // 2. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const removeMode = document.querySelector('input[name="random-mode"]:checked').value === 'remove';

    const spinText = document.getElementById('spin-text');
    let counter = 0;
    const totalSpins = 30; 
    const speed = 100;    

    const btn = document.querySelector("button[onclick='startRandomSpin()']");
    btn.disabled = true;
    btn.classList.add('opacity-50', 'cursor-not-allowed');

    const timer = setInterval(() => {
        const randomIndex = Math.floor(Math.random() * selectedStudents.length);
        spinText.innerText = selectedStudents[randomIndex];
        spinText.className = "text-4xl font-black text-slate-400";
        
        counter++;

        if (counter >= totalSpins) {
            clearInterval(timer);
            
            // ‡∏™‡∏∏‡πà‡∏°‡∏´‡∏≤‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞‡∏à‡∏≤‡∏Å Index
            const winnerIndex = Math.floor(Math.random() * selectedStudents.length);
            const winner = selectedStudents[winnerIndex];
            
            spinText.innerHTML = `
                <div class="flex flex-col items-center animate-bounce">
                    <span class="text-2xl text-orange-400 font-bold mb-2">‡∏ú‡∏π‡πâ‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ‡∏Ñ‡∏∑‡∏≠</span>
                    <span class="text-6xl font-black text-orange-600 drop-shadow-lg">${winner}</span>
                </div>
            `;
            
            // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î Remove ---
            if (removeMode) {
                // ‡∏´‡∏≤ Checkbox ‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏¥‡πä‡∏Å‡∏≠‡∏≠‡∏Å
                checkedBoxes[winnerIndex].checked = false;
                
                // (Option) ‡πÄ‡∏û‡∏¥‡πà‡∏° Effect ‡πÉ‡∏´‡πâ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏î‡∏π‡∏à‡∏≤‡∏á‡∏•‡∏á
                const row = checkedBoxes[winnerIndex].closest('div');
                if(row) row.style.opacity = "0.5";
            }
            
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');

            if (typeof confetti === 'function') {
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            }
        }
    }, speed);
}

let codeReader = new ZXing.BrowserQRCodeReader();
let selectedDeviceId;
let currentScannedStudent = null;

// 1. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ä‡∏≤‡∏à‡∏≤‡∏Å Excel
function populateCheckGrade() {
    const gradeSelect = document.getElementById('c-grade');
    if (!gradeSelect) return;
    const data = (typeof students !== 'undefined') ? students : [];
    const grades = [...new Set(data.map(item => item.grade || item['‡∏ä‡∏±‡πâ‡∏ô']))].filter(g => g).sort();
    gradeSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á --</option>';
    grades.forEach(g => { gradeSelect.innerHTML += `<option value="${g}">${g}</option>`; });
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏¥‡∏ä‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô (Scan & Check)
function updateCheckSubjectFilter(g) {
    const sel = document.getElementById('c-subject'); // ID ‡∏Ç‡∏≠‡∏á Select ‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô
    if (!sel) return;

    const subs = new Set();
    // ‡∏Å‡∏£‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡∏≤‡∏°‡∏´‡πâ‡∏≠‡∏á (g) ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏î‡∏∂‡∏á‡∏ß‡∏¥‡∏ä‡∏≤‡∏à‡∏≤‡∏Å Object subjects
    students.filter(s => s.grade === g).forEach(s => {
        // ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á s.subjects ‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        if (s.subjects) {
            Object.entries(s.subjects).forEach(([n, v]) => {
                if (v) subs.add(n); 
            });
        }
    });

    sel.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤ --</option>` + 
                    Array.from(subs).sort().map(s => `<option value="${s}">${s}</option>`).join('');
    
    console.log(`‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏¥‡∏ä‡∏≤‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á ${g} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
    renderStudentChecklist(g);
}

// ‡∏õ‡∏£‡∏±‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏° ID 'c-grade' (Select ‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô)

function updateSelectMenus() {
    const gs = [...new Set(students.map(s => s.grade))].sort();
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° 'c-grade' ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ID ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
    ['t-grade','sc-grade','st-grade','dn-grade','qr-grade-sel','tr-grade', 'c-grade', 'q-grade'].forEach(id => {
        const el = document.getElementById(id); 
        if(el) el.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á --</option>` + gs.map(g => `<option value="${g}">${g}</option>`).join('');
    });
}

// 2. ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á
let currentCameraIndex = 0; // ‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô

// --- [2] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á (‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™) ---
async function startScanner() {
    try {
        codeReader.reset(); 
        const videoInputDevices = await codeReader.listVideoInputDevices();
        
        if (videoInputDevices.length === 0) {
            Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á', '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ', 'error');
            return;
        }

        selectedDeviceId = videoInputDevices[currentCameraIndex].deviceId;
        
        // --- [‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ] ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Input ‡πÉ‡∏´‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á ---
        const manualInput = document.getElementById('manual-id1');
        if (manualInput) {
            manualInput.focus();
            // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏î Enter ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å checkByInput ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            manualInput.onkeypress = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    checkByInput();
                }
            };
        }

        codeReader.decodeFromVideoDevice(selectedDeviceId, 'check-video', (result, err) => {
            if (result) {
                console.log("Scanned:", result.text);
                processStudentScan(result.text);
                
                const audio = new Audio('https://www.soundjay.com/buttons/beep-07a.mp3');
                audio.play().catch(() => {});
                if (navigator.vibrate) navigator.vibrate(100);
            }
        });
    } catch (err) {
        console.error(err);
        Swal.fire('‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á', err.message, 'error');
    }
}


// 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á
async function switchCamera() {
    try {
        // 1. ‡∏´‡∏¢‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏´‡πâ‡∏™‡∏ô‡∏¥‡∏ó‡∏Å‡πà‡∏≠‡∏ô (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å!)
        if (codeReader) {
            await codeReader.reset(); 
        }

        // 2. ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
        const videoInputDevices = await codeReader.listVideoInputDevices();
        
        if (videoInputDevices.length > 1) {
            // 3. ‡∏™‡∏•‡∏±‡∏ö Index ‡∏Å‡∏•‡πâ‡∏≠‡∏á
            currentCameraIndex = (currentCameraIndex + 1) % videoInputDevices.length;
            console.log("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà:", currentCameraIndex);

            // 4. ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (200-300ms) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Hardware ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤
            setTimeout(async () => {
                await startScanner(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ
            }, 300);

        } else {
            Swal.fire({
                icon: 'info',
                title: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏™‡∏•‡∏±‡∏ö',
                text: '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô',
                timer: 2000
            });
            // ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÅ‡∏ï‡πà‡∏à‡∏≠‡∏î‡∏≥ ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡∏°‡πà
            startScanner();
        }
    } catch (err) {
        console.error("‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ:", err);
        Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ', 'error');
    }
}

function stopCamera() {
    codeReader.reset();
}

// 3. ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡πÅ‡∏Å‡∏ô‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏à‡∏≠
async function processStudentScan(scannedText) {
    try {
        const cleanCode = scannedText.trim();
        const grade = document.getElementById('c-grade').value;
        const subject = document.getElementById('c-subject').value;

        // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á/‡∏ß‡∏¥‡∏ä‡∏≤‡∏¢‡∏±‡∏á
        if (!grade || !subject) {
            if (typeof Swal !== 'undefined') {
                Swal.fire({ icon: 'warning', title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡πà‡∏≠‡∏ô' });
            } else {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡πà‡∏≠‡∏ô');
            }
            return;
        }

        // 2. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡πÄ‡∏û‡∏¥‡πà‡∏° .trim() ‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ù‡∏±‡πà‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏ù‡∏á)
        const std = students.find(s => {
            const sCode = (s.code || s.id || s['‡∏£‡∏´‡∏±‡∏™'] || "").toString().trim();
            const sGrade = (s.grade || s['‡∏ä‡∏±‡πâ‡∏ô'] || "").toString().trim();
            const selectedGrade = grade.toString().trim();
            
            return sCode === cleanCode && sGrade === selectedGrade;
        });

        // 3. ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        if (!std) {
            console.error("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:", cleanCode, "‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á:", grade);
            
            // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ô‡πÄ‡∏Å‡πà‡∏≤
            currentScannedStudent = null; 
            if(document.getElementById('student-result-card')) document.getElementById('student-result-card').classList.add('hidden');
            if(document.getElementById('scan-placeholder')) document.getElementById('scan-placeholder').classList.remove('hidden');

            // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ Swal ‡πÑ‡∏´‡∏° ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ alert ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤‡πÅ‡∏ó‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö)
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'error',
                    title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ',
                    html: `‡∏£‡∏´‡∏±‡∏™ <b>"${cleanCode}"</b> <br>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á <b>${grade}</b>`,
                    confirmButtonColor: '#ef4444',
                    timer: 3000
                });
            } else {
                alert(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™ "${cleanCode}" ‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á ${grade}`);
            }
            return; 
        }

        // 4. ‡∏Å‡∏£‡∏ì‡∏µ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥)
        currentScannedStudent = std;
        
        document.getElementById('scan-placeholder').classList.add('hidden');
        document.getElementById('student-result-card').classList.remove('hidden');
        
        document.getElementById('res-code').innerText = `‡∏£‡∏´‡∏±‡∏™: ${cleanCode}`;
        document.getElementById('res-name').innerText = std.name || std['‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'];
        document.getElementById('res-nick').innerText = `‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô: ${std.nickname || '-'}`;
        
        // ‡πÉ‡∏™‡πà‡∏£‡∏π‡∏õ
        const studentImg = document.getElementById('student-photo');
        if (studentImg) {
            const imgSrc = std.image || std.photo || std['‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û'] || `photos/${cleanCode}.jpg`;
            studentImg.src = imgSrc;
            studentImg.onerror = function() {
                this.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(std.name || 'Student')}&background=random`;
            };
        }

        updateStudentUIStatus(cleanCode);
        autoSaveWork(cleanCode, std.name, grade, subject);

    } catch (err) {
        console.error("Critical Error in processStudentScan:", err);
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
async function autoSaveWork(id, name, grade, subject) {
    const log = {
        studentId: id,
        name: name,
        grade: grade,
        subject: subject,
        date: new Date().toLocaleDateString('th-TH'),
        time: new Date().toLocaleTimeString('th-TH'),
        timestamp: firebase.database.ServerValue.TIMESTAMP
    };
    await db.ref('work_checks').push(log);
    
    // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏•‡πá‡∏Å‡πÜ (Toast) ‡∏ß‡πà‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß
    const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1500 });
    Toast.fire({ icon: 'success', title: `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á ${name} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢` });
}

// 4. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞ Export (‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ library SheetJS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export)
async function confirmWorkSubmit() {
    const subject = document.getElementById('c-subject').value;
    if(!subject) return Swal.fire('‡∏•‡∏∑‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤','‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡∏£‡∏ß‡∏à','warning');

    const log = {
        studentId: currentScannedStudent.code || currentScannedStudent['‡∏£‡∏´‡∏±‡∏™'],
        name: currentScannedStudent.name || currentScannedStudent['‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'],
        grade: currentScannedStudent.grade || currentScannedStudent['‡∏ä‡∏±‡πâ‡∏ô'],
        subject: subject,
        date: new Date().toLocaleDateString(),
        time: new Date().toLocaleTimeString(),
        timestamp: firebase.database.ServerValue.TIMESTAMP
    };

    await db.ref('work_checks').push(log);
    Swal.fire({ title: '‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', icon: 'success', timer: 1000, showConfirmButton: false });
    loadCheckHistory(log.studentId, subject);
}

// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á
function renderStudentChecklist(grade) {
    const grid = document.getElementById('student-checklist-grid');
    if (!grid) return;

    grid.innerHTML = ''; 
    // ‡∏Å‡∏£‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    const roomStudents = students.filter(s => (s.grade || s['‡∏ä‡∏±‡πâ‡∏ô']) === grade);
    roomStudents.sort((a, b) => (a.no || 0) - (b.no || 0));

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ---
    const totalStdEl = document.getElementById('total-std');
    const sentEl = document.getElementById('total-sent');
    const remainEl = document.getElementById('total-remain');

    if (totalStdEl) totalStdEl.innerText = roomStudents.length;
    if (sentEl) sentEl.innerText = '0';
    if (remainEl) remainEl.innerText = roomStudents.length;
    // -------------------------------------------

    roomStudents.forEach(std => {
        const id = std.code || std.id || std['‡∏£‡∏´‡∏±‡∏™'];
        const name = std.name || std['‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'];
        const nick = std.nickname || std['‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô'] || '-';
        const imgSrc = std.image || std.photo || std['‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û'] || `photos/${id}.jpg`;

        grid.innerHTML += `
            <div id="check-box-${id}" class="relative flex items-center gap-4 p-4 rounded-[2rem] border-2 border-slate-200 bg-white transition-all duration-500 overflow-hidden shadow-sm">
                <div id="side-bar-${id}" class="absolute left-0 top-0 bottom-0 w-3 bg-slate-300 transition-all duration-500"></div>
                <div class="relative shrink-0 ml-2">
                    <img src="${imgSrc}" 
                         onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random'"
                         class="w-20 h-20 rounded-2xl object-cover border-2 border-white shadow-md bg-slate-100">
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">‡∏£‡∏´‡∏±‡∏™: ${id}</p>
                    <p class="text-lg font-black text-slate-800 truncate">${name}</p>
                    <p class="text-sm font-bold text-slate-500">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô: ${nick}</p>
                </div>
                <div class="text-right pr-2">
                    <div id="status-badge-${id}" class="flex flex-col items-center">
                        <span class="text-[2rem] leading-none mb-1 opacity-20">‚ûñ</span>
                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-tighter">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á</span>
                    </div>
                </div>
            </div>
        `;
    });
}

// 2. ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏Ç‡πâ‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á
async function processStudentScan(scannedText) {
    try {
        const cleanCode = scannedText.trim();
        const gradeEl = document.getElementById('c-grade');
        const subjectEl = document.getElementById('c-subject');

        // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ Dropdown ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏´‡∏°
        if (!gradeEl || !subjectEl) {
            console.error("‡∏´‡∏≤ Element c-grade ‡∏´‡∏£‡∏∑‡∏≠ c-subject ‡πÑ‡∏°‡πà‡∏û‡∏ö");
            return;
        }

        const grade = gradeEl.value;
        const subject = subjectEl.value;

        // 2. ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á/‡∏ß‡∏¥‡∏ä‡∏≤
        if (!grade || !subject) {
            Swal.fire({ icon: 'warning', title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πÅ‡∏Å‡∏ô' });
            return;
        }

        // 3. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ students ‡πÑ‡∏´‡∏°)
        if (typeof students === 'undefined' || !Array.isArray(students)) {
            Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (‡∏•‡∏∑‡∏°‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Excel?)', 'error');
            return;
        }

        const std = students.find(s => {
            const sCode = (s.code || s.id || s['‡∏£‡∏´‡∏±‡∏™'] || "").toString().trim();
            const sGrade = (s.grade || s['‡∏ä‡∏±‡πâ‡∏ô'] || "").toString().trim();
            return sCode === cleanCode && sGrade === grade.trim();
        });

        

        // 5. ‡∏Å‡∏£‡∏ì‡∏µ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥)
        if (!std) return;
        // --- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì) ---
        document.getElementById('scan-placeholder').classList.add('hidden');
        document.getElementById('student-result-card').classList.remove('hidden');
        document.getElementById('res-code').innerText = `‡∏£‡∏´‡∏±‡∏™: ${cleanCode}`;
        document.getElementById('res-name').innerText = std.name || std['‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'];
        document.getElementById('res-nick').innerText = `‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô: ${std.nickname || '-'}`;
        
        const studentImg = document.getElementById('student-photo');
        if (studentImg) {
            studentImg.src = std.image || std.photo || `photos/${cleanCode}.jpg`;
            studentImg.onerror = function() { this.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(std.name)}&background=random`; };
        }
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        if (document.getElementById('scan-placeholder')) document.getElementById('scan-placeholder').classList.add('hidden');
        if (document.getElementById('student-result-card')) document.getElementById('student-result-card').classList.remove('hidden');
        
        document.getElementById('res-code').innerText = `‡∏£‡∏´‡∏±‡∏™: ${cleanCode}`;
        document.getElementById('res-name').innerText = std.name || std['‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'];
        document.getElementById('res-nick').innerText = `‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô: ${std.nickname || '-'}`;
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        updateStudentUIStatus(cleanCode);
        autoSaveWork(cleanCode, std.name, grade, subject);

    } catch (error) {
        // ‡∏´‡∏≤‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡∏û‡∏±‡∏á‡∏ï‡∏£‡∏á‡πÑ‡∏´‡∏ô ‡πÉ‡∏´‡πâ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Error ‡∏ô‡∏±‡πâ‡∏ô‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÄ‡∏•‡∏¢
        console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:", error);
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡∏™‡πÅ‡∏Å‡∏ô: " + error.message);
    }
}

// 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß
function updateStudentUIStatus(studentId) {
    const box = document.getElementById(`check-box-${studentId}`);
    const badge = document.getElementById(`status-badge-${studentId}`);
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ô‡∏µ‡πâ‡∏à‡∏£‡∏¥‡∏á ‡πÅ‡∏•‡∏∞ "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏ñ‡∏π‡∏Å‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏™‡πà‡∏á" (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏™‡πÅ‡∏Å‡∏ô‡∏ã‡πâ‡∏≥‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏Ç‡∏•‡∏î‡∏°‡∏±‡πà‡∏ß)
    if (box && badge && badge.getAttribute('data-status') !== 'sent') {
        
        // --- 1. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πà‡∏ô (‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏ó‡∏±‡πâ‡∏á‡πÉ‡∏ö) ---
        box.className = "relative flex items-center gap-4 p-4 rounded-[2rem] border-2 border-emerald-400 bg-emerald-500 shadow-lg shadow-emerald-200 scale-[1.03] z-10 transition-all duration-500 overflow-hidden";
        
        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÉ‡∏ô Card ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        box.querySelectorAll('p, span').forEach(el => {
            el.classList.remove('text-slate-400', 'text-slate-800', 'text-slate-500', 'text-emerald-500');
            el.classList.add('text-white');
        });

        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Emoji ‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        badge.innerHTML = `<span class="text-[2.5rem] leading-none mb-1 animate-bounce">‚úÖ</span><span class="text-[10px] font-black text-white uppercase tracking-tighter">‡∏™‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</span>`;
        badge.setAttribute('data-status', 'sent');

        // --- 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏™‡∏£‡∏∏‡∏õ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤) ---
        const sentEl = document.getElementById('total-sent');
        const remainEl = document.getElementById('total-remain');

        if (sentEl && remainEl) {
            let currentSent = parseInt(sentEl.innerText) || 0;
            let currentRemain = parseInt(remainEl.innerText) || 0;

            sentEl.innerText = currentSent + 1;
            remainEl.innerText = Math.max(0, currentRemain - 1);
        }
        
        console.log(`‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏´‡∏±‡∏™ ${studentId} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
    }
}

let currentFacingMode = 'environment'; // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠ (‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™)
async function processAttendance(sid) {
    if(!currentSes) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° [‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö Global Sync] ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö', 'warning');
    
    const cleanGr = currentSes.grade.replace(/[.#$[\]]/g, "_");
    const cleanSub = currentSes.subject.replace(/[.#$[\]]/g, "_");
    const aid = currentSes.id;

    const std = students.find(s => String(s.id) === String(sid).trim());
    
    // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
    if(!std) {
        if(window.soundError) soundError.play();
        return Swal.fire({ title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™!', icon: 'error', timer: 1500, showConfirmButton: false });
    }

    if(std.grade !== currentSes.grade) {
        if(window.soundError) soundError.play();
        return Swal.fire({ 
            title: '‡∏ú‡∏¥‡∏î‡∏´‡πâ‡∏≠‡∏á!', 
            text: `${std.name} ‡∏≠‡∏¢‡∏π‡πà‡∏´‡πâ‡∏≠‡∏á ${std.grade}`, 
            icon: 'warning', 
            timer: 1500, 
            showConfirmButton: false 
        });
    }

    // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    const now = new Date(); 
    const timeStr = now.toLocaleTimeString('th-TH', { hour:'2-digit', minute:'2-digit' });
    const [sH, sM] = currentSes.start.split(':'); 
    const startTime = new Date(currentSes.date); 
    startTime.setHours(parseInt(sH), parseInt(sM), 0);
    const status = ((now - startTime) / 60000) > 15 ? "‡∏™‡∏≤‡∏¢" : "‡∏°‡∏≤";
    
    try {
        // 3. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firebase
        await db.ref(`attendance/${cleanGr}/${cleanSub}/${aid}/${std.id}`).set({ 
            name: std.name, 
            time: timeStr, 
            status: status 
        });

        if(window.soundSuccess) soundSuccess.play();
        
        // 4. ‡πÅ‡∏™‡∏î‡∏á Pop-up ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        await Swal.fire({
            title: `<span class="${status === '‡∏°‡∏≤' ? 'text-emerald-600' : 'text-amber-500'} font-black text-3xl">${status === "‡∏°‡∏≤" ? "‚úÖ ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" : "‚è≥ ‡∏°‡∏≤‡∏™‡∏≤‡∏¢"}</span>`,
            html: `
                <div class="flex flex-col items-center mt-2">
                    <img src="${std.photo || `https://api.dicebear.com/7.x/initials/svg?seed=${std.id}`}" 
                         class="w-56 h-56 rounded-[2.5rem] object-cover border-8 border-white shadow-2xl mb-4">
                    <div class="text-4xl font-black text-slate-800">${std.name}</div>
                    <div class="text-xl font-bold text-slate-400 mt-1">‡πÄ‡∏ß‡∏•‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ${timeStr}</div>
                </div>`,
            timer: 2000,
            timerProgressBar: true,
            showConfirmButton: false,
            backdrop: `rgba(0,0,0,0.4)`
        });
        return true;
    } catch (err) {
        console.error("Save Error:", err);
        return false;
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° OK
async function checkManual() {
    const input = document.getElementById('manual-id');
    const id = input.value.trim();
    if(!id) return;

    const success = await processAttendance(id);
    if(success) {
        input.value = '';
        input.focus();
    }
}

async function checkByInput() {
    // 1. ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å ID
    let el = document.getElementById('manual-id1');
    
    // 2. ‡∏ñ‡πâ‡∏≤‡∏î‡∏∂‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Class (‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß)
    if (!el || el.value === "") {
        el = document.querySelector('.manual-input-field');
    }

    if (!el) {
        console.error("‡∏´‡∏≤‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏ó‡∏±‡πâ‡∏á ID ‡πÅ‡∏•‡∏∞ Class");
        return;
    }

    const sid = el.value.trim();

    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
    if (sid === "") {
        Swal.fire({
            title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™',
            text: '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
            icon: 'warning',
            timer: 1500,
            showConfirmButton: false
        });
        el.focus(); // ‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏õ‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏±‡πâ‡∏ô
        return;
    }

    try {
        console.log("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡πÑ‡∏î‡πâ:", sid);
        
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏´‡∏•‡∏±‡∏Å
        await processStudentScan(sid);

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à -> ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤
        el.value = '';
        el.focus();

    } catch (err) {
        console.error("Error:", err);
    }
}

// ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏î Enter (‡∏ß‡∏≤‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå)
document.addEventListener('keydown', function(e) {
    if (e.target && (e.target.id === 'manual-id1' || e.target.classList.contains('manual-input-field'))) {
        if (e.key === 'Enter') {
            e.preventDefault();
            checkByInput();
        }
    }
});

// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ï‡∏¥‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏•‡∏á‡πÉ‡∏ô Select (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤)
function initializeCopySelects() {
    const gradeSelect = document.getElementById('copy-grade');
    
    // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (students)
    const uniqueGrades = [...new Set(students.map(s => s.grade))].sort();
    
    if (uniqueGrades.length > 0) {
        gradeSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>' + 
            uniqueGrades.map(g => `<option value="${g}">${g}</option>`).join('');
    }
}

// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß
function updateCopySubFilter(selectedGrade) {
    const subSelect = document.getElementById('copy-sub');
    subSelect.innerHTML = '<option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏¥‡∏ä‡∏≤...</option>';

    if (!selectedGrade) {
        subSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤</option>';
        return;
    }

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô Database (score_templates)
    // ‡∏´‡∏£‡∏∑‡∏≠‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ subjects ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
    db.ref('score_templates').once('value', (snapshot) => {
        const templates = snapshot.val() || {};
        let options = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤</option>';
        
        // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏´‡∏≤‡∏ß‡πà‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡πÑ‡∏´‡∏ô‡∏ö‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ
        Object.keys(templates).forEach(subName => {
            options += `<option value="${subName}">${subName}</option>`;
        });
        
        subSelect.innerHTML = options;
    });
}

// 3. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î Page
window.addEventListener('load', () => {
    // ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• students ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏ï‡∏¥‡∏° Select
    setTimeout(initializeCopySelects, 1000); 
});

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ Admin Exam
async function initAdminExamPage() {
    const selectGrade = document.getElementById('select-grade');
    if (!selectGrade) return;

    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ Popup ‡∏´‡∏°‡∏∏‡∏ô)
    selectGrade.innerHTML = '<option value="">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...</option>';

    try {
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
        const snap = await db.ref('students').once('value');
        const stdData = snap.val();

        if (!stdData) {
            selectGrade.innerHTML = '<option value="">‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>';
            return;
        }

        window.allStudentData = stdData; // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≠‡∏á‡∏ß‡∏¥‡∏ä‡∏≤

        // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (grade) ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡∏≠‡∏≠‡∏Å
        const grades = [...new Set(Object.values(stdData).map(s => s.grade))]
                        .filter(g => g) // ‡∏ï‡∏±‡∏î‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏≠‡∏Å
                        .sort();        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö ‡∏õ.1, ‡∏õ.2...

        if (grades.length === 0) {
            selectGrade.innerHTML = '<option value="">‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</option>';
        } else {
            selectGrade.innerHTML = '<option value="">--- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ---</option>' + 
                grades.map(g => `<option value="${g}">${g}</option>`).join('');
        }

    } catch (error) {
        console.error(error);
        selectGrade.innerHTML = '<option value="">‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</option>';
    }
}

// ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô -> ‡∏Å‡∏£‡∏≠‡∏á‡∏ß‡∏¥‡∏ä‡∏≤
function filterSubjectsByGrade() {
    const grade = document.getElementById('select-grade').value;
    const selectSub = document.getElementById('select-subject');
    const methodOpts = document.getElementById('method-options');
    
    if (!grade) {
        selectSub.disabled = true;
        methodOpts.classList.add('opacity-50', 'pointer-events-none');
        return;
    }

    let subList = new Set();
    Object.values(window.allStudentData).filter(s => s.grade === grade).forEach(s => {
        if (s.subjects) Object.keys(s.subjects).forEach(subj => subList.add(subj));
    });

    selectSub.disabled = false;
    selectSub.innerHTML = '<option value="">--- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤ ---</option>' + 
        [...subList].sort().map(s => `<option value="${s}">${s}</option>`).join('');
}

// ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤ -> ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£
function showImportMethods() {
    const sub = document.getElementById('select-subject').value;
    const methodOpts = document.getElementById('method-options');
    if (sub) {
        methodOpts.classList.remove('opacity-50', 'pointer-events-none');
        currentSub = sub; // ‡πÄ‡∏Å‡πá‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏Å‡∏•‡∏≤‡∏á
    }
}

// ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
function preparePasteMode() {
    document.getElementById('exam-work-area').classList.remove('hidden');
    document.getElementById('paste-section').classList.remove('hidden');
    document.getElementById('main-paste-area').value = "";
}

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏° (‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏°)
async function loadExamDataDirect() {
    if (!currentSub) return;
    loadExamData(currentSub); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (Smart Paste)
function processSmartPaste() {
    try {
        const area = document.getElementById('main-paste-area');
        const text = area.value.trim();
        
        if (!text) return Swal.fire('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô', '', 'warning');

        // ‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö
        const blocks = text.split(/\n\s*(?:‡∏Ç‡πâ‡∏≠\s*)?\d+[\.\)]\s+/).filter(b => b.trim() !== "");
        let newQuestions = [];

        blocks.forEach((block) => {
            const parts = block.split(/\s*(?:[‡∏Å-‡∏áa-dA-D1-4])[\.\)]\s+/);
            if (parts.length >= 2) {
                newQuestions.push({
                    title: parts[0].trim(),
                    options: parts.slice(1, 5).map(o => o.trim()),
                    correct: 0, // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡πâ‡∏≠ 1 ‡∏ñ‡∏π‡∏Å
                    point: 1
                });
            }
        });

        if (newQuestions.length > 0) {
            currentQuestions = newQuestions;
            
            // --- ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô: ‡πÅ‡∏™‡∏î‡∏á‡∏™‡πà‡∏ß‡∏ô Preview ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ---
            document.getElementById('preview-section').classList.remove('hidden');
            renderQuestions(); // ‡∏ß‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏•‡∏á‡πÉ‡∏ô #questions-list
            
            // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏•‡∏á‡πÑ‡∏õ‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
            document.getElementById('preview-section').scrollIntoView({ behavior: 'smooth' });

            Swal.fire({
                icon: 'success',
                title: '‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                text: `‡∏û‡∏ö ${newQuestions.length} ‡∏Ç‡πâ‡∏≠ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏Ñ‡∏£‡∏±‡∏ö`,
                timer: 2000
            });
        } else {
            Swal.fire('‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏•‡∏Ç‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞ ‡∏Å.‡∏Ç.‡∏Ñ.‡∏á.', 'error');
        }
    } catch (e) {
        Swal.fire('Error', e.message, 'error');
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö (‡∏ù‡∏±‡πà‡∏á‡∏Ñ‡∏£‡∏π)
async function saveAllQuestions() {
    if (!currentSub || currentQuestions.length === 0) {
        return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'warning');
    }

    try {
        Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', didOpen: () => Swal.showLoading() });
        
        // 1. ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏°‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô ‡∏õ.6/1)
        let gradeRaw = document.getElementById('select-grade').value;

        // 2. ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏ï‡πâ‡∏≠‡∏á‡∏´‡πâ‡∏≤‡∏° (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô . ‡πÅ‡∏•‡∏∞ / ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô _)
        // ‡∏õ.6/1 ‡∏à‡∏∞‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô ‡∏õ_6_1
        let safeGrade = gradeRaw.replace(/[\.\/]/g, '_');
        let safeSub = currentSub.replace(/[\.\/]/g, '_');

        // 3. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Path ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
        await db.ref(`exam_data/${safeGrade}/${safeSub}`).set({
            originalGrade: gradeRaw, // ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÑ‡∏î‡πâ
            questions: currentQuestions,
            createdAt: new Date().getTime(),
            status: 'active'
        });

        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
    } catch (e) {
        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏°‡∏µ Error ‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡∏ö‡∏≠‡∏Å‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
        Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'Path Error: ' + e.message, 'error');
    }
}


// --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏à‡∏ó‡∏¢‡πå (‡πÅ‡∏Å‡πâ Error: renderQuestions) ---
function renderQuestions() {
    const list = document.getElementById('questions-list');
    if (!list) return;

    if (currentQuestions.length === 0) {
        list.innerHTML = `
            <div style="text-align: center; padding: 50px; background: #f8fafc; border: 3px dashed #e2e8f0; border-radius: 30px;">
                <p style="color: #94a3b8; font-size: 18px; font-weight: bold;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
            </div>`;
        return;
    }

    list.innerHTML = currentQuestions.map((q, idx) => `
        <div style="background: white; padding: 25px; border-radius: 25px; border: 1px solid #e2e8f0; margin-bottom: 20px; position: relative;">
            <div style="position: absolute; left: -10px; top: 20px; color: white; width: 35px; height: 35px; background: #4f46e5; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                ${idx + 1}
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 15px; margin-left: 20px;">
                <input type="text" value="${q.title || ''}" onchange="updateQ(${idx}, 'title', this.value)" 
                    placeholder="‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°..."
                    style="width: 100%; padding: 12px; border: none; background: #f1f5f9; border-radius: 12px; font-weight: bold;">

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    ${[0, 1, 2, 3].map(optIdx => `
                        <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: #f8fafc; border-radius: 12px;">
                            <input type="radio" name="correct-${idx}" ${q.correct == optIdx ? 'checked' : ''} 
                                onchange="updateQ(${idx}, 'correct', ${optIdx});">
                            <input type="text" value="${q.options ? q.options[optIdx] : ''}" 
                                onchange="updateOpt(${idx}, ${optIdx}, this.value)"
                                style="flex: 1; border: none; background: transparent;">
                        </div>
                    `).join('')}
                </div>
                <div style="text-align: right;">
                    <button onclick="deleteQ(${idx})" style="color: #ef4444; font-size: 12px; border: none; background: none; cursor: pointer;">‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ üóëÔ∏è</button>
                </div>
            </div>
        </div>
    `).join('');
}

// --- 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ä‡∏∏‡∏î) ---
function updateQ(idx, field, val) { currentQuestions[idx][field] = val; }
function updateOpt(qIdx, optIdx, val) { 
    if(!currentQuestions[qIdx].options) currentQuestions[qIdx].options = ["","","",""];
    currentQuestions[qIdx].options[optIdx] = val; 
}
function deleteQ(idx) {
    currentQuestions.splice(idx, 1);
    renderQuestions();
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° EXAM
async function loadStudentExam() {
    const targetGrade = "‡∏õ.6/1"; 
    const subName = currentSub; // ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å selectSubject ‡πÅ‡∏•‡πâ‡∏ß

    // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠ Path ‡∏Å‡πà‡∏≠‡∏ô
    const safeGrade = targetGrade.replace(/[\.\/]/g, '_');
    const safeSub = subName.replace(/[\.\/]/g, '_');

    Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...', didOpen: () => Swal.showLoading() });

    try {
        // 2. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ (‡∏ó‡∏±‡πâ‡∏á status ‡πÅ‡∏•‡∏∞ questions)
        const snap = await db.ref(`exam_data/${safeGrade}/${safeSub}`).once('value');
        const examData = snap.val();

        if (!examData) {
            return Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö', 'info');
        }

        // 3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î (‡∏ß‡∏≤‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‚úÖ)
        if (examData.status === 'closed') {
            return Swal.fire({
                title: '‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà',
                text: '‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö',
                icon: 'warning',
                confirmButtonColor: '#f43f5e'
            });
        }

        // 4. ‡∏ñ‡πâ‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏Ñ‡πà‡∏≠‡∏¢‡∏™‡∏±‡πà‡∏á‡∏ß‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö
        window.currentExamQuestions = examData.questions;
        Swal.close();
        renderStudentExamUI(subName, examData.questions);

    } catch (e) {
        console.error(e);
        Swal.fire('Error', '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏•‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
function renderStudentExamUI(subName, questions) {
    // 1. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö id="page-exam-page" 
    // ‡∏ñ‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö showPage ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏£‡∏π‡πÄ‡∏ï‡∏¥‡∏° 'page-' ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà‡πÅ‡∏Ñ‡πà 'exam-page'
    // ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏°‡∏±‡∏ô Error ‡∏≠‡∏µ‡∏Å ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏° 'page-exam-page' ‡∏Ñ‡∏£‡∏±‡∏ö
    try {
        showPage('exam-page'); 
    } catch(e) {
        // ‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÅ‡∏ö‡∏ö‡πÅ‡∏£‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°
        showPage('page-exam-page');
    }

    // 2. ‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤
    const titleEl = document.getElementById('student-exam-title');
    if (titleEl) titleEl.innerText = `‡∏ß‡∏¥‡∏ä‡∏≤: ${subName}`;
    
    // 3. ‡∏ß‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏•‡∏á‡πÉ‡∏ô container ‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏π‡∏°‡∏µ (id="student-questions-container")
    const container = document.getElementById('student-questions-container');
    if (container) {
        window.currentExamQuestions = questions; // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
        
        container.innerHTML = questions.map((q, idx) => `
            <div class="bg-slate-50 p-8 rounded-[2.5rem] border border-slate-100 shadow-sm mb-6">
                <h4 class="text-xl font-black text-slate-800 mb-6">${idx + 1}. ${q.title}</h4>
                <div class="grid gap-3">
                    ${q.options.map((opt, i) => `
                        <label class="flex items-center gap-4 p-5 bg-white rounded-2xl cursor-pointer hover:bg-emerald-50 border-2 border-transparent has-[:checked]:border-emerald-500 transition-all shadow-sm">
                            <input type="radio" name="q${idx}" value="${i}" class="w-5 h-5 accent-emerald-500">
                            <span class="font-bold text-slate-700">${opt}</span>
                        </label>
                    `).join('')}
                </div>
            </div>
        `).join('');
    }
    
    // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠ 1
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

async function submitExam() {
    const std = window.currentStudent;
    if (!std) return Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Login ‡πÉ‡∏´‡∏°‡πà', 'error');

    const questions = window.currentExamQuestions;
    let score = 0;
    questions.forEach((q, idx) => {
        const selected = document.querySelector(`input[name="q${idx}"]:checked`);
        if (selected && parseInt(selected.value) === parseInt(q.correct)) score++;
    });

    try {
        Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

        const safeGrade = std.grade.replace(/[\.\/]/g, '_');
        const safeSub = currentSub.replace(/[\.\/]/g, '_');

        // üö© ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å std.no ‡πÄ‡∏õ‡πá‡∏ô std.id ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Error 'undefined'
        await db.ref(`exam_results/${safeGrade}/${safeSub}/${std.id}`).set({
            studentId: std.id,
            name: std.name,
            nickname: std.nickname || std.name.split(' ')[0], 
            score: score,
            total: questions.length,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });

        await Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', `‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ${score}/${questions.length}`, 'success');
        showPage('std-subject-menu');

    } catch (e) {
        Swal.fire('Error', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e.message, 'error');
    }
}

let isExamOpen = true;

async function toggleExamStatus() {
    const safeGrade = document.getElementById('select-grade').value.replace(/[\.\/]/g, '_');
    const safeSub = currentSub.replace(/[\.\/]/g, '_');
    const btn = document.getElementById('btn-toggle-exam');

    isExamOpen = !isExamOpen;

    try {
        await db.ref(`exam_data/${safeGrade}/${safeSub}/status`).set(isExamOpen ? 'active' : 'closed');
        
        if (isExamOpen) {
            btn.innerText = "üü¢ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏≠‡∏ö";
            btn.className = "bg-emerald-500 text-white px-6 py-3 rounded-2xl font-bold transition-all";
        } else {
            btn.innerText = "üî¥ ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö";
            btn.className = "bg-rose-500 text-white px-6 py-3 rounded-2xl font-bold transition-all";
        }
        Swal.fire('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', `‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô ${isExamOpen ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î'} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`, 'success');
    } catch (e) {
        Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ', 'error');
    }
}

async function viewScores() {
    // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Select ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏£‡∏π
    const gradeRaw = document.getElementById('select-grade').value;
    const subRaw = document.getElementById('select-subject').value;

    if (!gradeRaw || !subRaw) {
        return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô', 'warning');
    }

    const safeGrade = gradeRaw.replace(/[\.\/]/g, '_');
    const safeSub = subRaw.replace(/[\.\/]/g, '_');

    Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô...', didOpen: () => Swal.showLoading() });

    try {
        // ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á Path ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        const snap = await db.ref(`exam_results/${safeGrade}/${safeSub}`).once('value');
        const scores = snap.val();

        if (!scores) {
            return Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÉ‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ', 'info');
        }

        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π‡∏°‡∏µ ---
        console.log("‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏ö:", scores);
        renderScoreTable(scores); // ‡πÅ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î
        
    } catch (e) {
        Swal.fire('Error', '‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + e.message, 'error');
    }
}

function renderScoreTable(scores) {
    const scoreList = Object.values(scores);
    
    let tableHTML = `
        <div class="mt-4 overflow-hidden rounded-2xl border border-slate-100 text-left">
            <table class="w-full border-collapse">
                <thead class="bg-slate-50">
                    <tr>
                        <th class="p-4 text-xs font-black text-slate-400 uppercase">‡∏£‡∏´‡∏±‡∏™</th>
                        <th class="p-4 text-xs font-black text-slate-400 uppercase">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</th>
                        <th class="p-4 text-xs font-black text-slate-400 uppercase text-center">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-50">
                    ${scoreList.map(item => `
                        <tr class="hover:bg-slate-50/50 transition-colors text-sm">
                            <td class="p-4 text-slate-500 font-bold">${item.studentId}</td>
                            <td class="p-4 text-slate-800 font-black">${item.nickname}</td>
                            <td class="p-4 text-center">
                                <span class="bg-emerald-50 text-emerald-600 px-3 py-1 rounded-lg font-black">
                                    ${item.score} / ${item.total}
                                </span>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;

    Swal.fire({
        title: `<span class="text-2xl font-black text-slate-800">üìä ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö</span>`,
        html: tableHTML,
        width: '550px',
        showDenyButton: true, // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏á
        confirmButtonText: '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö',
        denyButtonText: 'üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', // ‡∏õ‡∏∏‡πà‡∏°‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        confirmButtonColor: '#10b981',
        denyButtonColor: '#f43f5e',
        customClass: {
            popup: 'rounded-[2.5rem]',
            confirmButton: 'rounded-2xl px-6 py-3 font-bold',
            denyButton: 'rounded-2xl px-6 py-3 font-bold'
        }
    }).then((result) => {
        if (result.isDenied) {
            confirmClearScores(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö
        }
    });
}

async function confirmClearScores() {
    const gradeRaw = document.getElementById('select-grade').value;
    const subRaw = document.getElementById('select-subject').value;

    if (!gradeRaw || !subRaw) return;

    const safeGrade = gradeRaw.replace(/[\.\/]/g, '_');
    const safeSub = subRaw.replace(/[\.\/]/g, '_');

    const { isConfirmed } = await Swal.fire({
        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?',
        text: "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#f43f5e',
        cancelButtonColor: '#64748b',
        confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î!',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
    });

    if (isConfirmed) {
        try {
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', didOpen: () => Swal.showLoading() });
            
            // ‡∏™‡∏±‡πà‡∏á‡∏•‡∏ö Path ‡∏Ç‡∏≠‡∏á‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡πÜ ‡πÉ‡∏ô exam_results
            await db.ref(`exam_results/${safeGrade}/${safeSub}`).remove();
            
            await Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
        } catch (e) {
            Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + e.message, 'error');
        }
    }
}

    </script>




</body>

<div id="REPORT_POPUP" style="display:none; position:fixed; inset:0; z-index:9999; background:rgba(15, 23, 42, 0.7); backdrop-filter:blur(4px); align-items:center; justify-content:center; padding:20px;">
    <div style="background:white; width:100%; max-width:900px; max-height:85vh; border-radius:24px; display:flex; flex-direction:column; overflow:hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);">
        
        <div style="padding:20px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0; font-size:1.5rem; font-weight:bold; color:#1e293b;">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö Do Now</h2>
            <button onclick="document.getElementById('REPORT_POPUP').style.display='none'" style="cursor:pointer; border:none; background:#f1f5f9; width:40px; height:40px; border-radius:50%; font-size:20px; color:#64748b;">‚úï</button>
        </div>

        <div style="padding:15px; background:#f8fafc; display:flex; gap:10px; flex-wrap:wrap; border-bottom:1px solid #e2e8f0;">
            <select id="f-grade" onchange="updateSubFilter(this.value, 'f-subject')" style="padding:10px; border-radius:12px; border:1px solid #cbd5e1; min-width:150px;">
                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á --</option>
            </select>
            <select id="f-subject" style="padding:10px; border-radius:12px; border:1px solid #cbd5e1; min-width:150px;">
                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤ --</option>
            </select>
            <input type="date" id="f-date" style="padding:10px; border-radius:12px; border:1px solid #cbd5e1;">
            <button onclick="fetchDoNowAnswers()" style="padding:10px 25px; background:#4f46e5; color:white; border:none; border-radius:12px; font-weight:bold; cursor:pointer;">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
        </div>

        <div style="flex:1; overflow-y:auto; padding:20px;">
            <table style="width:100%; border-collapse:collapse; text-align:left;">
                <thead style="position:sticky; top:0; background:white; z-index:10;">
                    <tr style="border-bottom:2px solid #f1f5f9; color:#64748b;">
                        <th style="padding:15px;">‡∏£‡∏´‡∏±‡∏™</th> <th style="padding:15px;">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                        <th style="padding:15px;">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</th> <th style="padding:15px;">‡∏ä‡∏±‡πâ‡∏ô</th>
                        <th style="padding:15px;">‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</th>
                        <th style="padding:15px;">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πà‡∏á</th>
                    </tr>
                </thead>
                <tbody id="answer-list-report">
                    <tr><td colspan="4" style="text-align:center; padding:40px; color:#94a3b8;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á/‡∏ß‡∏¥‡∏ä‡∏≤ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

</html>

