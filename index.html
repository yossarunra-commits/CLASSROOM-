<!doctype html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom OS V84 - Score Reset & Stats Fixed</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Kanit', sans-serif; background: #f1f5f9; }
        .page { display: none; }
        .page.active { display: block; animation: zoomIn 0.2s ease-out; }
        @keyframes zoomIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        .glass { background: white; border-radius: 2.5rem; box-shadow: 0 15px 35px -5px rgba(0,0,0,0.05); }
        .btn-big { transition: all 0.2s; }
        .btn-big:active { transform: scale(0.92); }
        .stat-card { background: linear-gradient(135deg, #6366f1 0%, #4338ca 100%); }
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body class="text-slate-800">

    <nav class="p-5 bg-white border-b flex justify-between items-center sticky top-0 z-50 no-print">
        <h1 class="font-black text-2xl italic tracking-tighter">CLASS <span class="text-indigo-600">OS V84</span></h1>
        <div class="flex gap-4">
            <button onclick="showPage('student-portal')" class="text-3xl">üè†</button>
            <button onclick="authAdmin()" class="bg-indigo-600 text-white px-6 py-2 rounded-2xl font-black text-sm uppercase shadow-lg shadow-indigo-100">Teacher</button>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto p-4 md:p-8 no-print">

        <section id="page-student-portal" class="page active">
            <div id="std-login-area" class="max-w-md mx-auto mt-12 glass p-10 text-center border-b-[16px] border-indigo-600">
                <div class="text-7xl mb-6">üîë</div>
                <h2 class="text-4xl font-black mb-8">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
                <input type="text" id="std-login-id" class="w-full p-6 bg-slate-50 border-2 rounded-[2rem] mb-6 text-center text-4xl font-black focus:border-indigo-600 outline-none" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">
                <button onclick="handleStudentLogin()" class="w-full py-6 bg-indigo-600 text-white rounded-[2rem] font-black text-2xl shadow-xl btn-big">GO!</button>
            </div>

            <div id="std-dashboard" class="hidden space-y-8">
                <div class="glass p-8 flex items-center gap-8 border-l-[20px] border-indigo-500">
                    <img id="std-img" src="" class="w-32 h-32 rounded-[3rem] object-cover border-4 border-white shadow-2xl">
                    <div>
                        <h2 class="text-5xl font-black" id="std-name-txt"></h2>
                        <div id="std-grade-txt" class="mt-2 inline-block px-5 py-2 bg-indigo-100 text-indigo-700 rounded-full font-bold text-xl italic"></div>
                    </div>
                </div>
                <div id="std-subject-list" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
            </div>
        </section>

        <section id="page-std-subject-menu" class="page">
            <button onclick="showPage('student-portal')" class="mb-8 text-slate-400 font-black text-xl">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
            <h2 id="std-menu-sub-title" class="text-5xl font-black mb-12 italic text-center text-slate-800"></h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <button onclick="showStdDoNow()" class="glass p-12 bg-amber-400 text-white font-black text-4xl btn-big shadow-xl shadow-amber-100 flex flex-col items-center gap-4">
                    <span>‚ö°</span> DO NOW
                </button>
                <button onclick="showStdScores()" class="glass p-12 bg-indigo-600 text-white font-black text-4xl btn-big shadow-xl shadow-indigo-100 flex flex-col items-center gap-4">
                    <span>üèÜ</span> SCORES
                </button>
                <button onclick="showStdPending()" class="glass p-12 bg-rose-500 text-white font-black text-4xl btn-big shadow-xl shadow-rose-100 flex flex-col items-center gap-4">
                    <span>üìã</span> PENDING
                </button>
            </div>
        </section>

        <section id="page-std-content-view" class="page">
            <button onclick="showPage('std-subject-menu')" class="mb-6 text-slate-400 font-black text-xl">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
            <div class="glass p-10 border-t-[20px]" id="content-border">
                <h2 id="content-title" class="text-4xl font-black mb-10 italic"></h2>
                <div id="content-area" class="space-y-6"></div>
            </div>
        </section>

        <section id="page-admin-menu" class="page">
            <h2 class="text-3xl font-black mb-8 italic">MANAGEMENT MENU</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                <button onclick="showPage('admin-donow')" class="glass p-8 text-center bg-amber-400 text-white font-black text-xl btn-big">‚ö°<br>Do Now</button>
                <button onclick="showPage('admin-teach')" class="glass p-8 text-center bg-indigo-600 text-white font-black text-xl btn-big">üìç<br>Check-in</button>
                <button onclick="showPage('admin-score')" class="glass p-8 text-center bg-emerald-500 text-white font-black text-xl btn-big">üìä<br>Score Sync</button>
                <button onclick="showPage('admin-tracking')" class="glass p-8 text-center bg-rose-500 text-white font-black text-xl btn-big">üìã<br>‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á</button>
                <button onclick="showPage('admin-stats')" class="glass p-8 text-center bg-sky-500 text-white font-black text-xl btn-big">üìà<br>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                <button onclick="showPage('admin-qr-print-tool')" class="glass p-8 text-center bg-slate-100 font-black text-xl btn-big">üñ®Ô∏è<br>‡∏û‡∏¥‡∏°‡∏û‡πå QR</button>
                <button onclick="showPage('admin-master')" class="glass p-8 text-center bg-slate-900 text-white font-black text-xl col-span-2 btn-big italic">üíæ MASTER DATA</button>
            </div>
        </section>

        <section id="page-admin-score" class="page">
            <button onclick="showPage('admin-menu')" class="mb-6 text-slate-400 font-bold">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
            <div class="glass p-8 mb-8 border-l-[15px] border-emerald-500">
                <h2 class="text-2xl font-black mb-6 text-emerald-600 italic">üìä Score Import (Reset & Overwrite)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <select id="sc-grade" onchange="updateSubFilter(this.value, 'sc-sub')" class="p-4 border-2 rounded-2xl font-bold bg-slate-50"></select>
                    <select id="sc-sub" class="p-4 border-2 rounded-2xl font-bold bg-slate-50"></select>
                </div>
                <input type="text" id="sc-tasks" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡πÉ‡∏ö‡∏á‡∏≤‡∏ô1, ‡πÉ‡∏ö‡∏á‡∏≤‡∏ô2, ‡∏™‡∏≠‡∏ö‡∏¢‡πà‡∏≠‡∏¢)" class="w-full p-4 border-2 rounded-2xl font-bold mb-6">
                <div class="flex gap-4">
                    <button onclick="downloadScoreTpl()" class="flex-1 py-4 bg-slate-800 text-white rounded-2xl font-bold btn-big">Template</button>
                    <button onclick="document.getElementById('sc-upload-in').click()" class="flex-1 py-4 bg-emerald-600 text-white rounded-2xl font-bold btn-big italic underline">UPLOAD & RESET OLD DATA</button>
                    <input type="file" id="sc-upload-in" class="hidden" onchange="uploadScoreData(event)">
                </div>
            </div>
            <div id="approval-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </section>

        <section id="page-admin-stats" class="page">
            <button onclick="showPage('admin-menu')" class="mb-6 text-slate-400 font-bold">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
            <div class="glass p-10">
                <h2 class="text-4xl font-black mb-8 italic">üìà Attendance Statistics</h2>
                <div class="mb-8">
                    <label class="font-bold text-slate-400">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥:</label>
                    <select id="st-grade" onchange="loadAttendanceStats()" class="w-full p-4 border-2 rounded-2xl font-black text-2xl mt-2"></select>
                </div>
                <div id="stats-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>
        </section>

        <section id="page-admin-tracking" class="page">
            <button onclick="showPage('admin-menu')" class="mb-6 text-slate-400 font-bold">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
            <div class="glass p-8">
                <h2 class="text-3xl font-black mb-6 italic">üìã ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πÅ‡∏Å‡∏ô‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏´‡πâ‡∏≠‡∏á</h2>
                <div class="flex gap-4 mb-8">
                    <select id="tr-grade" onchange="updateSubFilter(this.value, 'tr-sub')" class="p-4 border-2 rounded-2xl font-bold flex-1"></select>
                    <select id="tr-sub" class="p-4 border-2 rounded-2xl font-bold flex-1"></select>
                    <button onclick="loadTrackingReport()" class="px-10 bg-rose-500 text-white rounded-2xl font-black btn-big">‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏≤‡∏Ñ‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse rounded-xl overflow-hidden shadow-sm">
                        <thead class="bg-slate-900 text-white text-[10px] uppercase italic">
                            <tr id="tr-head"></tr>
                        </thead>
                        <tbody id="tr-body" class="bg-white text-xs font-bold"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="page-admin-donow" class="page"><button onclick="showPage('admin-menu')" class="mb-4 text-slate-400 font-bold">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button><div class="glass p-10 max-w-lg mx-auto border-t-[15px] border-amber-400"><h2 class="text-3xl font-black mb-6">‚ö° SET DO NOW</h2><select id="dn-grade" onchange="updateSubFilter(this.value, 'dn-sub')" class="w-full p-4 border-2 rounded-2xl mb-4 font-bold"></select><select id="dn-sub" class="w-full p-4 border-2 rounded-2xl mb-4 font-bold"></select><textarea id="dn-msg" class="w-full p-6 border-2 rounded-2xl mb-6 font-bold" rows="3" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..."></textarea><div class="flex gap-4"><button onclick="saveDoNow(true)" class="flex-1 py-4 bg-emerald-500 text-white rounded-2xl font-black btn-big">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button><button onclick="saveDoNow(false)" class="flex-1 py-4 bg-rose-500 text-white rounded-2xl font-black btn-big">‡∏õ‡∏¥‡∏î</button></div></div></section>
        <section id="page-admin-teach" class="page"><button onclick="showPage('admin-menu')" class="mb-4 text-slate-400 font-bold">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button><div class="grid grid-cols-1 lg:grid-cols-3 gap-8"><div class="glass p-8"><h3 class="font-black text-xl mb-6 underline">CHECK-IN SESSION</h3><select id="t-grade" onchange="updateSubFilter(this.value, 't-sub')" class="w-full p-4 border-2 rounded-2xl mb-4 font-bold"></select><select id="t-sub" class="w-full p-4 border-2 rounded-2xl mb-6 font-bold"></select><button onclick="createSession()" class="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black text-xl btn-big">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</button><div id="ses-history" class="mt-8 space-y-3"></div></div><div class="lg:col-span-2 glass p-10 text-center"><div id="ses-label" class="mb-6 p-5 bg-indigo-50 text-indigo-700 rounded-2xl font-black text-xl italic uppercase">Teacher Scan Area</div><div id="reader" class="mx-auto rounded-[3rem] overflow-hidden shadow-inner max-w-md border-8 border-white"></div><div class="flex gap-4 mt-8 max-w-md mx-auto"><button id="btn-on" onclick="toggleScanner(true)" class="flex-1 py-6 bg-black text-white rounded-3xl font-black text-xl btn-big">‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button><button id="btn-off" onclick="toggleScanner(false)" class="flex-1 py-6 bg-slate-200 text-slate-400 rounded-3xl font-black text-xl btn-big" disabled>‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button></div></div></div></section>
        <section id="page-admin-qr-print-tool" class="page"><button onclick="showPage('admin-menu')" class="mb-6 text-slate-400 font-bold">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button><div class="glass p-12 text-center"><h2 class="text-4xl font-black mb-8 italic">üñ®Ô∏è QR Card Generator</h2><div class="flex gap-4 mb-10"><select id="qr-grade-sel" class="flex-1 p-5 border-2 rounded-3xl font-black text-xl"></select><button onclick="previewQR()" class="px-12 bg-indigo-600 text-white rounded-3xl font-black text-xl btn-big">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ï‡∏£</button></div><div id="qr-preview-box" class="hidden"><button onclick="window.print()" class="mb-8 px-12 py-4 bg-emerald-500 text-white rounded-3xl font-black btn-big text-xl">PRINT A4</button><div id="preview-grid" class="grid grid-cols-4 gap-4 p-8 border-2 rounded-[3rem] bg-white"></div></div></div></section>
        <section id="page-admin-master" class="page"><button onclick="showPage('admin-menu')" class="mb-6 text-slate-400 font-bold">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button><div class="grid grid-cols-1 md:grid-cols-2 gap-8"><div class="glass p-10 border-l-[20px] border-indigo-600"><h3 class="font-black text-2xl mb-8 italic underline">IMPORT STUDENTS</h3><input type="file" onchange="loadExcel(event)" class="w-full p-8 border-4 border-dashed rounded-[3rem] mb-8 bg-slate-50"><div id="map-ui" class="hidden space-y-4 p-8 bg-indigo-50 rounded-[2rem]"><div class="grid grid-cols-2 gap-4 text-xs font-black"><div>ID: <select id="m-id" class="w-full border p-2 rounded-xl"></select></div><div>Name: <select id="m-name" class="w-full border p-2 rounded-xl"></select></div><div>Surname: <select id="m-surname" class="w-full border p-2 rounded-xl"></select></div><div>Nick: <select id="m-nick" class="w-full border p-2 rounded-xl"></select></div><div>Room: <select id="m-grade" class="w-full border p-2 rounded-xl"></select></div></div><button onclick="saveMasterData()" class="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black text-xl shadow-lg btn-big">SAVE MASTER DATA</button></div></div><div class="glass p-10 border-l-[20px] border-slate-900 bg-slate-900 text-white"><h3 class="font-black text-2xl mb-8 italic underline">PHOTO CLOUD</h3><input type="file" id="photo-input" multiple accept="image/*" onchange="handlePhotoUpload(event)" class="hidden"><button onclick="document.getElementById('photo-input').click()" class="w-full py-24 border-4 border-dashed border-slate-700 rounded-[3rem] text-2xl font-black btn-big opacity-50 hover:opacity-100 flex flex-col items-center gap-4"><span>üì∏</span> CLICK TO UPLOAD PHOTOS<br><small class="text-xs font-normal opacity-50">FILE NAME MUST BE STUDENT_ID.JPG</small></button></div></div></section>

    </main>

    <div id="print-layout" class="hidden print:block"><div id="qr-print-grid" class="grid grid-cols-4 gap-4 p-5"></div></div>

    <script>
        // --- FIREBASE SETTINGS ---
        const firebaseConfig = { 
            apiKey: "AIzaSyAJhpfPS7TCe3N1n6oWpFsWVQ7ipocv4kg", 
            authDomain: "classroom-9813f.firebaseapp.com", 
            databaseURL: "https://classroom-9813f-default-rtdb.asia-southeast1.firebasedatabase.app", 
            projectId: "classroom-9813f" 
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let students = [], currentSid = null, currentSub = null, currentSes = null, html5Qr = null, rawXL = null;

        // --- DATA SYNC ---
        db.ref('students').on('value', snap => {
            students = snap.val() ? Object.values(snap.val()) : [];
            updateSelectMenus();
        });

        async function authAdmin() {
            const { value: p } = await Swal.fire({ title: 'Enter Password', input: 'password', confirmButtonColor: '#4f46e5' });
            if(p === "1234") showPage('admin-menu');
        }

        function showPage(p) { 
            document.querySelectorAll('.page').forEach(x => x.classList.remove('active')); 
            document.getElementById(`page-${p}`).classList.add('active'); 
        }

        // --- STUDENT LOGIN ---
        function handleStudentLogin() {
            const id = document.getElementById('std-login-id').value.trim();
            const std = students.find(s => s.id === id);
            if(!std) return Swal.fire({ icon: 'error', title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™!', text: '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á' });
            currentSid = id;
            document.getElementById('std-login-area').classList.add('hidden');
            document.getElementById('std-dashboard').classList.remove('hidden');
            document.getElementById('std-name-txt').innerText = `${std.name} (${std.nickname})`;
            document.getElementById('std-grade-txt').innerText = `‡∏´‡πâ‡∏≠‡∏á ${std.grade}`;
            document.getElementById('std-img').src = std.photo || `https://api.dicebear.com/7.x/initials/svg?seed=${id}`;
            const grid = document.getElementById('std-subject-list'); grid.innerHTML = "";
            Object.entries(std.subjects || {}).forEach(([n, v]) => {
                if(v && v !== "") {
                    const b = document.createElement('button');
                    b.className = "glass p-10 text-left border-l-[20px] border-indigo-600 font-black text-3xl btn-big shadow-xl hover:bg-indigo-50";
                    b.innerHTML = `<span class="text-[10px] text-slate-400 block mb-1 uppercase tracking-tighter">üìö ‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</span>${n}`;
                    b.onclick = () => { currentSub = n; showPage('std-subject-menu'); document.getElementById('std-menu-sub-title').innerText = n; };
                    grid.appendChild(b);
                }
            });
        }

        // --- SCORES & PENDING LOGIC (FIXED) ---
        async function showStdScores() {
            const snap = await db.ref(`scores/${currentSid}/${currentSub}`).once('value');
            const appSnap = await db.ref(`scoreApprovals/${currentSub}`).once('value');
            const scores = snap.val() || {};
            const approvals = appSnap.val() || {};
            const html = Object.entries(scores).map(([t, d]) => {
                const isExam = t.includes("‡∏Å‡∏•‡∏≤‡∏á") || t.includes("‡∏õ‡∏•‡∏≤‡∏¢");
                const canSee = !isExam || approvals[t];
                return `<div class="flex justify-between items-center p-8 bg-white border-2 rounded-[3rem] shadow-sm">
                    <span class="text-2xl font-bold text-slate-400">${t}</span>
                    <span class="text-6xl font-black ${canSee ? 'text-indigo-600' : 'text-slate-100'}">${canSee ? d.score : 'üîí'}</span>
                </div>`;
            }).join('') || '<p class="text-center font-bold text-slate-300 py-10">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</p>';
            renderContent("üèÜ ‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î", "#4f46e5", html);
        }

        async function showStdPending() {
            const allSnap = await db.ref('scores').once('value');
            const allData = allSnap.val() || {};
            let allTasks = new Set();
            // ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô
            Object.values(allData).forEach(u => { if(u[currentSub]) Object.keys(u[currentSub]).forEach(t => allTasks.add(t)); });
            
            const myScores = allData[currentSid]?.[currentSub] || {};
            const missing = Array.from(allTasks).filter(t => !myScores[t]);

            const html = missing.length > 0 ? missing.map(m => `
                <div class="p-8 bg-rose-50 border-2 border-rose-100 rounded-[2.5rem] flex justify-between items-center">
                    <span class="text-2xl font-black text-rose-600 italic">‚ùå ${m}</span>
                    <span class="px-4 py-1 bg-rose-200 text-rose-700 rounded-full text-xs">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</span>
                </div>`).join('') : `
                <div class="text-center py-20 bg-emerald-50 rounded-[3rem] border-2 border-emerald-100">
                    <div class="text-8xl mb-6">üéØ</div>
                    <div class="text-4xl font-black text-emerald-600 uppercase">Excellent!</div>
                    <p class="font-bold text-emerald-400 mt-2">‡∏Ñ‡∏∏‡∏ì‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß</p>
                </div>`;
            renderContent("üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á", "#f43f5e", html);
        }

        // --- SCORE RESET & IMPORT ---
        async function uploadScoreData(e) {
            const sub = document.getElementById('sc-sub').value;
            const gr = document.getElementById('sc-grade').value;
            if(!sub || !gr) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö!');

            const reader = new FileReader();
            reader.readAsBinaryString(e.target.files[0]);
            reader.onload = async (evt) => {
                const workbook = XLSX.read(evt.target.result, { type: 'binary' });
                const data = XLSX.utils.sheet_to_json(workbook.Sheets["Scores"]);

                // [LOGIC] ‡∏•‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Å‡πà‡∏≤‡πÉ‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡πá‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡πâ‡∏≠‡∏á
                const targetStds = students.filter(s => s.grade === gr);
                for(let s of targetStds) { await db.ref(`scores/${s.id}/${sub}`).remove(); }

                // [LOGIC] ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
                for(let row of data) {
                    const sid = row["‡∏£‡∏´‡∏±‡∏™"]?.toString();
                    if(!sid) continue;
                    const scMap = {};
                    Object.keys(row).filter(k => k !== "‡∏£‡∏´‡∏±‡∏™" && k !== "‡∏ä‡∏∑‡πà‡∏≠").forEach(k => {
                        scMap[k] = { score: row[k] || 0 };
                    });
                    await db.ref(`scores/${sid}/${sub}`).set(scMap);
                }
                Swal.fire({ icon: 'success', title: 'Overwrite Success!', text: `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤ ${sub} ‡∏ñ‡∏π‡∏Å‡∏£‡∏µ‡πÄ‡∏ã‡∏ï‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß`, confirmButtonColor: '#10b981' });
            };
        }

        // --- STATS LOGIC (FIXED) ---
        async function loadAttendanceStats() {
            const gr = document.getElementById('st-grade').value;
            if(!gr) return;
            const sesSnap = await db.ref('sessions').once('value'); 
            const attSnap = await db.ref('attendance').once('value');
            const totalInRoom = students.filter(s => s.grade === gr).length;
            const sessions = Object.values(sesSnap.val() || {}).filter(s => s.grade === gr).reverse();
            const attData = attSnap.val() || {};

            document.getElementById('stats-container').innerHTML = sessions.map(s => {
                const present = Object.keys(attData[s.id] || {}).length;
                const percent = ((present / totalInRoom) * 100).toFixed(0);
                return `
                <div class="stat-card p-8 rounded-[2.5rem] text-white shadow-xl shadow-indigo-100">
                    <div class="flex justify-between items-start mb-4">
                        <span class="font-black text-xl italic">${s.subject}</span>
                        <span class="text-[10px] opacity-70">${s.time}</span>
                    </div>
                    <div class="text-6xl font-black mb-2">${percent}%</div>
                    <div class="w-full bg-white/20 h-3 rounded-full overflow-hidden mb-2">
                        <div class="bg-white h-full" style="width: ${percent}%"></div>
                    </div>
                    <p class="text-sm font-bold opacity-80">‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${present} ‡∏à‡∏≤‡∏Å ${totalInRoom} ‡∏Ñ‡∏ô</p>
                </div>`;
            }).join('') || '<p class="text-center col-span-full py-10 font-bold text-slate-300">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ</p>';
        }

        // --- TRACKING LOGIC (FIXED) ---
        async function loadTrackingReport() {
            const sub = document.getElementById('tr-sub').value;
            const gr = document.getElementById('tr-grade').value;
            if(!sub || !gr) return;
            const scoreSnap = await db.ref('scores').once('value');
            const allScores = scoreSnap.val() || {};
            const roomStds = students.filter(s => s.grade === gr);
            
            let allTasks = new Set();
            roomStds.forEach(s => { if(allScores[s.id]?.[sub]) Object.keys(allScores[s.id][sub]).forEach(t => allTasks.add(t)); });
            const taskArr = Array.from(allTasks);

            const head = document.getElementById('tr-head');
            head.innerHTML = `<th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th><th>‡∏ä‡∏∑‡πà‡∏≠</th>` + taskArr.map(t => `<th class="px-2">${t}</th>`).join('');
            
            const body = document.getElementById('tr-body');
            body.innerHTML = roomStds.map((s, idx) => {
                const mySubScores = allScores[s.id]?.[sub] || {};
                return `<tr>
                    <td class="p-3 border">${idx+1}</td>
                    <td class="p-3 border">${s.name}</td>
                    ${taskArr.map(t => `<td class="p-3 border text-center ${mySubScores[t]?'text-emerald-500':'text-rose-500 bg-rose-50'}">${mySubScores[t]?'‚úì':'‡∏Ñ‡πâ‡∏≤‡∏á'}</td>`).join('')}
                </tr>`;
            }).join('');
        }

        // --- GENERAL UTILS ---
        function updateSubFilter(grade, targetId) {
            const sel = document.getElementById(targetId);
            const subs = new Set();
            students.filter(s => s.grade === grade).forEach(s => Object.entries(s.subjects || {}).forEach(([n, v]) => { if(v && v !== "") subs.add(n); }));
            sel.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤ --</option>` + Array.from(subs).map(s => `<option value="${s}">${s}</option>`).join('');
        }

        function updateSelectMenus() {
            const gs = [...new Set(students.map(s => s.grade))].sort();
            ['dn-grade', 't-grade', 'sc-grade', 'qr-grade-sel', 'tr-grade', 'st-grade'].forEach(id => {
                const el = document.getElementById(id); if(el) el.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á --</option>` + gs.map(g => `<option value="${g}">${g}</option>`).join('');
            });
        }

        function downloadScoreTpl() {
            const sub = document.getElementById('sc-sub').value, gr = document.getElementById('sc-grade').value;
            const tasks = document.getElementById('sc-tasks').value.split(',').map(t=>t.trim()).filter(t => t);
            if(!sub || !gr || tasks.length === 0) return Swal.fire('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö!');
            const data = students.filter(s => s.grade === gr).map(s => { let o = { "‡∏£‡∏´‡∏±‡∏™": s.id, "‡∏ä‡∏∑‡πà‡∏≠": s.name }; tasks.forEach(t => o[t] = ""); return o; });
            const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Scores"); XLSX.writeFile(wb, `Template_${sub}_${gr}.xlsx`);
        }

        function renderContent(title, color, html) {
            showPage('std-content-view');
            document.getElementById('content-title').innerText = title;
            document.getElementById('content-border').style.borderColor = color;
            document.getElementById('content-area').innerHTML = html;
        }

        async function showStdDoNow() {
            const snap = await db.ref('donow').once('value'); const d = snap.val() || {};
            const myGrade = students.find(s=>s.id===currentSid).grade;
            const active = d.active && d.subject === currentSub && d.grade === myGrade;
            renderContent("‚ö° DO NOW ACTIVITY", "#fbbf24", active ? `<div class="p-10 bg-amber-50 rounded-[3rem] border-4 border-amber-200 text-center"><p class="text-4xl font-black text-amber-700 leading-relaxed">${d.text}</p></div>` : '<p class="text-center text-slate-300 font-black text-2xl py-20 italic">No Activity</p>');
        }

        function createSession() {
            const id = Date.now(), gr = document.getElementById('t-grade').value, sub = document.getElementById('t-sub').value;
            if(!gr || !sub) return; db.ref(`sessions/${id}`).set({ id, grade: gr, subject: sub, time: new Date().toLocaleString('th-TH') });
            selectActiveSes(id);
        }

        function selectActiveSes(id) {
            db.ref(`sessions/${id}`).once('value', snap => {
                currentSes = snap.val();
                document.getElementById('ses-label').innerText = `üî¥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ${currentSes.subject} - ‡∏´‡πâ‡∏≠‡∏á ${currentSes.grade}`;
            });
        }

        function toggleScanner(on) {
            if(!currentSes) return Swal.fire('‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏≤‡∏ö‡∏Å‡πà‡∏≠‡∏ô!');
            if(on) {
                html5Qr = new Html5Qrcode("reader");
                document.getElementById('btn-on').disabled = true; document.getElementById('btn-off').disabled = false;
                html5Qr.start({ facingMode: "environment" }, { fps: 20, qrbox: 250 }, async (code) => {
                    const std = students.find(s => s.id === code.trim());
                    if(std && std.grade === currentSes.grade) {
                        await db.ref(`attendance/${currentSes.id}/${std.id}`).set({ name: std.name, time: new Date().toLocaleTimeString('th-TH') });
                        Swal.fire({ title: std.name, icon: 'success', timer: 600, showConfirmButton: false, position: 'top' });
                    }
                });
            } else { if(html5Qr) html5Qr.stop().then(() => { document.getElementById('btn-on').disabled=false; document.getElementById('btn-off').disabled=true; }); }
        }

        async function saveDoNow(v) { 
            await db.ref('donow').set({ active: v, grade: document.getElementById('dn-grade').value, subject: document.getElementById('dn-sub').value, text: document.getElementById('dn-msg').value }); 
            Swal.fire('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }

        // Master Data Logic
        function loadExcel(e) {
            const reader = new FileReader(); reader.readAsBinaryString(e.target.files[0]);
            reader.onload = (evt) => {
                const wb = XLSX.read(evt.target.result, { type: 'binary' });
                rawXL = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                const heads = Object.keys(rawXL[0]);
                document.getElementById('map-ui').classList.remove('hidden');
                ['m-id','m-name','m-surname','m-nick','m-grade'].forEach(id => { document.getElementById(id).innerHTML = heads.map(h => `<option value="${h}">${h}</option>`).join(''); });
            };
        }

        async function saveMasterData() {
            const cId = document.getElementById('m-id').value, cNm = document.getElementById('m-name').value;
            const cSn = document.getElementById('m-surname').value, cNi = document.getElementById('m-nick').value, cGr = document.getElementById('m-grade').value;
            const skip = [cId, cNm, cSn, cNi, cGr, "‡∏•‡∏≥‡∏î‡∏±‡∏ö", "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà"];
            const data = rawXL.map(row => {
                const sid = row[cId]?.toString().trim(); if(!sid) return null;
                const subs = {}; Object.keys(row).filter(k => !skip.includes(k)).forEach(k => subs[k] = row[k] || "");
                return { id: sid, name: `${row[cNm]} ${row[cSn]}`, nickname: row[cNi]||"", grade: row[cGr]?.toString(), subjects: subs, photo: "" };
            }).filter(d => d);
            await db.ref('students').set(data); Swal.fire('Import Success!');
        }

        async function handlePhotoUpload(e) {
            Swal.fire({ title: 'Processing Images...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });
            for(let f of Array.from(e.target.files)) {
                const sid = f.name.split('.')[0].trim();
                const idx = students.findIndex(s => s.id === sid);
                if(idx !== -1) students[idx].photo = await resizePhoto(f);
            }
            await db.ref('students').set(students); Swal.close(); Swal.fire('Photos Synced!');
        }

        function resizePhoto(f) {
            return new Promise(r => {
                const rd = new FileReader(); rd.readAsDataURL(f);
                rd.onload = (e) => {
                    const img = new Image(); img.src = e.target.result;
                    img.onload = () => {
                        const c = document.createElement('canvas'); c.width = 250;
                        c.height = (img.height*250)/img.width;
                        c.getContext('2d').drawImage(img,0,0,250,c.height);
                        r(c.toDataURL('image/jpeg', 0.8));
                    }
                }
            });
        }

        function previewQR() {
            const gr = document.getElementById('qr-grade-sel').value;
            const list = students.filter(s => s.grade === gr);
            const grid = document.getElementById('preview-grid'), pGrid = document.getElementById('qr-print-grid');
            grid.innerHTML = ""; pGrid.innerHTML = ""; document.getElementById('qr-preview-box').classList.remove('hidden');
            list.forEach(s => {
                const h = `<div class="p-4 border-2 rounded-[2rem] flex flex-col items-center bg-white"><div id="qrp-${s.id}"></div><div class="mt-2 font-black text-[10px] text-center">${s.id}<br>${s.name}</div></div>`;
                grid.innerHTML += h; pGrid.innerHTML += h;
            });
            setTimeout(() => { list.forEach(s => { new QRCode(document.getElementById(`qrp-${s.id}`), { text: s.id, width: 100, height: 100 }); }); }, 600);
        }

        db.ref('sessions').on('value', snap => {
            document.getElementById('ses-history').innerHTML = Object.entries(snap.val() || {}).reverse().map(([id, s]) => `
                <div class="p-4 bg-white border-2 rounded-2xl flex justify-between items-center shadow-sm">
                    <div onclick="selectActiveSes('${id}')" class="cursor-pointer font-black text-indigo-600">${s.subject} (${s.grade})</div>
                    <button onclick="db.ref('sessions/${id}').remove()" class="text-rose-500 font-bold">‡∏•‡∏ö</button>
                </div>`).join('');
        });
    </script>
</body>
</html>