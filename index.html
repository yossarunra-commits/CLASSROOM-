<!doctype html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom OS V91 - Complete Edition</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Kanit', sans-serif; background: #f1f5f9; color: #1e293b; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .glass { background: white; border-radius: 1.25rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        #reader { width: 100% !important; max-width: 380px; margin: 0 auto; border-radius: 1rem; overflow: hidden; border: 4px solid white; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .status-present { background: #dcfce7; color: #166534; }
        .status-late { background: #ffedd5; color: #9a3412; }
        .status-absent { background: #f1f5f9; color: #64748b; }
        @media print { .no-print { display: none; } .print-area { display: block !important; } }
        th, td { border: 1px solid #e2e8f0; padding: 12px; }
    </style>
</head>
<body>

    <nav class="bg-white/80 backdrop-blur-md sticky top-0 z-[100] border-b p-4 flex justify-between items-center no-print">
        <h1 class="text-xl font-bold tracking-tight text-slate-800">CLASSROOM <span class="text-indigo-600">OS V91</span></h1>
        <div class="flex gap-2">
            <button onclick="location.reload()" class="p-2 bg-slate-100 rounded-lg">üîÑ</button>
            <button onclick="authAdmin()" class="bg-slate-900 text-white px-5 py-2 rounded-xl text-xs font-semibold uppercase hover:bg-indigo-600 transition-all">Teacher Mode</button>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto p-4 md:p-6 no-print">

        <section id="page-home" class="page active">
            <div class="max-w-md mx-auto mt-16 glass p-10 text-center border-t-8 border-indigo-600">
                <div class="text-6xl mb-6">üéí</div>
                <h2 class="text-3xl font-bold mb-2 text-slate-800">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                <p class="text-slate-400 mb-8">‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                <input type="text" id="std-login-id" class="w-full p-5 bg-slate-50 border-2 rounded-2xl mb-4 text-center text-4xl font-bold focus:ring-4 focus:ring-indigo-100 outline-none border-slate-200 transition-all" placeholder="00000">
                <button onclick="handleStudentLogin()" class="w-full py-5 bg-indigo-600 text-white rounded-2xl text-xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-all">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </section>

        <section id="page-admin-menu" class="page">
            <h2 class="text-2xl font-bold mb-8 flex items-center gap-3"><span class="w-2 h-8 bg-indigo-600 rounded-full"></span> ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <button onclick="showPage('admin-teach')" class="glass p-8 bg-indigo-600 text-white text-lg font-bold hover:scale-105 transition-transform shadow-indigo-200 shadow-lg">üìç ‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</button>
                <button onclick="showPage('admin-monitor')" class="glass p-8 bg-emerald-600 text-white text-lg font-bold hover:scale-105 transition-transform shadow-emerald-200 shadow-lg">üñ•Ô∏è ‡∏à‡∏≠‡∏°‡∏≠‡∏ô‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå</button>
                <button onclick="showPage('admin-stats')" class="glass p-8 bg-sky-500 text-white text-lg font-bold hover:scale-105 transition-transform shadow-sky-200 shadow-lg">üìà ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                <button onclick="showPage('admin-tracking')" class="glass p-8 bg-rose-500 text-white text-lg font-bold hover:scale-105 transition-transform shadow-rose-200 shadow-lg">üìã ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô</button>
                <button onclick="showPage('admin-score')" class="glass p-8 bg-violet-600 text-white text-lg font-bold">üìä ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
                <button onclick="showPage('admin-qr-print-tool')" class="glass p-8 bg-white text-slate-700 text-lg font-bold border-2">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå QR Code</button>
                <button onclick="showPage('admin-donow')" class="glass p-8 bg-amber-400 text-white text-lg font-bold">‚ö° ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° Do Now</button>
                <button onclick="showPage('admin-master')" class="glass p-8 bg-slate-800 text-white text-lg font-bold italic">üíæ Master Data</button>
            </div>
        </section>

        <section id="page-admin-teach" class="page">
            <button onclick="showPage('admin-menu')" class="mb-4 font-bold text-slate-400">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π</button>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="glass p-6">
                    <h3 class="text-lg font-bold mb-4 text-indigo-600 underline">1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                    <div class="space-y-3">
                        <select id="t-grade" onchange="updateSubFilter(this.value, 't-sub')" class="w-full p-4 border rounded-xl"></select>
                        <select id="t-sub" class="w-full p-4 border rounded-xl"></select>
                        <input type="date" id="t-date" class="w-full p-4 border rounded-xl">
                        <div class="grid grid-cols-2 gap-2">
                            <input type="time" id="t-start" class="p-4 border rounded-xl" placeholder="‡πÄ‡∏£‡∏¥‡πà‡∏°">
                            <input type="time" id="t-end" class="p-4 border rounded-xl" placeholder="‡∏à‡∏ö">
                        </div>
                        <button onclick="createSession()" class="w-full py-4 bg-indigo-600 text-white rounded-xl font-bold text-lg">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö Global Sync</button>
                    </div>
                </div>
                <div class="lg:col-span-2 glass p-10 text-center">
                    <div id="ses-label" class="mb-6 text-xl font-bold text-slate-400 italic">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏•‡∏∞‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô...</div>
                    <div id="reader"></div>
                    <div class="flex gap-4 mt-8 max-w-sm mx-auto">
                        <button id="btn-on" onclick="toggleScanner(true)" class="flex-1 py-4 bg-slate-900 text-white rounded-2xl font-bold shadow-lg">‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
                        <button id="btn-off" onclick="toggleScanner(false)" class="flex-1 py-4 bg-slate-200 text-slate-500 rounded-2xl font-bold" disabled>‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="page-admin-monitor" class="page">
            <button onclick="showPage('admin-menu')" class="mb-4 font-bold text-slate-400">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π</button>
            <div class="glass p-6 mb-6 flex flex-wrap justify-between items-center border-l-[12px] border-emerald-500">
                <div>
                    <h2 id="mon-sub-title" class="text-3xl font-bold text-indigo-600">‡∏ß‡∏¥‡∏ä‡∏≤: -</h2>
                    <p id="mon-ses-info" class="text-slate-400 font-medium"></p>
                </div>
                <div class="flex gap-4">
                    <div class="bg-emerald-50 p-4 rounded-2xl text-center min-w-[100px]">
                        <div class="text-xs font-bold text-emerald-600 uppercase">‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
                        <div id="mon-count-present" class="text-3xl font-bold text-emerald-700">0</div>
                    </div>
                    <div class="bg-orange-50 p-4 rounded-2xl text-center min-w-[100px]">
                        <div class="text-xs font-bold text-orange-600 uppercase">‡∏°‡∏≤‡∏™‡∏≤‡∏¢</div>
                        <div id="mon-count-late" class="text-3xl font-bold text-orange-700">0</div>
                    </div>
                    <div class="bg-slate-100 p-4 rounded-2xl text-center min-w-[100px]">
                        <div class="text-xs font-bold text-slate-500 uppercase">‡∏Ç‡∏≤‡∏î</div>
                        <div id="mon-count-absent" class="text-3xl font-bold text-slate-600">0</div>
                    </div>
                </div>
            </div>
            <div id="monitor-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-4"></div>
        </section>

        <section id="page-admin-score" class="page">
            <button onclick="showPage('admin-menu')" class="mb-4 font-bold text-slate-400">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
            <div class="glass p-8">
                <h2 class="text-2xl font-bold mb-6">üìä ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (Excel Upload)</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <select id="sc-grade" onchange="updateSubFilter(this.value, 'sc-sub')" class="p-4 border rounded-2xl font-medium"></select>
                    <select id="sc-sub" class="p-4 border rounded-2xl font-medium"></select>
                    <input type="text" id="sc-tasks" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏≠‡∏ö‡∏¢‡πà‡∏≠‡∏¢1, ‡∏™‡∏≠‡∏ö‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ)" class="p-4 border rounded-2xl">
                </div>
                <div class="flex gap-4">
                    <button onclick="downloadScoreTpl()" class="flex-1 py-5 bg-slate-100 text-slate-600 rounded-2xl font-bold hover:bg-slate-200">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Template</button>
                    <button onclick="document.getElementById('sc-upload-in').click()" class="flex-1 py-5 bg-violet-600 text-white rounded-2xl font-bold hover:bg-violet-700 shadow-lg shadow-violet-200">üì§ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏≤‡∏Å Excel</button>
                    <input type="file" id="sc-upload-in" class="hidden" onchange="uploadScoreData(event)">
                </div>
            </div>
        </section>

        <section id="page-admin-stats" class="page">
            <button onclick="showPage('admin-menu')" class="mb-4 font-bold text-slate-400">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
            <div class="glass p-8 mb-6">
                <h2 class="text-2xl font-bold mb-6">üìà ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•/‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞)</h2>
                <div class="flex flex-wrap gap-4">
                    <select id="st-grade" onchange="updateSubFilter(this.value, 'st-sub')" class="p-4 border rounded-2xl flex-1"></select>
                    <select id="st-sub" class="p-4 border rounded-2xl flex-1"></select>
                    <button onclick="generateStatsReport()" class="px-10 py-4 bg-indigo-600 text-white rounded-2xl font-bold">‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•</button>
                    <button onclick="exportStatsCSV()" class="px-10 py-4 bg-emerald-600 text-white rounded-2xl font-bold">Export CSV</button>
                </div>
            </div>
            <div id="stats-area" class="hidden">
                <div id="stats-summary-cards" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"></div>
                <div class="glass overflow-hidden">
                    <table class="w-full text-sm">
                        <thead class="bg-slate-800 text-white">
                            <tr><th>‡∏ó‡∏µ‡πà</th><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th class="bg-emerald-600">‡∏°‡∏≤</th><th class="bg-orange-500">‡∏™‡∏≤‡∏¢</th><th class="bg-rose-600">‡∏Ç‡∏≤‡∏î</th><th>‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞</th></tr>
                        </thead>
                        <tbody id="stats-table-body" class="bg-white"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="page-admin-tracking" class="page">
            <button onclick="showPage('admin-menu')" class="mb-4 font-bold text-slate-400">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
            <div class="glass p-8">
                <h2 class="text-2xl font-bold mb-6 italic text-rose-600 underline">üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á (Real-time)</h2>
                <div class="flex gap-4 mb-6">
                    <select id="tr-grade" onchange="updateSubFilter(this.value, 'tr-sub')" class="p-4 border rounded-2xl flex-1"></select>
                    <select id="tr-sub" class="p-4 border rounded-2xl flex-1"></select>
                    <button onclick="loadTrackingReport()" class="px-12 bg-indigo-600 text-white rounded-2xl font-bold">‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </div>
                <div class="overflow-x-auto glass">
                    <table class="w-full text-xs">
                        <thead id="tr-head" class="bg-slate-900 text-white"></thead>
                        <tbody id="tr-body"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="page-admin-master" class="page">
            <button onclick="showPage('admin-menu')" class="mb-4 font-bold text-slate-400">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="glass p-8 border-t-8 border-slate-800">
                    <h3 class="text-xl font-bold mb-4">üíæ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                    <input type="file" onchange="loadExcel(event)" class="w-full p-6 border-2 border-dashed rounded-2xl mb-4 bg-slate-50">
                    <div id="map-ui" class="hidden bg-white p-6 border rounded-2xl space-y-4">
                        <p class="text-xs font-bold text-slate-400 uppercase">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>‡∏£‡∏´‡∏±‡∏™: <select id="m-id" class="w-full p-2 border rounded"></select></div>
                            <div>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•: <select id="m-name" class="w-full p-2 border rounded"></select></div>
                            <div>‡∏´‡πâ‡∏≠‡∏á: <select id="m-grade" class="w-full p-2 border rounded"></select></div>
                        </div>
                        <button onclick="saveMasterData()" class="w-full py-4 bg-indigo-600 text-white rounded-xl font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                    </div>
                </div>
                <div class="glass p-8 bg-slate-900 text-white text-center">
                    <h3 class="text-xl font-bold mb-4 text-indigo-400">üì∏ Sync ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                    <input type="file" id="photo-input" multiple accept="image/*" class="hidden" onchange="handlePhotoUpload(event)">
                    <div onclick="document.getElementById('photo-input').click()" class="cursor-pointer py-16 border-2 border-dashed border-slate-700 rounded-3xl hover:border-indigo-500 transition-all opacity-60 hover:opacity-100">
                        <div class="text-5xl mb-4">üñºÔ∏è</div>
                        <p class="font-bold text-lg">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</p>
                        <p class="text-xs text-slate-500 mt-2">‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô.jpg (‡πÄ‡∏ä‡πà‡∏ô 1001.jpg)</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="page-admin-qr-print-tool" class="page">
            <button onclick="showPage('admin-menu')" class="mb-4 font-bold text-slate-400">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
            <div class="glass p-10 text-center">
                <h2 class="text-3xl font-bold mb-8">üñ®Ô∏è ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå QR Code</h2>
                <div class="flex gap-4 justify-center mb-10">
                    <select id="qr-grade-sel" class="p-4 border rounded-2xl min-w-[250px] font-bold"></select>
                    <button onclick="previewQR()" class="px-10 bg-indigo-600 text-white rounded-2xl font-bold shadow-lg shadow-indigo-100">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡πÅ‡∏Å‡∏ô</button>
                </div>
                <div id="qr-preview-box" class="hidden">
                    <button onclick="window.print()" class="w-full py-6 bg-emerald-500 text-white rounded-3xl font-bold text-2xl mb-10 hover:bg-emerald-600 transition-all">üñ®Ô∏è ‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå (A4)</button>
                    <div id="preview-grid" class="grid grid-cols-4 md:grid-cols-6 gap-4 p-6 bg-white border-2 border-slate-100 rounded-3xl"></div>
                </div>
            </div>
        </section>

        <section id="page-admin-donow" class="page">
            <button onclick="showPage('admin-menu')" class="mb-4 font-bold text-slate-400">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
            <div class="max-w-xl mx-auto glass p-10 border-t-[12px] border-amber-400">
                <h2 class="text-3xl font-bold mb-2">‚ö° ‡∏£‡∏∞‡∏ö‡∏ö Do Now</h2>
                <p class="text-slate-400 mb-8 font-medium">‡∏™‡πà‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏î‡πà‡∏ß‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
                <div class="space-y-4">
                    <select id="dn-grade" onchange="updateSubFilter(this.value, 'dn-sub')" class="w-full p-4 border rounded-2xl"></select>
                    <select id="dn-sub" class="w-full p-4 border rounded-2xl"></select>
                    <textarea id="dn-msg" class="w-full p-6 border-2 rounded-3xl text-lg font-medium h-40" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÇ‡∏à‡∏ó‡∏¢‡πå ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
                    <div class="flex gap-4">
                        <button onclick="saveDoNow(true)" class="flex-1 py-5 bg-emerald-500 text-white rounded-2xl font-bold text-xl hover:bg-emerald-600 transition-all">‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</button>
                        <button onclick="saveDoNow(false)" class="flex-1 py-5 bg-rose-500 text-white rounded-2xl font-bold text-xl hover:bg-rose-600 transition-all">‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="page-std-dashboard" class="page">
            <button onclick="showPage('home')" class="mb-4 font-bold text-slate-400">‚Üê ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            <div class="glass p-8 flex items-center gap-8 mb-8 border-l-[15px] border-indigo-600">
                <img id="std-img" class="w-24 h-24 rounded-3xl object-cover border-4 border-white shadow-xl">
                <div><h2 id="std-name-txt" class="text-4xl font-bold text-slate-800"></h2><p id="std-grade-txt" class="text-indigo-600 text-xl font-bold"></p></div>
            </div>
            <div id="std-subject-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </section>

        <section id="page-std-subject-menu" class="page">
            <button onclick="showPage('std-dashboard')" class="mb-4 font-bold text-slate-400">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
            <h2 id="std-menu-sub-title" class="text-4xl font-bold mb-10 italic text-indigo-700"></h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <button onclick="showStdDoNow()" class="glass p-12 bg-amber-400 text-white text-2xl font-bold hover:scale-105 transition-transform shadow-xl shadow-amber-100">‚ö° DO NOW</button>
                <button onclick="showStdScores()" class="glass p-12 bg-indigo-600 text-white text-2xl font-bold hover:scale-105 transition-transform shadow-xl shadow-indigo-100">üèÜ SCORES</button>
                <button onclick="showStdPending()" class="glass p-12 bg-rose-500 text-white text-2xl font-bold hover:scale-105 transition-transform shadow-xl shadow-rose-100">üìã PENDING</button>
            </div>
        </section>

        <section id="page-std-content-view" class="page">
            <button onclick="showPage('std-subject-menu')" class="mb-4 font-bold text-slate-400">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
            <div id="content-border" class="glass p-12 border-t-[20px]">
                <h2 id="content-title" class="text-4xl font-bold mb-10 italic"></h2>
                <div id="content-area" class="space-y-6"></div>
            </div>
        </section>

    </main>

    <div id="print-layout" class="hidden print-area">
        <div id="qr-print-grid" class="grid grid-cols-4 gap-4 p-8"></div>
    </div>

    <script>
        // --- 1. FIREBASE & STATE ---
        const config = { apiKey: "AIzaSyAJhpfPS7TCe3N1n6oWpFsWVQ7ipocv4kg", authDomain: "classroom-9813f.firebaseapp.com", databaseURL: "https://classroom-9813f-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "classroom-9813f" };
        firebase.initializeApp(config);
        const db = firebase.database();
        let students = [], currentSid = null, currentSub = null, currentSes = null, html5Qr = null, rawXL = null;

        db.ref('students').on('value', snap => { students = snap.val() ? Object.values(snap.val()) : []; updateSelectMenus(); });

        function showPage(p) {
            document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
            document.getElementById(`page-${p}`).classList.add('active');
            if(p === 'admin-monitor') startGlobalMonitor();
        }

        async function authAdmin() {
            const { value: pw } = await Swal.fire({ title: 'Teacher Security', input: 'password', confirmButtonColor: '#4f46e5' });
            if (pw === "1234") showPage('admin-menu');
        }

        // --- 2. MASTER DATA & PHOTOS ---
        function loadExcel(e) {
            const r = new FileReader(); r.readAsBinaryString(e.target.files[0]);
            r.onload = (evt) => {
                const wb = XLSX.read(evt.target.result, { type: 'binary' });
                rawXL = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                const heads = Object.keys(rawXL[0]);
                document.getElementById('map-ui').classList.remove('hidden');
                ['m-id','m-name','m-grade'].forEach(id => {
                    document.getElementById(id).innerHTML = heads.map(h => `<option value="${h}">${h}</option>`).join('');
                });
            };
        }

        async function saveMasterData() {
            const cI = document.getElementById('m-id').value, cN = document.getElementById('m-name').value, cG = document.getElementById('m-grade').value;
            const data = rawXL.map(row => {
                const id = row[cI]?.toString().trim(); if(!id) return null;
                const subs = {}; Object.keys(row).filter(k => ![cI,cN,cG,"‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà","‡∏•‡∏≥‡∏î‡∏±‡∏ö"].includes(k)).forEach(k => subs[k] = row[k] || "");
                return { id, name: row[cN], grade: row[cG]?.toString(), subjects: subs, photo: "" };
            }).filter(d => d);
            await db.ref('students').set(data); Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß', 'success');
        }

        async function handlePhotoUpload(e) {
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û...', didOpen: () => Swal.showLoading() });
            for(let f of Array.from(e.target.files)) {
                const sid = f.name.split('.')[0].trim();
                const idx = students.findIndex(s => s.id === sid);
                if(idx !== -1) students[idx].photo = await resizeImg(f);
            }
            await db.ref('students').set(students); Swal.close(); Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }

        function resizeImg(f) {
            return new Promise(r => {
                const rd = new FileReader(); rd.readAsDataURL(f);
                rd.onload = (e) => {
                    const i = new Image(); i.src = e.target.result;
                    i.onload = () => {
                        const c = document.createElement('canvas'); c.width = 300; c.height = (i.height*300)/i.width;
                        c.getContext('2d').drawImage(i,0,0,300,c.height); r(c.toDataURL('image/jpeg', 0.8));
                    }
                }
            });
        }

        // --- 3. TEACH & SCANNER ---
        function createSession() {
            const gr = document.getElementById('t-grade').value, sub = document.getElementById('t-sub').value, dt = document.getElementById('t-date').value;
            if(!gr || !sub || !dt) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö');
            const id = Date.now();
            const data = { id, grade: gr, subject: sub, date: dt, start: document.getElementById('t-start').value, end: document.getElementById('t-end').value, fullDate: new Date(dt).toLocaleDateString('th-TH', { dateStyle: 'long' }) };
            db.ref(`sessions/${id}`).set(data); db.ref(`global/activeSessionID`).set(id);
            currentSes = data; document.getElementById('ses-label').innerHTML = `üî¥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô: <span class="text-indigo-600 font-black underline">${sub} [‡∏´‡πâ‡∏≠‡∏á ${gr}]</span>`;
        }

        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πÅ‡∏Å‡∏ô (Scanner Engine V92) ---
function toggleScanner(on) {
    if(!currentSes) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° [‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö Global Sync] ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πÅ‡∏Å‡∏ô', 'warning');
    
    if(on) {
        html5Qr = new Html5Qrcode("reader");
        document.getElementById('btn-on').disabled = true; 
        document.getElementById('btn-off').disabled = false;
        
        html5Qr.start({ facingMode: "environment" }, { fps: 20, qrbox: 250 }, async (code) => {
            const sid = code.trim(); 
            const std = students.find(s => s.id === sid);
            
            // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏´‡∏°
            if(!std) {
                return Swal.fire({
                    title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™!',
                    text: `‡∏£‡∏´‡∏±‡∏™ ${sid} ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏ß‡πâ‡πÉ‡∏ô Master Data`,
                    icon: 'error',
                    timer: 2000,
                    showConfirmButton: false
                });
            }

            // 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏≠‡∏ô‡πÑ‡∏´‡∏°
            if(std.grade !== currentSes.grade) {
                return Swal.fire({
                    title: '‡∏ú‡∏¥‡∏î‡∏´‡πâ‡∏≠‡∏á!',
                    text: `${std.name} ‡∏≠‡∏¢‡∏π‡πà‡∏´‡πâ‡∏≠‡∏á ${std.grade} (‡∏Ñ‡∏≤‡∏ö‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏´‡πâ‡∏≠‡∏á ${currentSes.grade})`,
                    icon: 'warning',
                    timer: 2000,
                    showConfirmButton: false
                });
            }

            // 3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡πÑ‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á (Check Duplicate)
            const checkSnap = await db.ref(`attendance/${currentSes.id}/${std.id}`).once('value');
            if(checkSnap.exists()) {
                return Swal.fire({
                    title: '‡πÄ‡∏ä‡πá‡∏Ñ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß!',
                    text: `${std.name} ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`,
                    icon: 'info',
                    timer: 1000,
                    showConfirmButton: false
                });
            }

            // 4. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏£‡∏∞‡∏ö‡∏ö
            const now = new Date(); 
            const timeStr = now.toLocaleTimeString('th-TH', { hour:'2-digit', minute:'2-digit' });
            const [sH, sM] = currentSes.start.split(':'); 
            const startTime = new Date(currentSes.date); 
            startTime.setHours(sH, sM, 0);
            
            const status = ((now - startTime) / 60000) > 15 ? "‡∏™‡∏≤‡∏¢" : "‡∏°‡∏≤";
            
            await db.ref(`attendance/${currentSes.id}/${std.id}`).set({ 
                name: std.name, 
                time: timeStr, 
                status: status 
            });

            // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            Swal.fire({
                title: `<span class="text-indigo-600">${std.name}</span>`,
                html: `<b class="text-2xl">${status}</b><br>‡πÄ‡∏ß‡∏•‡∏≤ ${timeStr}`,
                icon: 'success',
                timer: 800,
                showConfirmButton: false,
                position: 'top'
            });

        }).catch(err => {
            console.error(err);
            Swal.fire('‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á', '‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á', 'error');
        });
    } else { 
        if(html5Qr) {
            html5Qr.stop().then(() => { 
                document.getElementById('btn-on').disabled = false; 
                document.getElementById('btn-off').disabled = true; 
            });
        }
    }
}

        // --- 4. LIVE MONITOR ---
        function startGlobalMonitor() {
            db.ref(`global/activeSessionID`).on('value', snap => {
                const aid = snap.val(); if(!aid) return;
                db.ref(`sessions/${aid}`).once('value', sSnap => {
                    const ses = sSnap.val(); document.getElementById('mon-sub-title').innerText = "‡∏ß‡∏¥‡∏ä‡∏≤: " + ses.subject;
                    document.getElementById('mon-ses-info').innerText = `‡∏´‡πâ‡∏≠‡∏á ${ses.grade} | ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${ses.fullDate}`;
                    db.ref(`attendance/${aid}`).on('value', aSnap => {
                        const att = aSnap.val() || {}; const room = students.filter(s => s.grade === ses.grade).sort((a,b)=>a.id-b.id);
                        let p=0, l=0, a=0, html="";
                        room.forEach(s => {
                            const d = att[s.id]; let cls = "status-absent", t = "-";
                            if(d) { if(d.status==="‡∏™‡∏≤‡∏¢"){cls="status-late";l++;}else{cls="status-present";p++;} t=d.time; } else a++;
                            html += `<div class="p-3 text-center glass rounded-2xl ${cls}"><img src="${s.photo||`https://api.dicebear.com/7.x/initials/svg?seed=${s.id}`}" class="w-12 h-12 mx-auto rounded-xl object-cover mb-2 border-2 border-white shadow-sm"><div class="text-[10px] font-bold truncate">${s.name}</div><div class="text-[9px] opacity-60">${t}</div></div>`;
                        });
                        document.getElementById('monitor-grid').innerHTML = html;
                        document.getElementById('mon-count-present').innerText = p; document.getElementById('mon-count-late').innerText = l; document.getElementById('mon-count-absent').innerText = a;
                    });
                });
            });
        }

        // --- 5. SCORE & TRACKING ---
        function downloadScoreTpl() {
            const gr = document.getElementById('sc-grade').value, sub = document.getElementById('sc-sub').value, tks = document.getElementById('sc-tasks').value.split(',').map(t=>t.trim()).filter(t=>t);
            if(!gr || !sub) return Swal.fire('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡πà‡∏≠‡∏ô');
            const data = students.filter(s=>s.grade===gr).map(s => { let o = {"‡∏£‡∏´‡∏±‡∏™": s.id, "‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•": s.name}; tks.forEach(t=>o[t]=""); return o; });
            const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Scores");
            XLSX.writeFile(wb, `Score_${gr}_${sub}.xlsx`);
        }

        async function uploadScoreData(e) {
            const sub = document.getElementById('sc-sub').value; if(!sub) return Swal.fire('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡πà‡∏≠‡∏ô');
            const r = new FileReader(); r.readAsBinaryString(e.target.files[0]);
            r.onload = async (evt) => {
                const wb = XLSX.read(evt.target.result, { type: 'binary' });
                const data = XLSX.utils.sheet_to_json(wb.Sheets["Scores"]);
                for(let row of data) {
                    const sid = row["‡∏£‡∏´‡∏±‡∏™"]?.toString().trim(); if(!sid) continue;
                    const scMap = {}; Object.keys(row).filter(k => !["‡∏£‡∏´‡∏±‡∏™","‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•"].includes(k)).forEach(k => scMap[k] = { score: row[k]||0 });
                    await db.ref(`scores/${sid}/${sub}`).set(scMap);
                }
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡πâ‡∏ß', 'success');
            };
        }

        async function loadTrackingReport() {
            const sub = document.getElementById('tr-sub').value, gr = document.getElementById('tr-grade').value;
            const sSnap = await db.ref('scores').once('value'); const allS = sSnap.val() || {};
            const room = students.filter(s => s.grade === gr); let tsks = new Set();
            room.forEach(s => { if(allS[s.id]?.[sub]) Object.keys(allS[s.id][sub]).forEach(t => tsks.add(t)); });
            const tArr = Array.from(tsks);
            document.getElementById('tr-head').innerHTML = `<tr><th class="p-3">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th><th class="p-3 text-left">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>${tArr.map(t=>`<th>${t}</th>`).join('')}</tr>`;
            document.getElementById('tr-body').innerHTML = room.map((s, i) => `<tr><td class="text-center font-bold">${i+1}</td><td class="text-left font-medium">${s.name}</td>${tArr.map(t => `<td class="text-center font-bold text-lg">${allS[s.id]?.[sub]?.[t]?'<span class="text-emerald-500">‚úì</span>':'<span class="text-rose-400">‡∏Ñ‡πâ‡∏≤‡∏á</span>'}</td>`).join('')}</tr>`).join('');
        }

        // --- 6. ADVANCED STATS ---
        async function generateStatsReport() {
            const gr = document.getElementById('st-grade').value, sub = document.getElementById('st-sub').value;
            const sSnap = await db.ref('sessions').once('value'); const aSnap = await db.ref('attendance').once('value');
            const sess = Object.values(sSnap.val() || {}).filter(s => s.grade === gr && s.subject === sub);
            const att = aSnap.val() || {}; const room = students.filter(s => s.grade === gr).sort((a,b)=>a.id-b.id);
            let html = "", tP=0, tL=0, tA=0;
            room.forEach((s, idx) => {
                let p=0, l=0, a=0;
                sess.forEach(ses => { const r = att[ses.id]?.[s.id]; if(!r) a++; else if(r.status==="‡∏™‡∏≤‡∏¢") l++; else p++; });
                const per = sess.length > 0 ? (((p+l)/sess.length)*100).toFixed(0) : 0;
                tP+=p; tL+=l; tA+=a;
                html += `<tr><td>${idx+1}</td><td>${s.id}</td><td class="text-left font-medium">${s.name}</td><td class="status-present font-bold">${p}</td><td class="status-late font-bold">${l}</td><td class="status-absent font-bold">${a}</td><td class="font-bold ${per<80?'text-rose-600':'text-emerald-600'}">${per}%</td></tr>`;
            });
            document.getElementById('stats-table-body').innerHTML = html;
            document.getElementById('stats-area').classList.remove('hidden');
            document.getElementById('stats-summary-cards').innerHTML = `<div class="glass p-4 text-center border-l-8 border-emerald-500"><div>‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏∞‡∏™‡∏°</div><div class="text-3xl font-bold">${tP}</div></div><div class="glass p-4 text-center border-l-8 border-orange-500"><div>‡∏°‡∏≤‡∏™‡∏≤‡∏¢‡∏™‡∏∞‡∏™‡∏°</div><div class="text-3xl font-bold">${tL}</div></div><div class="glass p-4 text-center border-l-8 border-rose-500"><div>‡∏Ç‡∏≤‡∏î‡∏™‡∏∞‡∏™‡∏°</div><div class="text-3xl font-bold">${tA}</div></div>`;
        }

        function exportStatsCSV() {
            let csv = []; const rows = document.querySelectorAll("#page-admin-stats table tr");
            rows.forEach(r => { let row = []; r.querySelectorAll("th, td").forEach(c => row.push(`"${c.innerText}"`)); csv.push(row.join(",")); });
            const blob = new Blob(["\ufeff" + csv.join("\n")], { type: "text/csv;charset=utf-8;" });
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = "Stats.csv"; link.click();
        }

        // --- 7. QR PRINT TOOL ---
        function previewQR() {
            const gr = document.getElementById('qr-grade-sel').value; const list = students.filter(s => s.grade === gr).sort((a,b)=>a.id-b.id);
            const g = document.getElementById('preview-grid'), pg = document.getElementById('qr-print-grid');
            g.innerHTML = pg.innerHTML = ""; document.getElementById('qr-preview-box').classList.remove('hidden');
            list.forEach(s => {
                const h = `<div class="p-2 border rounded-xl flex flex-col items-center bg-white"><div id="qrp-${s.id}"></div><div class="text-[9px] mt-1 font-bold">${s.name}</div><div class="text-[8px] opacity-50">${s.id}</div></div>`;
                g.innerHTML += h; pg.innerHTML += h;
            });
            setTimeout(() => { list.forEach(s => { new QRCode(document.getElementById(`qrp-${s.id}`), { text: s.id, width: 80, height: 80 }); }); }, 500);
        }

        // --- 8. STUDENT LOGIC ---
        function handleStudentLogin() {
            const id = document.getElementById('std-login-id').value.trim(); const s = students.find(x => x.id === id);
            if(!s) return Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô');
            currentSid = id; showPage('std-dashboard');
            document.getElementById('std-name-txt').innerText = s.name; document.getElementById('std-grade-txt').innerText = `‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${s.grade}`;
            document.getElementById('std-img').src = s.photo || `https://api.dicebear.com/7.x/initials/svg?seed=${id}`;
            const g = document.getElementById('std-subject-list'); g.innerHTML = "";
            Object.entries(s.subjects || {}).forEach(([n, v]) => { if(v) {
                const b = document.createElement('button'); b.className = "glass p-6 text-left border-l-8 border-indigo-600 font-bold hover:bg-slate-50 transition-all";
                b.innerHTML = `<span class="text-[10px] block text-slate-400 uppercase">‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</span>${n}`;
                b.onclick = () => { currentSub = n; showPage('std-subject-menu'); document.getElementById('std-menu-sub-title').innerText = n; };
                g.appendChild(b);
            }});
        }

        async function showStdScores() { const s = await db.ref(`scores/${currentSid}/${currentSub}`).once('value'); const scs = s.val()||{}; const h = Object.entries(scs).map(([t,d])=>`<div class="flex justify-between p-5 bg-white border-2 rounded-2xl"><span class="font-bold">${t}</span><span class="font-black text-indigo-600 text-xl">${d.score}</span></div>`).join('') || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô'; renderContent("üèÜ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°", "#4f46e5", h); }
        async function showStdPending() { const sS = await db.ref('scores').once('value'); const allS = sS.val()||{}; let allT = new Set(); Object.values(allS).forEach(u => { if(u[currentSub]) Object.keys(u[currentSub]).forEach(t => allT.add(t)); }); const myS = allS[currentSid]?.[currentSub]||{}; const miss = Array.from(allT).filter(t => !myS[t]); const h = miss.map(m => `<div class="p-5 bg-rose-50 border-2 border-rose-100 rounded-2xl text-rose-600 font-bold text-lg">‚ùå ‡∏Ñ‡πâ‡∏≤‡∏á‡∏™‡πà‡∏á: ${m}</div>`).join('') || '<div class="text-emerald-500 font-black text-2xl text-center py-10">üéâ ‡∏Ñ‡∏∏‡∏ì‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß!</div>'; renderContent("üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á", "#f43f5e", h); }
        async function showStdDoNow() { const s = await db.ref('donow').once('value'); const d = s.val()||{}; const ok = d.active && d.subject === currentSub && students.find(x=>x.id===currentSid).grade === d.grade; renderContent("‚ö° ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° Do Now", "#fbbf24", ok ? `<div class="p-10 bg-amber-50 rounded-3xl border-4 border-dashed border-amber-300 text-center font-bold text-3xl text-amber-700">${d.text}</div>` : '<p class="text-center text-slate-300">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏î‡πà‡∏ß‡∏ô‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</p>'); }
        function renderContent(t, c, h) { showPage('std-content-view'); document.getElementById('content-title').innerText = t; document.getElementById('content-border').style.borderColor = c; document.getElementById('content-area').innerHTML = h; }
        async function saveDoNow(v) { await db.ref('donow').set({ active:v, grade:document.getElementById('dn-grade').value, subject:document.getElementById('dn-sub').value, text:document.getElementById('dn-msg').value }); Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); }

        // --- 9. HELPERS ---
        function updateSelectMenus() {
            const gs = [...new Set(students.map(s => s.grade))].sort();
            ['t-grade','sc-grade','st-grade','dn-grade','qr-grade-sel','tr-grade'].forEach(id => {
                const el = document.getElementById(id); if(el) el.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á --</option>` + gs.map(g => `<option value="${g}">${g}</option>`).join('');
            });
        }
        function updateSubFilter(g, t) {
            const sel = document.getElementById(t); const subs = new Set();
            students.filter(s => s.grade === g).forEach(s => Object.entries(s.subjects || {}).forEach(([n, v]) => { if(v) subs.add(n); }));
            sel.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤ --</option>` + Array.from(subs).map(s => `<option value="${s}">${s}</option>`).join('');
        }
    </script>
</body>
</html>